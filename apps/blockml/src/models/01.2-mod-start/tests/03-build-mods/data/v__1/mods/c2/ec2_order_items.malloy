import './parts/order_items.malloy';
import './parts/orders.malloy';
import './parts/users.malloy';
import './parts/user_order_facts.malloy';
import './parts/inventory_items.malloy';
import './parts/products.malloy';
import './parts/distribution_centers.malloy';

#(mprove) model
source: ec2_test is order_items extend {
  dimension: order_id_2 is order_id
}

#(mprove) model
source: ec2_order_items is order_items extend {
  join_one: orders on order_id = orders.order_id
  join_one: users on orders.user_id = users.user_id
  join_one: user_order_facts on users.user_id = user_order_facts.user_id
  join_one: inventory_items on inventory_item_id = inventory_items.inventory_item_id
  join_one: products on inventory_items.product_id = products.product_id
  join_one: distribution_centers on inventory_items.distribution_center_id = distribution_centers.distribution_center_id

  measure: total_profit is total_sale_price - inventory_items.total_actual_cost

  -- # bar_chart
  view: view_orders_count_by_users_state is {
    top: 10
    group_by: users.state
    aggregate: orders.orders_count
  }

  view: view_min_first_order_created_ts_by_users_state is {
    top: 10
    group_by: users.state
    aggregate: min_first_order_created_at_ts is min(user_order_facts.first_order_created_at_ts)
  }
}

run: ec2_order_items -> view_orders_count_by_users_state

query: query_orders_count_by_users_state is ec2_order_items -> view_orders_count_by_users_state + {
  top: 5
}

run: query_orders_count_by_users_state

run: ec2_order_items -> {
  group_by: users.state
  -- aggregate: orders.orders_count
  -- order_by: state desc
  -- limit: 10
}

run: ec2_order_items -> {
  group_by: users___state_name is users.state_name
  aggregate: 
    total_profit
  order_by:
    users___state_name asc
    -- total_profit desc
}

run: ec2_order_items -> {
  group_by: users___state_name is users.state_name
  aggregate: 
    total_sale_price
    inventory_items___total_actual_cost is inventory_items.total_actual_cost
} -> {
  select: 
    users___state_name
    total_profit is total_sale_price - inventory_items___total_actual_cost
    total_sale_price
    inventory_items___total_actual_cost
  order_by:
    users___state_name asc
    -- total_profit desc
}
