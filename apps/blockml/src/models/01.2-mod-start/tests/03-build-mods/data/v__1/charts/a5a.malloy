source: order_items_table is c2_postgres.table('ecommerce.order_items') extend {}

source: order_items is order_items_table extend {
  primary_key: order_item_id
  
  -- dimension: inventory_item_id
  -- dimension: order_id
  -- dimension: order_item_id
  -- dimension: sale_price

  measure: orders_items_count is count()
}

source: orders_table is c2_postgres.table('ecommerce.orders') extend {}

source: orders is orders_table extend {
  primary_key: order_id
  
  -- dimension: order_id
  -- dimension: status
  -- dimension: user_id
  -- dimension: created_at

  measure: orders_count is count()
}

##! experimental{sql_functions}
source: user_order_facts is orders_table -> {
  group_by: user_id
  aggregate: first_order_created_ts is min(sql_number(""" EXTRACT(EPOCH FROM (TIMESTAMP 'epoch' + ${created_at} * INTERVAL '1 second')) """))
  -- 
} extend {
  primary_key: user_id

  -- dimension: user_id
  -- dimension: first_order_created_ts
}

source: users_table is c2_postgres.table('ecommerce.users') extend {}

source: users is users_table extend {
  primary_key: user_id
  
  -- dimension: age
  -- dimension: city
  -- dimension: email
  -- dimension: first_name
  -- dimension: gender
  -- dimension: last_name
  -- dimension: state
  -- dimension: traffic_source
  -- dimension: user_id

  measure: users_count is count()
}

source: ec1_m2 is order_items extend {
  join_one: orders on order_id = orders.order_id
  join_one: users on orders.user_id = users.user_id
  join_one: user_order_facts on users.user_id = user_order_facts.user_id

  -- # bar_chart
  view: view_orders_count_by_users_state is {
    top: 10
    group_by: users.state
    aggregate: orders.orders_count
  }

  view: view_min_first_order_created_ts_by_users_state is {
    top: 10
    group_by: users.state
    aggregate: min_first_order_created_ts is min(user_order_facts.first_order_created_ts)
  }
}

query: query_orders_count_by_users_state2 is ec1_m2 -> view_orders_count_by_users_state + {
  top: 5
}

run: ec1_m2 -> view_orders_count_by_users_state

run: query_orders_count_by_users_state2

query: a50 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 110
}

query: a51 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 111
}

query: a52 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 112
}

query: a53 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 113
}

query: a54 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 114
}

query: a55 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 115
}

query: b50 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 210
}

query: b51 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 211
}

query: b52 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 212
}

query: b53 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 213
}

query: b54 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 214
}

query: b55 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 215
}

query: c50 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 310
}

query: c51 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 311
}

query: c52 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 312
}

query: c53 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 313
}

query: c54 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 314
}

query: c55 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 315
}

query: d50 is ec1_m2 -> {
  group_by: users.state
  aggregate: orders.orders_count
  limit: 410
}