import './table_sources/order_items.malloy';
import './table_sources/orders.malloy';
import './table_sources/user_order_facts.malloy';
import './table_sources/users.malloy';

source: ec1_m2 is order_items extend {
  join_one: orders on order_id = orders.order_id
  join_one: users on orders.user_id = users.user_id
  join_one: user_order_facts on users.user_id = user_order_facts.user_id

  -- # bar_chart
  view: view_orders_count_by_users_state is {
    top: 10
    group_by: users.state
    aggregate: orders.orders_count
  }

  view: view_min_first_order_created_ts_by_users_state is {
    top: 10
    group_by: users.state
    aggregate: min_first_order_created_ts is min(user_order_facts.first_order_created_ts)
  }
}

run: ec1_m2 -> view_orders_count_by_users_state

query: query_orders_count_by_users_state is ec1_m2 -> view_orders_count_by_users_state + {
  top: 5
}

run: query_orders_count_by_users_state