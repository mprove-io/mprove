source: c1_users_table is c1_postgres.table('ecommerce.users') extend {
  rename:
    _age is age
    _city is city
    _email is email
    _first_name is first_name
    _gender is gender
    _last_name is last_name
    _state is state
    _traffic_source is traffic_source
}

source: c1_users_tx is c1_users_table extend {
  primary_key: user_id
  
  rename: traffic_source is _traffic_source

  rename: email is _email
  rename: first_name is _first_name
  rename: last_name is _last_name

  rename: gender is _gender

  dimension: has_last_name is first_name is not null

  rename: age is _age
  dimension: age_group is 
    pick '1) Below 25' when age < 25
    pick '2) 25 to 34' when age >= 25 and age < 35
    pick '3) 35 to 44' when age >= 35 and age < 45
    pick '4) 45 to 54' when age >= 45 and age < 55
    pick '5) 55 to 64' when age >= 55 and age < 65
    pick '6) 65 or Above' when age > 65
    else NULL

  rename: city is _city

  rename: state is _state
  dimension: state_name is state ?
    pick 'Alabama' when 'AL'
    pick 'Alaska' when 'AK'
    pick 'Arizona' when 'AZ'
    pick 'Arkansas' when 'AR'
    pick 'California' when 'CA'
    pick 'Colorado' when 'CO'
    pick 'Connecticut' when 'CT'
    pick 'Delaware' when 'DE'
    pick 'District of Columbia' when 'DC'
    pick 'Florida' when 'FL'
    pick 'Georgia' when 'GA'
    pick 'Hawaii' when 'HI'
    pick 'Idaho' when 'ID'
    pick 'Illinois' when 'IL'
    pick 'Indiana' when 'IN'
    pick 'Iowa' when 'IA'
    pick 'Kansas' when 'KS'
    pick 'Kentucky' when 'KY'
    pick 'Louisiana' when 'LA'
    pick 'Maine' when 'ME'
    pick 'Maryland' when 'MD'
    pick 'Massachusetts' when 'MA'
    pick 'Michigan' when 'MI'
    pick 'Minnesota' when 'MN'
    pick 'Mississippi' when 'MS'
    pick 'Missouri' when 'MO'
    pick 'Montana' when 'MT'
    pick 'Nebraska' when 'NE'
    pick 'Nevada' when 'NV'
    pick 'New Hampshire' when 'NH'
    pick 'New Jersey' when 'NJ'
    pick 'New Mexico' when 'NM'
    pick 'New York' when 'NY'
    pick 'North Carolina' when 'NC'
    pick 'North Dakota' when 'ND'
    pick 'Ohio' when 'OH'
    pick 'Oklahoma' when 'OK'
    pick 'Oregon' when 'OR'
    pick 'Pennsylvania' when 'PA'
    pick 'Rhode Island' when 'RI'
    pick 'South Carolina' when 'SC'
    pick 'South Dakota' when 'SD'
    pick 'Tennessee' when 'TN'
    pick 'Texas' when 'TX'
    pick 'Utah' when 'UT'
    pick 'Vermont' when 'VT'
    pick 'Virginia' when 'VA'
    pick 'Washington' when 'WA'
    pick 'West Virginia' when 'WV'
    pick 'Wisconsin' when 'WI'
    pick 'Wyoming' when 'WY'

  measure: 
    users_count is count()
    male_count is users_count { where: gender = 'Male'}
    female_count is users_count { where: gender = 'Female'}
    total_age is age.sum()
}

run: c1_users_tx -> {
  group_by: 
    has_last_name
  limit: 5
}