<div class="bg-blue1 flex h-full cursor-default flex-col">
  <div class="flex h-2 flex-1 flex-row overflow-y-auto">
    <div class="mx-6 mb-6 mt-8 flex min-w-[2px] flex-grow flex-col">
      <div class="flex h-11 flex-row items-center justify-between">
        <div class="flex w-full flex-row items-center">
          <div class="flex w-1/4 flex-row items-center">
            <div
              data-cy="modelTitle"
              class="text-gray1 flex items-center self-center text-2xl font-semibold"
            >
              {{ pageTitle }}
            </div>

            <m-view-list-icon
              class="ml-10 cursor-pointer"
              [ngClass]="{
                'text-gray-500': lastUrl === pathChartsList,
                'text-gray-400': lastUrl !== pathChartsList
              }"
              (click)="toggleChartsList()"
            ></m-view-list-icon>

            <div
              [tp]="templateNewChart"
              [tpIsEnabled]="
                alias === restrictedUserAlias || isExplorer === false
              "
              class="ml-5"
            >
              <button
                type="button"
                data-cy="chartsAddChartButton"
                class="h-11 flex-shrink-0 select-none rounded border px-4 py-2 text-base font-medium focus:outline-none"
                [ngClass]="{
                  'border-gray-400 text-gray-500 hover:bg-white':
                    alias !== restrictedUserAlias && isExplorer === true,
                  'cursor-default border-gray-300 text-gray-400':
                    alias === restrictedUserAlias || isExplorer === false
                }"
                (click)="addChart()"
                [disabled]="
                  alias === restrictedUserAlias || isExplorer === false
                "
                >New Chart</button
              >
            </div>

            <ng-template #templateNewChart>
              <div *ngIf="alias === restrictedUserAlias"
                >User is restricted. Sign Up at https://mprove.io to get full
                access.</div
              >

              <div *ngIf="alias !== restrictedUserAlias && isExplorer === false"
                >Explorer role required</div
              >
            </ng-template>
          </div>

          <div
            class="flex h-11 flex-1 flex-row items-center"
            *ngIf="lastUrl !== pathCharts && mconfig?.select.length > 0"
          >
            <div class="mb-5 ml-6 mr-10 mt-5 flex h-11 flex-row items-center">
              <div
                class="ml-5 flex cursor-pointer flex-row items-center"
                (click)="toggleFormat()"
              >
                <div
                  class="text-gray1 flex h-9 select-none items-center text-base"
                  >Format</div
                >

                <ui-switch class="ml-5" [checked]="isFormat"></ui-switch>
              </div>

              <div class="text-gray1 ml-10 select-none text-base">Limit</div>

              <div
                [formGroup]="limitForm"
                class="ml-5 flex flex-col items-start"
              >
                <div class="h-6"></div>
                <input
                  autocomplete="off"
                  spellcheck="false"
                  data-cy="modelLimitInput"
                  class="form-input border-gray3 focus:border-blue3 h-[36px] w-32 rounded"
                  [ngClass]="{
                    'border-red-600':
                      limitForm.controls['limit'].invalid &&
                      limitForm.controls['limit'].touched
                  }"
                  formControlName="limit"
                  (blur)="limitBlur()"
                />
                <m-validation
                  [control]="limitForm.controls['limit']"
                ></m-validation>
              </div>

              <div class="text-gray1 ml-10 select-none text-base">Timezone</div>

              <div class="ml-5 flex w-[260px] flex-1">
                <form
                  class="w-full"
                  [formGroup]="timezoneForm"
                  tp="Timezone change is not allowed"
                  [tpIsEnabled]="
                    timezoneForm.controls['timezone'].disabled === true
                  "
                >
                  <ng-select
                    #modelTimezoneSelect
                    data-cy="modelTimezoneSelect"
                    class="w-full text-base"
                    [items]="timezones"
                    [clearable]="false"
                    [searchable]="true"
                    [searchFn]="timezoneSearchFn"
                    (change)="timezoneChange()"
                    (keyup.esc)="
                      $event.stopImmediatePropagation();
                      modelTimezoneSelect.blur()
                    "
                    (keyup.enter)="
                      $event.stopImmediatePropagation();
                      modelTimezoneSelect.blur()
                    "
                    appendTo="body"
                    bindLabel="label"
                    bindValue="value"
                    formControlName="timezone"
                  >
                    <ng-template ng-label-tmp let-item="item">
                      <div class="truncate">{{ item.label }}</div>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="truncate">{{ item.label }}</div>
                    </ng-template>
                  </ng-select>
                </form>
              </div>
            </div>

            <div
              *ngIf="!!mconfig && mconfig.warnSelect.length > 0"
              class="ml-5 flex h-8 w-8 flex-shrink-0 text-purple-500"
              tp="Warning: The selected fields [{{
                mconfig.warnSelect.join(', ')
              }}] may use unsafe aggregations and produce incorrect results"
              placement="left"
            >
              <m-exclamation-icon></m-exclamation-icon>
            </div>

            <div class="flex-grow"></div>

            <div class="text-gray1 mr-9 flex flex-row items-center text-base">
              <!-- <div *ngIf="isRunningDry === true">Calculating ... </div> -->
              <!-- <div *ngIf="isRunning === true">Running ... </div> -->
              <!-- <div *ngIf="isCanceling === true">Canceling ... </div> -->

              <div *ngIf="!!dryQueryEstimate"
                >Estimate - {{ dryDataSize }} - {{ dryTimeAgo$ | async }}
              </div>

              <m-query-status
                *ngIf="!dryQueryEstimate"
                [query]="query"
                [showDataRowsLength]="true"
                [showLastCompleteDuration]="true"
                [completedWord]="'Completed'"
              ></m-query-status>

              <div
                class="ml-5 flex cursor-pointer flex-row items-center"
                (click)="toggleAutoRun()"
              >
                <ui-switch [checked]="isAutoRun"></ui-switch>

                <div
                  class="text-gray1 ml-5 flex h-9 select-none items-center text-base"
                  >Auto Run</div
                >
              </div>

              <button
                type="button"
                *ngIf="query?.status === queryStatusEnum.Running"
                data-cy="modelCancelButton"
                class="ml-5 flex h-12 w-24 items-center justify-center rounded bg-red-600 py-2 text-base font-medium text-white focus:outline-none"
                [ngClass]="{
                  'cursor-default': isCancelButtonPressed === true
                }"
                (click)="cancel()"
                [disabled]="isCancelButtonPressed === true"
              >
                <div *ngIf="isCancelButtonPressed === false">Cancel</div>
                <div
                  *ngIf="isCancelButtonPressed === true"
                  class="relative flex h-9 w-9 flex-shrink-0"
                >
                  <ngx-spinner
                    [name]="modelCancelButtonSpinnerName"
                    color="rgba(255, 255, 255, 1)"
                    bdColor="rgba(0, 0, 0, 0)"
                    size="default"
                    type="ball-clip-rotate"
                    [fullScreen]="false"
                    [disableAnimation]="true"
                    [zIndex]="99998"
                  >
                  </ngx-spinner>
                </div>
              </button>

              <div
                *ngIf="query?.status !== queryStatusEnum.Running"
                tp="Select Model Fields"
                class="ml-5"
                [tpIsEnabled]="mconfig?.select.length === 0"
              >
                <button
                  type="button"
                  data-cy="modelRunButton"
                  class="flex h-12 w-24 items-center justify-center rounded text-base font-medium text-white focus:outline-none"
                  [ngClass]="{
                    'bg-blue3': mconfig?.select.length > 0,
                    'cursor-default':
                      mconfig?.select.length === 0 ||
                      isRunButtonPressed === true,
                    'bg-gray-400': mconfig?.select.length === 0
                  }"
                  (click)="run()"
                  [disabled]="
                    mconfig?.select.length === 0 || isRunButtonPressed === true
                  "
                >
                  <div *ngIf="isRunButtonPressed === false">Run</div>
                  <div
                    *ngIf="isRunButtonPressed === true"
                    class="relative flex h-9 w-9 flex-shrink-0"
                  >
                    <ngx-spinner
                      [name]="modelRunButtonSpinnerName"
                      color="rgba(255, 255, 255, 1)"
                      bdColor="rgba(0, 0, 0, 0)"
                      size="default"
                      type="ball-clip-rotate"
                      [fullScreen]="false"
                      [disableAnimation]="true"
                      [zIndex]="99998"
                    >
                    </ngx-spinner>
                  </div>
                </button>
              </div>

              <!-- <div class="relative ml-5">
              <m-query-options
                [showRunDryButton]="
                  query?.connectionType === connectionTypeEnum.BigQuery
                "
                (runDryEvent)="runDry()"
              ></m-query-options>
            </div> -->
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex w-full flex-grow flex-row">
        <div
          class="flex h-full w-1/4 flex-shrink-0 flex-col rounded bg-white shadow"
        >
          <div class="mt-6 flex h-11 flex-row items-center">
            <m-search-icon class="text-gray1 ml-6"></m-search-icon>

            <input
              spellcheck="false"
              autocomplete="off"
              data-cy="chartsSearchInput"
              class="form-input focus:border-blue3 ml-3 h-10 w-[225px] rounded border-gray-400 bg-white"
              placeholder="Search"
              [ngClass]="{
                'bg-purple-200': !!word
              }"
              [(ngModel)]="word"
              (ngModelChange)="searchWordChange()"
            />

            <div class="h-9 w-9">
              <m-delete-icon
                *ngIf="!!word"
                class="text-gray1 ml-3 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded focus:outline-none"
                [ngClass]="{
                  'cursor-pointer bg-purple-200 hover:bg-purple-300': !!word
                }"
                (click)="resetSearch()"
              ></m-delete-icon>
            </div>

            <div class="flex flex-grow"></div>

            <button
              *ngIf="filteredDraftsLength > 0"
              class="mr-10 flex flex-row items-center rounded border border-gray-400 px-4 py-2 text-gray-500 hover:bg-gray-100 focus:outline-none"
              (click)="deleteDrafts()"
            >
              <m-trash-icon></m-trash-icon>
              <div class="ml-3">Drafts</div>
            </button>
          </div>

          <div class="flex h-2 w-full flex-1 flex-col">
            <!-- <div class="mb-5 mt-5 flex h-2 flex-grow flex-col overflow-y-auto"
              >Charts list
            </div> -->
          </div>

          <div class="flex h-11 w-full flex-shrink-0 flex-row items-center">
            <div class="text-gray1 ml-6 select-none text-lg">Model</div>

            <div class="ml-5 flex w-2 flex-1">
              <form class="w-full" [formGroup]="modelForm">
                <ng-select
                  #chartsModelSelect
                  data-cy="chartsModelSelect"
                  class="model-select w-full text-base"
                  [items]="models"
                  [clearable]="false"
                  [searchable]="true"
                  (change)="modelChange()"
                  (keyup.esc)="
                    $event.stopImmediatePropagation(); chartsModelSelect.blur()
                  "
                  (keyup.enter)="
                    $event.stopImmediatePropagation(); chartsModelSelect.blur()
                  "
                  appendTo="body"
                  bindLabel="label"
                  bindValue="modelId"
                  formControlName="model"
                >
                  <ng-template ng-label-tmp let-item="item">
                    <div class="truncate">{{ item.label }}</div>
                  </ng-template>

                  <ng-template ng-option-tmp let-item="item">
                    <div class="truncate">{{ item.label }}</div>
                  </ng-template>
                </ng-select>
              </form>
            </div>

            <m-view-list-icon
              class="ml-5 cursor-pointer"
              [ngClass]="{
                'text-gray-500': lastUrl === pathModelsList,
                'text-gray-400': lastUrl !== pathModelsList
              }"
              (click)="toggleModelsList()"
            ></m-view-list-icon>

            <div
              [tp]="templateNewModel"
              [tpIsEnabled]="
                alias === restrictedUserAlias || isExplorer === false
              "
              class="ml-5 mr-9 flex-shrink-0"
            >
              <button
                type="button"
                data-cy="chartsAddChartButton"
                class="h-11 flex-shrink-0 select-none rounded border px-4 py-2 text-base font-medium focus:outline-none"
                [ngClass]="{
                  'border-gray-400 text-gray-500 hover:bg-white':
                    alias !== restrictedUserAlias && isExplorer === true,
                  'cursor-default border-gray-300 text-gray-400':
                    alias === restrictedUserAlias || isExplorer === false
                }"
                (click)="addModel()"
                [disabled]="
                  alias === restrictedUserAlias || isExplorer === false
                "
                >New
              </button>

              <ng-template #templateNewModel>
                <div *ngIf="alias === restrictedUserAlias"
                  >User is restricted. Sign Up at https://mprove.io to get full
                  access.</div
                >

                <div
                  *ngIf="alias !== restrictedUserAlias && isExplorer === false"
                  >Explorer role required</div
                >
              </ng-template>
            </div>
          </div>

          <div
            class="mt-5 flex flex-col"
            [ngClass]="{
              'flex-[2]': schemaIsExpanded
            }"
          >
            <div
              class="text-gray1 mb-2 ml-6 mr-10 flex h-11 select-none flex-row items-center"
            >
              <div class="flex flex-row items-center">
                <div class="flex flex-row items-center">
                  <div
                    class="text-gray1 flex cursor-pointer pr-5 text-lg font-semibold"
                  >
                    SCHEMA
                  </div>
                </div>

                <button
                  *ngIf="!!model?.modelId"
                  class="ml-2 w-[54px] cursor-pointer select-none items-center text-lg"
                  [ngClass]="{
                    'font-semibold': modelTreeLevels === modelTreeLevelsFlat
                  }"
                  (click)="setModelTreeLevels(modelTreeLevelsFlat)"
                >
                  Flat
                </button>

                <button
                  *ngIf="!!model?.modelId"
                  class="ml-2 w-[83px] cursor-pointer select-none py-3 text-lg"
                  [ngClass]="{
                    'font-semibold': modelTreeLevels === modelTreeLevelsNested
                  }"
                  (click)="setModelTreeLevels(modelTreeLevelsNested)"
                  >Nested</button
                >
              </div>
            </div>

            <m-model-tree
              *ngIf="schemaIsExpanded"
              class="flex flex-1"
              (expandFilters)="expandFiltersPanel()"
              (expandData)="expandDataPanel()"
            ></m-model-tree>
          </div>
        </div>

        <div
          class="ml-6 flex min-w-[2px] flex-grow flex-col"
          *ngIf="
            lastUrl !== pathChartsList &&
            lastUrl !== pathModelsList &&
            (lastUrl === pathCharts || mconfig?.select.length === 0)
          "
        >
          <div
            class="text-gray1 mb-[80px] flex h-full w-full select-none items-center justify-center text-xl"
          >
            Select Chart or Model Fields
          </div>
        </div>

        <div
          class="h-full w-full"
          *ngIf="lastUrl === pathChartsList || lastUrl === pathModelsList"
        >
          <router-outlet></router-outlet>
        </div>

        <div
          class="ml-6 flex min-w-[2px] flex-grow flex-col space-y-2"
          *ngIf="
            lastUrl !== pathCharts &&
            lastUrl !== pathChartsList &&
            lastUrl !== pathModelsList &&
            mconfig?.select.length > 0
          "
        >
          <div
            class="w-full rounded bg-white shadow"
            [ngClass]="{
              'flex-1': dataIsExpanded
            }"
          >
            <div class="flex h-full flex-col">
              <div class="mr-5 flex h-20 flex-shrink-0 flex-row items-center">
                <div class="flex flex-1 flex-row items-center">
                  <m-panel-title
                    class="mb-1"
                    [title]="'Data'"
                    [isExpanded]="dataIsExpanded"
                    (toggleEvent)="toggleDataPanel()"
                    [showToggle]="false"
                  ></m-panel-title>

                  <!-- <button
                      *ngIf="mconfig?.select.length > 0"
                      class="text-gray1 ml-2 w-[84px] select-none items-center py-3 text-lg focus:outline-none"
                      [ngClass]="{
                        'font-semibold':
                          resultsIsShow === true &&
                          rightIsShow === false &&
                          resultsIsShowTemp === false,
                        'cursor-default text-gray-400':
                          !dataIsExpanded || mconfig?.select.length === 0
                      }"
                      (click)="toggleResults()"
                      >Results</button
                    > -->

                  <!-- <button
                      *ngIf="mconfig?.select.length > 0"
                      class="text-gray1 ml-2 w-[70px] select-none items-center py-3 text-lg focus:outline-none"
                      [ngClass]="{
                        'font-semibold':
                          resultsIsShow === true && rightIsShow === true,
                        'cursor-default text-gray-400':
                          !dataIsExpanded || mconfig?.select.length === 0
                      }"
                      (click)="toggleSplit()"
                      >Split</button
                    > -->

                  <!-- <button
                      *ngIf="mconfig?.select.length > 0"
                      class="text-gray1 ml-2 select-none items-center py-3 text-lg focus:outline-none"
                      [ngClass]="{
                        'font-semibold':
                          rightIsShow === true && resultsIsShow === false,
                        'cursor-default text-gray-400':
                          !dataIsExpanded || mconfig?.select.length === 0,
                        'w-[56]': mconfig.isStoreModel === false,
                        'w-[100px]': mconfig.isStoreModel === true
                      }"
                      (click)="toggleRight()"
                    >
                      {{
                        mconfig.isStoreModel === false ? 'SQL' : 'Request'
                      }}</button
                    > -->
                </div>

                <div class="flex flex-1 flex-row items-center">
                  <m-panel-title
                    class="mb-1"
                    [title]="'Info'"
                    [isExpanded]="dataIsExpanded"
                    (toggleEvent)="toggleDataPanel()"
                    [showToggle]="false"
                  ></m-panel-title>

                  <form
                    [formGroup]="requestPartTypeForm"
                    *ngIf="
                      mconfig.isStoreModel === true &&
                      mconfig?.select.length > 0 &&
                      rightIsShow === true
                    "
                    class="ml-5"
                  >
                    <ng-select
                      #requestPartTypeSelect
                      data-cy="requestPartTypeSelect"
                      class="w-[250px] flex-shrink-0 text-base focus:outline-none"
                      [items]="requestPartTypeList"
                      [clearable]="false"
                      [searchable]="false"
                      (change)="requestPartTypeChange($event)"
                      (keyup.esc)="
                        $event.stopImmediatePropagation();
                        requestPartTypeSelect.blur()
                      "
                      (keyup.enter)="
                        $event.stopImmediatePropagation();
                        requestPartTypeSelect.blur()
                      "
                      appendTo="body"
                      bindLabel="label"
                      bindValue="value"
                      formControlName="requestPartType"
                    >
                      <ng-template ng-label-tmp let-item="item">
                        <div>{{ item.label }}</div>
                      </ng-template>

                      <ng-template ng-option-tmp let-item="item">
                        <div>{{ item.label }}</div>
                      </ng-template>
                    </ng-select>
                  </form>
                </div>
              </div>

              <div
                class="ml-6 mr-5 flex flex-col divide-y divide-gray-300"
                *ngIf="dataIsExpanded"
              >
                <div class="flex flex-row"></div>
                <div class="flex flex-row"></div>
              </div>

              <div
                class="mx-5 mb-5 mt-5 flex h-2 flex-grow"
                *ngIf="dataIsExpanded"
              >
                <div
                  *ngIf="mconfig?.select.length === 0"
                  class="text-gray1 flex h-full w-full select-none items-center justify-center text-xl"
                  >Select Model Fields</div
                >

                <div
                  *ngIf="mconfig?.select.length > 0"
                  class="flex h-full w-full flex-row items-start justify-center space-x-5"
                >
                  <div
                    *ngIf="resultsIsShow"
                    class="h-full w-2 flex-1 overflow-auto"
                  >
                    <m-main-table
                      [isEdit]="true"
                      [isFormat]="isFormat"
                      [mconfig]="mconfig"
                      [qData]="qData"
                      [mconfigFields]="mconfig.fields"
                    ></m-main-table>
                  </div>

                  <div *ngIf="rightIsShow" class="h-full w-2 flex-1">
                    <m-sql *ngIf="mconfig.isStoreModel === false"></m-sql>

                    <m-js-viewer
                      *ngIf="
                        mconfig.isStoreModel === true &&
                        [
                          requestPartTypeEnumReqTemplate,
                          requestPartTypeEnumReqFunction,
                          requestPartTypeEnumReqUrlPath
                        ].indexOf(
                          requestPartTypeForm.controls['requestPartType'].value
                        ) > -1
                      "
                      [jsContent]="jsContent"
                    ></m-js-viewer>

                    <m-json-viewer
                      *ngIf="
                        mconfig.isStoreModel === true &&
                        [
                          requestPartTypeEnumReqJsonParts,
                          requestPartTypeEnumReqBody
                        ].indexOf(
                          requestPartTypeForm.controls['requestPartType'].value
                        ) > -1
                      "
                      [jsonContent]="
                        requestPartTypeForm.controls['requestPartType']
                          .value === requestPartTypeEnumReqJsonParts
                          ? mconfig.storePart?.reqJsonParts
                          : requestPartTypeForm.controls['requestPartType']
                              .value === requestPartTypeEnumReqBody
                          ? mconfig.storePart?.reqBody
                          : undefined
                      "
                    ></m-json-viewer>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="w-full">
            <div class="flex flex-col">
              <div class="mr-5 flex flex-shrink-0 flex-grow flex-row">
                <!-- <div
                  class="text-gray1 ml-6 mt-4 flex h-full min-h-[76px] w-full flex-shrink-0 select-none pt-4 text-xl"
                  *ngIf="mconfig?.extendedFilters.length === 0"
                  >No parameters</div
                > -->

                <div
                  class="mt-4 flex min-h-[76px] flex-shrink-0 flex-grow flex-row"
                >
                  <div
                    (click)="toggleFiltersPanel()"
                    class="text-gray1 mt-1 flex h-11 select-none flex-row items-start space-x-2 px-5 py-3 text-xl font-semibold"
                    [ngClass]="{
                      'cursor-pointer': mconfig?.extendedFilters.length > 0,
                      'cursor-default': mconfig?.extendedFilters.length === 0
                    }"
                  >
                    <div class="flex flex-row items-center space-x-2">
                      <m-chevron-right-icon
                        *ngIf="
                          !filtersIsExpanded &&
                          mconfig?.extendedFilters.length > 0
                        "
                      ></m-chevron-right-icon>

                      <m-chevron-down-icon
                        *ngIf="
                          filtersIsExpanded &&
                          mconfig?.extendedFilters.length > 0
                        "
                      ></m-chevron-down-icon>

                      <div
                        class="h-6 w-6"
                        *ngIf="mconfig?.extendedFilters.length === 0"
                      ></div>

                      <div> Parameters </div>
                    </div>
                  </div>

                  <div
                    class="flex flex-row items-start"
                    *ngIf="
                      !filtersIsExpanded && mconfig?.extendedFilters.length > 0
                    "
                  >
                    <m-bricks
                      class="mb-5 ml-3 mr-5 mt-3 flex max-h-[150px] max-w-max flex-row items-start justify-start overflow-auto"
                      [extendedFilters]="mconfig.extendedFilters"
                      [isKeepBackgroundColor]="false"
                    ></m-bricks>
                  </div>

                  <div
                    class="ml-3 max-h-[260px] w-2 flex-1 overflow-auto"
                    *ngIf="filtersIsExpanded"
                  >
                    <m-model-filters
                      [modelContent]="model.content"
                    ></m-model-filters>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div
            class="w-full rounded bg-white shadow"
            [ngClass]="{
              'h-[44%]': chartIsExpanded
            }"
          >
            <div class="flex h-full flex-col">
              <div class="mr-5 flex h-20 flex-shrink-0 flex-row items-center">
                <m-panel-title
                  [title]="'Chart'"
                  [isExpanded]="chartIsExpanded"
                  (toggleEvent)="toggleChartPanel()"
                  [showToggle]="true"
                ></m-panel-title>

                <div
                  *ngIf="mconfig?.select.length > 0"
                  class="ml-10 flex flex-row items-center justify-start space-x-5"
                >
                  <m-chart-table-icon
                    class="h-6 w-6 cursor-pointer"
                    [ngClass]="{
                      'text-blue-500':
                        mconfig.chart?.type === chartTypeEnumTable,
                      'text-gray-500':
                        mconfig.chart?.type !== chartTypeEnumTable
                    }"
                    (click)="chartTypeChange(chartTypeEnumTable)"
                  ></m-chart-table-icon>

                  <m-chart-line-icon
                    class="h-6 w-6 cursor-pointer"
                    [ngClass]="{
                      'text-blue-500':
                        mconfig.chart?.type === chartTypeEnumLine,
                      'text-gray-500': mconfig.chart?.type !== chartTypeEnumLine
                    }"
                    (click)="chartTypeChange(chartTypeEnumLine)"
                  ></m-chart-line-icon>

                  <m-chart-bar-icon
                    class="h-6 w-6 cursor-pointer"
                    [ngClass]="{
                      'text-blue-500': mconfig.chart?.type === chartTypeEnumBar,
                      'text-gray-500': mconfig.chart?.type !== chartTypeEnumBar
                    }"
                    (click)="chartTypeChange(chartTypeEnumBar)"
                  ></m-chart-bar-icon>

                  <m-chart-scatter-icon
                    class="h-6 w-6 cursor-pointer"
                    [ngClass]="{
                      'text-blue-500':
                        mconfig.chart?.type === chartTypeEnumScatter,
                      'text-gray-500':
                        mconfig.chart?.type !== chartTypeEnumScatter
                    }"
                    (click)="chartTypeChange(chartTypeEnumScatter)"
                  ></m-chart-scatter-icon>

                  <m-chart-pie-icon
                    class="h-6 w-6 cursor-pointer"
                    [ngClass]="{
                      'text-blue-500': mconfig.chart?.type === chartTypeEnumPie,
                      'text-gray-500': mconfig.chart?.type !== chartTypeEnumPie
                    }"
                    (click)="chartTypeChange(chartTypeEnumPie)"
                  ></m-chart-pie-icon>
                </div>

                <form
                  [formGroup]="chartTypeForm"
                  *ngIf="mconfig?.select.length > 0"
                  class="ml-5"
                >
                  <ng-select
                    #chartTypeSelect
                    data-cy="chartTypeSelect"
                    class="chart-type-select w-[200px] text-base focus:outline-none"
                    [items]="chartTypesList"
                    [clearable]="false"
                    [searchable]="false"
                    (change)="chartTypeChange()"
                    (keyup.esc)="
                      $event.stopImmediatePropagation(); chartTypeSelect.blur()
                    "
                    (keyup.enter)="
                      $event.stopImmediatePropagation(); chartTypeSelect.blur()
                    "
                    appendTo="body"
                    bindLabel="label"
                    bindValue="value"
                    formControlName="chartType"
                  >
                    <ng-template ng-label-tmp let-item="item">
                      <div
                        class="ml-1 flex flex-row items-center justify-start space-x-2"
                      >
                        <img class="h-6 w-6" [src]="item.iconPath" />
                        <div> {{ item.label }} </div>
                      </div>
                    </ng-template>
                    <ng-template
                      ng-option-tmp
                      let-item="item"
                      let-index="index"
                      let-search="searchTerm"
                    >
                      <div
                        class="ml-1 flex flex-row items-center justify-start space-x-2"
                      >
                        <img class="h-6 w-6" [src]="item.iconPath" />
                        <div> {{ item.label }} </div>
                      </div>
                    </ng-template>
                  </ng-select>
                </form>

                <div
                  *ngIf="mconfig?.select.length > 0"
                  class="text-gray1 ml-10 select-none text-base"
                  >Title</div
                >

                <div
                  *ngIf="mconfig?.select.length > 0"
                  [formGroup]="chartTitleForm"
                  class="ml-5 flex w-full flex-col items-start"
                >
                  <div class="h-6"></div>
                  <input
                    autocomplete="off"
                    spellcheck="false"
                    data-cy="modelChartTitleInput"
                    class="form-input border-gray3 focus:border-blue3 h-[36px] w-full rounded"
                    [ngClass]="{
                      'border-red-600':
                        chartTitleForm.controls['chartTitle'].invalid &&
                        chartTitleForm.controls['chartTitle'].touched
                    }"
                    formControlName="chartTitle"
                    placeholder="Title"
                    (blur)="chartTitleBlur()"
                  />
                  <m-validation
                    [control]="chartTitleForm.controls['chartTitle']"
                  ></m-validation>
                </div>

                <div class="flex-1"></div>

                <ng-template #templateChartSaveAs>
                  <div
                    *ngIf="
                      isSelectValid === false ||
                      mconfig?.chart?.isValid === false ||
                      chartTitleForm?.valid === false
                    "
                    >Chart is not valid</div
                  >

                  <div
                    *ngIf="
                      isSelectValid === true &&
                      mconfig?.chart?.isValid === true &&
                      chartTitleForm?.valid === true &&
                      alias === restrictedUserAlias
                    "
                    >User is restricted. Sign Up at https://mprove.io to get
                    full access.</div
                  >
                </ng-template>

                <div
                  *ngIf="mconfig?.select.length > 0"
                  class="ml-[138px]"
                  [tp]="templateChartSaveAs"
                  [tpIsEnabled]="
                    isSelectValid === false ||
                    mconfig?.chart?.isValid === false ||
                    chartTitleForm?.valid === false ||
                    alias === restrictedUserAlias
                  "
                >
                  <button
                    type="button"
                    data-cy="modelSaveAsButton"
                    class="w-28 flex-shrink-0 rounded py-2 text-base font-medium focus:outline-none"
                    [ngClass]="{
                      'text-blue3 border-2 bg-white':
                        isSelectValid === true &&
                        mconfig.chart.isValid === true &&
                        chartTitleForm.valid === true &&
                        alias !== restrictedUserAlias,
                      'cursor-default bg-gray-400 text-white':
                        isSelectValid === false ||
                        mconfig.chart.isValid === false ||
                        chartTitleForm.valid === false ||
                        alias === restrictedUserAlias
                    }"
                    (click)="saveAs()"
                    [disabled]="
                      isSelectValid === false ||
                      mconfig.chart.isValid === false ||
                      chartTitleForm.valid === false ||
                      alias === restrictedUserAlias
                    "
                    >Save As</button
                  >
                </div>

                <button
                  *ngIf="mconfig?.select.length > 0"
                  data-cy="modelShowChartButton"
                  class="ml-5 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded hover:bg-blue-200 focus:outline-none"
                  (click)="showChart($event)"
                >
                  <m-full-screen-icon></m-full-screen-icon>
                </button>

                <div *ngIf="mconfig?.select.length > 0" class="relative ml-3">
                  <m-chart-options
                    [mconfig]="mconfig"
                    [isDisabled]="
                      isSelectValid === false ||
                      mconfig.chart.isValid === false ||
                      chartTitleForm.valid === false
                    "
                  ></m-chart-options>
                </div>
              </div>

              <div
                class="ml-6 mr-5 flex flex-col divide-y divide-gray-300"
                *ngIf="chartIsExpanded"
              >
                <div class="flex flex-row"></div>
                <div class="flex flex-row"></div>
              </div>

              <div
                class="mx-5 mb-5 mt-5 flex h-2 flex-grow"
                *ngIf="chartIsExpanded"
              >
                <div
                  *ngIf="mconfig?.select.length === 0"
                  class="text-gray1 flex h-full w-full select-none items-center justify-center text-xl"
                  >Select Model Fields</div
                >

                <div
                  *ngIf="mconfig?.select.length > 0"
                  class="flex h-full w-2 flex-1 flex-row items-start justify-center space-x-5"
                >
                  <div class="h-full w-full overflow-auto">
                    <div
                      class="h-full w-full"
                      [ngClass]="{
                        'max-w-max':
                          mconfig?.chart.type === chartTypeEnumTable &&
                          isSelectValid === true &&
                          mconfig?.chart.isValid === true &&
                          qData?.length > 0
                      }"
                    >
                      <m-chart-view
                        *ngIf="mconfig?.chart"
                        class="h-full w-full"
                        [mconfigFields]="mconfig.fields"
                        [qData]="qData"
                        [chart]="mconfig.chart"
                        [isStoreModel]="mconfig.isStoreModel"
                        [queryStatus]="query.status"
                        [chartInstanceId]="'model-chart'"
                      ></m-chart-view>
                    </div>
                  </div>

                  <div
                    class="h-full w-1/3 flex-shrink-0 overflow-auto border-l"
                    [ngClass]="{
                      'border-gray-300': mconfig.chart.isValid === true,
                      'border-red-600': mconfig.chart.isValid === false
                    }"
                  >
                    <m-chart-editor
                      [chart]="mconfig.chart"
                      [isReport]="false"
                      [mconfigFields]="mconfig.fields"
                      [queryId]="mconfig?.queryId"
                    ></m-chart-editor>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="routerEvents$ | async"></div>
<div *ngIf="nav$ | async"></div>
<div *ngIf="uiQuery$ | async"></div>
<div *ngIf="isExplorer$ | async"></div>
<div *ngIf="models$ | async"></div>
<div *ngIf="model$ | async"></div>
<div *ngIf="mq$ | async"></div>
<div *ngIf="struct$ | async"></div>
<div *ngIf="alias$ | async"></div>
