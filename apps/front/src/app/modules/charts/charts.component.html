<div class="bg-m1 flex h-full cursor-default flex-col">
  <div class="flex h-2 flex-1 flex-row overflow-y-hidden">
    <div class="mx-6 mb-6 mt-8 flex min-w-[2px] flex-grow flex-col">
      <div class="flex h-11 flex-row items-center justify-between">
        <div class="flex w-full flex-row items-center">
          <div class="flex w-1/4 flex-row items-center">
            <div
              data-cy="modelTitle"
              class="text-s1 flex select-none items-center self-center text-2xl font-semibold"
            >
              {{ pageTitle }}
            </div>

            <div
              class="ml-10 flex flex-shrink-0 cursor-pointer flex-row items-center"
              (click)="toggleFilterByModel()"
              tp="Filter Charts by selected Model"
            >
              <m-filter-icon
                [ngClass]="{
                  'text-s400': isFilterByModel === false,
                  'text-p500': isFilterByModel === true
                }"
              ></m-filter-icon>

              <div
                class="ml-3 w-[54px] select-none items-center text-lg"
                [ngClass]="{
                  'text-p500 font-semibold': isFilterByModel === true,
                  'text-s500': isFilterByModel === false
                }"
              >
                Model
              </div>
            </div>

            <div
              class="ml-7 flex flex-shrink-0 cursor-pointer flex-row items-center"
              (click)="navToChartsList()"
            >
              <m-view-list-icon
                [ngClass]="{
                  'text-m500': lastUrl === pathChartsList,
                  'text-s400': lastUrl !== pathChartsList
                }"
              ></m-view-list-icon>

              <div
                class="ml-3 w-[34px] select-none items-center text-lg"
                [ngClass]="{
                  'text-m500 font-semibold': lastUrl === pathChartsList,
                  'text-s500': lastUrl !== pathChartsList
                }"
              >
                List
              </div>
            </div>

            <div
              class="ml-7 flex flex-shrink-0 cursor-pointer flex-row items-center"
              (click)="navToModelsList()"
            >
              <m-alt-list-icon
                [ngClass]="{
                  'text-m500': lastUrl === pathModelsList,
                  'text-s400': lastUrl !== pathModelsList
                }"
              ></m-alt-list-icon>

              <div
                class="ml-3 w-[68px] select-none items-center text-lg"
                [ngClass]="{
                  'text-m500 font-semibold': lastUrl === pathModelsList,
                  'text-s500': lastUrl !== pathModelsList
                }"
              >
                Models
              </div>
            </div>

            <div class="flex flex-1"></div>

            <div
              [tp]="templateNewChart"
              [tpIsEnabled]="
                alias === restrictedUserAlias ||
                isExplorer === false ||
                !model?.modelId
              "
              class="ml-5 flex-shrink-0"
            >
              <button
                type="button"
                data-cy="chartsNewChartButton"
                class="text-m0 h-11 flex-shrink-0 select-none rounded px-5 py-2 text-base font-medium focus:outline-none"
                [ngClass]="{
                  'bg-m600':
                    alias !== restrictedUserAlias &&
                    isExplorer === true &&
                    !!model?.modelId,
                  'bg-s400 cursor-default':
                    alias === restrictedUserAlias ||
                    isExplorer === false ||
                    !model?.modelId
                }"
                (click)="newChart()"
                [disabled]="
                  alias === restrictedUserAlias || isExplorer === false
                "
                >New Chart</button
              >
            </div>

            <ng-template #templateNewChart>
              <div *ngIf="alias === restrictedUserAlias"
                >User is restricted. Sign Up at https://mprove.io to get full
                access.</div
              >

              <div *ngIf="alias !== restrictedUserAlias && isExplorer === false"
                >Explorer role required</div
              >

              <div
                *ngIf="
                  alias !== restrictedUserAlias &&
                  isExplorer === true &&
                  !model?.modelId
                "
                >Select Model</div
              >
            </ng-template>
          </div>

          <div
            class="flex h-11 flex-1 flex-row items-center"
            *ngIf="lastUrl !== pathCharts && mconfig?.select.length > 0"
          >
            <div
              *ngIf="!!mconfig && mconfig.warnSelect.length > 0"
              class="text-p500 ml-5 flex h-8 w-8 flex-shrink-0"
              tp="Warning: The selected fields [{{
                mconfig.warnSelect.join(', ')
              }}] may use unsafe aggregations and produce incorrect results"
              placement="left"
            >
              <m-exclamation-icon></m-exclamation-icon>
            </div>

            <div class="flex-grow"></div>

            <div class="text-s1 mr-9 flex flex-row items-center text-base">
              <!-- <div *ngIf="isRunningDry === true">Calculating ... </div> -->
              <!-- <div *ngIf="isRunning === true">Running ... </div> -->
              <!-- <div *ngIf="isCanceling === true">Canceling ... </div> -->

              <div *ngIf="!!dryQueryEstimate"
                >Estimate - {{ dryDataSize }} - {{ dryTimeAgo$ | async }}
              </div>

              <m-query-status
                *ngIf="!dryQueryEstimate"
                [query]="query"
                [showDataRowsLength]="true"
                [showLastCompleteDuration]="true"
                [completedWord]="'Completed'"
              ></m-query-status>

              <div
                class="ml-5 flex cursor-pointer flex-row items-center"
                (click)="toggleAutoRun()"
              >
                <ui-switch [checked]="isAutoRun" color="#64BD63"></ui-switch>

                <div
                  class="text-s1 ml-5 flex h-9 select-none items-center text-base"
                  >Auto Run</div
                >
              </div>

              <button
                type="button"
                *ngIf="query?.status === queryStatusEnum.Running"
                data-cy="modelCancelButton"
                class="bg-r600 text-m0 ml-5 flex h-12 w-24 items-center justify-center rounded py-2 text-base font-medium focus:outline-none"
                [ngClass]="{
                  'cursor-default': isCancelButtonPressed === true
                }"
                (click)="cancel()"
                [disabled]="isCancelButtonPressed === true"
              >
                <div *ngIf="isCancelButtonPressed === false">Cancel</div>
                <div
                  *ngIf="isCancelButtonPressed === true"
                  class="relative flex h-9 w-9 flex-shrink-0"
                >
                  <ngx-spinner
                    [name]="modelCancelButtonSpinnerName"
                    color="#FFFFFF"
                    bdColor="#00000000"
                    size="default"
                    type="ball-clip-rotate"
                    [fullScreen]="false"
                    [disableAnimation]="true"
                    [zIndex]="99998"
                  >
                  </ngx-spinner>
                </div>
              </button>

              <div
                *ngIf="query?.status !== queryStatusEnum.Running"
                tp="Select Model Fields"
                class="ml-5"
                [tpIsEnabled]="mconfig?.select.length === 0"
              >
                <button
                  type="button"
                  data-cy="modelRunButton"
                  class="text-m0 flex h-12 w-24 items-center justify-center rounded text-base font-medium focus:outline-none"
                  [ngClass]="{
                    'bg-m600': mconfig?.select.length > 0,
                    'cursor-default':
                      mconfig?.select.length === 0 ||
                      isRunButtonPressed === true,
                    'bg-s400': mconfig?.select.length === 0
                  }"
                  (click)="run()"
                  [disabled]="
                    mconfig?.select.length === 0 || isRunButtonPressed === true
                  "
                >
                  <div *ngIf="isRunButtonPressed === false">Run</div>
                  <div
                    *ngIf="isRunButtonPressed === true"
                    class="relative flex h-9 w-9 flex-shrink-0"
                  >
                    <ngx-spinner
                      [name]="modelRunButtonSpinnerName"
                      color="#FFFFFF"
                      bdColor="#00000000"
                      size="default"
                      type="ball-clip-rotate"
                      [fullScreen]="false"
                      [disableAnimation]="true"
                      [zIndex]="99998"
                    >
                    </ngx-spinner>
                  </div>
                </button>
              </div>

              <!-- <div class="relative ml-5">
              <m-query-options
                [showRunDryButton]="
                  query?.connectionType === connectionTypeEnum.BigQuery
                "
                (runDryEvent)="runDry()"
              ></m-query-options>
            </div> -->
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex h-2 w-full flex-1 flex-row">
        <div
          class="bg-m0 flex h-full w-1/4 flex-shrink-0 flex-col rounded shadow"
        >
          <div
            class="flex h-2 flex-col"
            [ngClass]="{
              'h-[45%]': modelIsExpanded === true,
              'flex-1': modelIsExpanded === false
            }"
          >
            <div class="mb-6 mt-6 flex h-11 flex-row items-center">
              <m-search-icon class="text-s1 ml-6"></m-search-icon>

              <input
                spellcheck="false"
                autocomplete="off"
                data-cy="chartsSearchInput"
                class="form-input focus:border-m600 border-s400 ml-3 h-10 w-[225px] rounded"
                placeholder="Search Charts"
                [ngClass]="{
                  'bg-p200': !!word
                }"
                [(ngModel)]="word"
                (ngModelChange)="searchWordChange()"
              />

              <div class="ml-3 h-9 w-9 flex-shrink-0">
                <m-delete-icon
                  *ngIf="!!word"
                  class="text-s1 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded focus:outline-none"
                  [ngClass]="{
                    'bg-p200 hover:bg-p300 cursor-pointer': !!word
                  }"
                  (click)="resetSearch()"
                ></m-delete-icon>
              </div>

              <div class="flex flex-grow"></div>

              <button
                *ngIf="filteredDraftsLength > 0"
                class="ml-5 mr-10 flex flex-shrink-0 flex-row items-center rounded border px-4 py-2 focus:outline-none"
                [ngClass]="{
                  'border-s400 text-s500 hover:bg-s100':
                    filteredDraftsLength > 0,
                  'border-s300 text-s400 cursor-default':
                    filteredDraftsLength === 0
                }"
                [disabled]="filteredDraftsLength === 0"
                (click)="deleteDrafts()"
              >
                <m-trash-icon></m-trash-icon>
                <div class="ml-3">Drafts</div>
              </button>
            </div>

            <div class="divide-s300 ml-6 mr-9 flex flex-col divide-y">
              <div class="flex flex-row"></div>
              <div class="flex flex-row"></div>
            </div>

            <div
              #leftChartsContainer
              class="flex h-2 flex-grow flex-col overflow-y-auto"
              [ngClass]="{
                visible: isInitialScrollCompleted === true,
                invisible: isInitialScrollCompleted === false
              }"
            >
              <div
                *ngFor="let c of filteredCharts; let i = index"
                [attr.chartId]="c.chartId"
              >
                <div
                  *ngIf="filteredDraftsLength > 0 && i === 0"
                  class="text-s500 mb-4 ml-[24px] mr-[36px] mt-4 flex flex-row justify-start font-semibold"
                >
                  Drafts
                </div>

                <div
                  *ngIf="i === filteredDraftsLength"
                  class="text-s500 mb-4 ml-[24px] mr-[36px] mt-4 flex flex-row justify-start font-semibold"
                >
                  Saved Charts
                </div>

                <div
                  class="group ml-6 mr-5 flex h-11 flex-row items-center rounded pr-2 hover:cursor-pointer"
                  (click)="navToChart(c)"
                  [ngClass]="{
                    'mt-4': i === 0,
                    'mb-5': i === filteredCharts.length - 1,
                    'hover:bg-m50': c.chartId !== chart?.chartId
                  }"
                >
                  <div class="ml-4 mr-3 flex h-2 items-center">
                    <div
                      *ngIf="c.chartId === chart?.chartId"
                      data-cy="chartsSelectedSymbol"
                      class="bg-m600 text-m0 h-9 w-[6px] focus:outline-none"
                    ></div>

                    <div
                      *ngIf="c.chartId !== chart?.chartId"
                      class="h-9 w-[6px]"
                    ></div>
                  </div>

                  <div
                    class="ml-1 h-6 w-6 flex-shrink-0"
                    [ngClass]="{
                      'text-m600': !!chart && c.chartId === chart?.chartId,
                      'text-s500': !chart || c.chartId !== chart?.chartId
                    }"
                  >
                    <!-- <img [src]="c.iconPath" /> -->

                    <m-chart-table-icon
                      *ngIf="c.chartType === chartTypeEnumTable"
                    ></m-chart-table-icon>

                    <m-chart-line-icon
                      *ngIf="c.chartType === chartTypeEnumLine"
                    ></m-chart-line-icon>

                    <m-chart-bar-icon
                      *ngIf="c.chartType === chartTypeEnumBar"
                    ></m-chart-bar-icon>

                    <m-chart-scatter-icon
                      *ngIf="c.chartType === chartTypeEnumScatter"
                    ></m-chart-scatter-icon>

                    <m-chart-pie-icon
                      *ngIf="c.chartType === chartTypeEnumPie"
                    ></m-chart-pie-icon>
                  </div>

                  <div
                    class="ml-3 truncate"
                    [ngClass]="{
                      'text-m600 font-semibold': c.chartId === chart?.chartId,
                      'text-s1': c.chartId !== chart?.chartId
                    }"
                  >
                    {{ c.title | capitalize }}
                  </div>

                  <div class="flex flex-grow"></div>

                  <button
                    *ngIf="chart.draft === true && c.chartId === chart.chartId"
                    data-cy="chartsSaveDraftButton"
                    class="ml-3 flex h-11 items-center justify-center rounded focus:outline-none"
                    (click)="chartSaveAs($event)"
                  >
                    <div
                      class="hover:bg-m200 flex h-9 w-9 flex-shrink-0 flex-row items-center justify-center rounded px-2"
                    >
                      <m-save-icon class="text-s500"></m-save-icon>
                    </div>
                  </button>

                  <button
                    *ngIf="chart.draft === true && c.chartId === chart.chartId"
                    data-cy="chartsDeleteDraftButton"
                    class="hover:bg-m200 text-s500 ml-3 flex h-9 flex-shrink-0 items-center justify-center rounded px-2 focus:outline-none"
                    (click)="deleteDraftChart($event, c)"
                  >
                    <m-trash-icon></m-trash-icon>
                  </button>

                  <div
                    *ngIf="c.draft === false && c.chartId !== emptyChartId"
                    class="invisible ml-2 flex group-hover:visible"
                  >
                    <m-chart-options
                      [chart]="c"
                      [isHoverM]="false"
                    ></m-chart-options>
                  </div>
                </div>
              </div>
            </div>

            <!-- <div class="divide-s300 flex flex-col divide-y">
              <div class="flex flex-row"></div>
              <div class="flex flex-row"></div>
            </div> -->

            <div
              class="text-s1 bg-s150 border-s300 flex w-full flex-shrink-0 flex-row items-center border py-5"
            >
              <div
                (click)="toggleModelFieldsPanel()"
                class="flex h-11 cursor-pointer select-none flex-row items-center pl-[22px] pr-3 text-lg font-semibold"
              >
                <div class="flex flex-row items-center">
                  <m-chevron-right-icon
                    *ngIf="!modelIsExpanded"
                  ></m-chevron-right-icon>
                  <m-chevron-down-icon
                    *ngIf="modelIsExpanded"
                  ></m-chevron-down-icon>

                  <div class="ml-[12px]"> MODEL </div>
                </div>
              </div>

              <button
                class="ml-2 w-[54px] cursor-pointer select-none items-center text-lg"
                [ngClass]="{
                  'font-semibold': modelTreeLevels === modelTreeLevelsFlat
                }"
                (click)="setModelTreeLevels(modelTreeLevelsFlat)"
              >
                Flat
              </button>

              <button
                class="ml-2 w-[54px] cursor-pointer select-none text-lg"
                [ngClass]="{
                  'font-semibold': modelTreeLevels === modelTreeLevelsNested
                }"
                (click)="setModelTreeLevels(modelTreeLevelsNested)"
                >Tree</button
              >

              <div class="ml-5 mr-9 flex w-2 flex-1">
                <form class="w-full" [formGroup]="modelForm">
                  <ng-select
                    #chartsModelSelect
                    data-cy="chartsModelSelect"
                    class="model-select w-full text-base"
                    [items]="models"
                    [clearable]="false"
                    [searchable]="true"
                    (change)="modelChange()"
                    (keyup.esc)="
                      $event.stopImmediatePropagation();
                      chartsModelSelect.blur()
                    "
                    (keyup.enter)="
                      $event.stopImmediatePropagation();
                      chartsModelSelect.blur()
                    "
                    appendTo="body"
                    bindLabel="label"
                    bindValue="modelId"
                    formControlName="model"
                  >
                    <ng-template ng-label-tmp let-item="item">
                      <div class="truncate">{{ item.label }}</div>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="truncate">{{ item.label }}</div>
                    </ng-template>
                  </ng-select>
                </form>
              </div>
            </div>
          </div>

          <div class="flex flex-1 flex-col" *ngIf="modelIsExpanded === true">
            <!-- <div class="divide-s300 flex flex-col divide-y">
              <div class="flex flex-row"></div>
              <div class="flex flex-row"></div>
            </div> -->

            <m-model-tree
              class="flex flex-1"
              (expandFilters)="expandFiltersPanel()"
            ></m-model-tree>
          </div>
        </div>

        <div
          class="flex h-full flex-1 flex-col"
          *ngIf="
            !(
              lastUrl !== pathCharts &&
              lastUrl !== pathChartsList &&
              lastUrl !== pathModelsList
            )
          "
        >
          <div class="ml-6 flex h-full flex-grow">
            <div
              class="ml-6 flex min-w-[2px] flex-grow flex-col"
              *ngIf="
                lastUrl !== pathChartsList &&
                lastUrl !== pathModelsList &&
                lastUrl === pathCharts
              "
            >
              <div
                class="text-s1 mb-[80px] flex h-full w-full select-none items-center justify-center text-xl"
              >
                Select Chart
              </div>
            </div>

            <div
              class="h-full w-full"
              *ngIf="lastUrl === pathChartsList || lastUrl === pathModelsList"
            >
              <router-outlet></router-outlet>
            </div>
          </div>
        </div>

        <div
          class="ml-6 flex min-w-[2px] flex-grow flex-col space-y-2"
          *ngIf="
            lastUrl !== pathCharts &&
            lastUrl !== pathChartsList &&
            lastUrl !== pathModelsList
          "
        >
          <div
            class="bg-m0 w-full rounded shadow"
            [ngClass]="{
              'h-[45%]': chartIsExpanded
            }"
          >
            <div class="flex h-full flex-col">
              <div
                class="bg-m0 flex h-[92px] flex-shrink-0 flex-row items-center pb-6 pr-5 pt-6"
              >
                <m-panel-title
                  [title]="'Chart'"
                  [isExpanded]="chartIsExpanded"
                  (toggleEvent)="toggleChartPanel()"
                  [showToggle]="true"
                ></m-panel-title>

                <ng-template #templateChartSaveAs>
                  <div
                    *ngIf="
                      isSelectValid === false ||
                      mconfig?.chart?.isValid === false ||
                      chartTitleForm?.valid === false
                    "
                    >Chart is not valid</div
                  >

                  <div
                    *ngIf="
                      isSelectValid === true &&
                      mconfig?.chart?.isValid === true &&
                      chartTitleForm?.valid === true &&
                      alias === restrictedUserAlias
                    "
                    >User is restricted. Sign Up at https://mprove.io to get
                    full access.</div
                  >
                </ng-template>

                <div
                  *ngIf="mconfig?.select.length > 0"
                  class="ml-5"
                  [tp]="templateChartSaveAs"
                  [tpIsEnabled]="
                    isSelectValid === false ||
                    mconfig?.chart?.isValid === false ||
                    chartTitleForm?.valid === false ||
                    alias === restrictedUserAlias
                  "
                >
                  <button
                    type="button"
                    data-cy="chartSaveAsButton"
                    class="w-28 flex-shrink-0 rounded border py-2 text-base font-medium focus:outline-none"
                    [ngClass]="{
                      'border-s400 text-s500 hover:bg-s100':
                        isSelectValid === true &&
                        mconfig.chart.isValid === true &&
                        chartTitleForm.valid === true &&
                        alias !== restrictedUserAlias,
                      'border-s300 text-s400 cursor-default':
                        isSelectValid === false ||
                        mconfig.chart.isValid === false ||
                        chartTitleForm.valid === false ||
                        alias === restrictedUserAlias
                    }"
                    (click)="chartSaveAs($event)"
                    [disabled]="
                      isSelectValid === false ||
                      mconfig.chart.isValid === false ||
                      chartTitleForm.valid === false ||
                      alias === restrictedUserAlias
                    "
                    >Save As</button
                  >
                </div>

                <button
                  *ngIf="mconfig?.select.length > 0"
                  data-cy="modelShowChartButton"
                  class="text-s500 ml-5 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded focus:outline-none"
                  (click)="showChart($event)"
                >
                  <m-chart-view-icon></m-chart-view-icon>
                </button>

                <div
                  *ngIf="mconfig?.select.length > 0"
                  class="text-s1 ml-10 select-none text-base"
                  >Title</div
                >

                <div
                  *ngIf="mconfig?.select.length > 0"
                  [formGroup]="chartTitleForm"
                  class="ml-5 mr-5 flex w-full flex-col items-start"
                >
                  <div class="h-6"></div>
                  <input
                    autocomplete="off"
                    spellcheck="false"
                    data-cy="modelChartTitleInput"
                    class="form-input border-s3 focus:border-m600 text-s500 h-10 w-full rounded font-semibold"
                    [ngClass]="{
                      'border-r600':
                        chartTitleForm.controls['chartTitle'].invalid &&
                        chartTitleForm.controls['chartTitle'].touched
                    }"
                    formControlName="chartTitle"
                    placeholder="Title"
                    (blur)="chartTitleBlur()"
                  />
                  <m-validation
                    [control]="chartTitleForm.controls['chartTitle']"
                  ></m-validation>
                </div>

                <div
                  *ngIf="mconfig?.select.length > 0"
                  class="flex w-1/3 flex-shrink-0 flex-row items-center justify-end space-x-5 pr-5"
                >
                  <m-chart-table-icon
                    class="h-6 w-6 cursor-pointer"
                    [ngClass]="{
                      'text-m500': mconfig.chart?.type === chartTypeEnumTable,
                      'text-s500': mconfig.chart?.type !== chartTypeEnumTable
                    }"
                    (click)="chartTypeChange(chartTypeEnumTable)"
                  ></m-chart-table-icon>

                  <m-chart-line-icon
                    class="h-6 w-6 cursor-pointer"
                    [ngClass]="{
                      'text-m500': mconfig.chart?.type === chartTypeEnumLine,
                      'text-s500': mconfig.chart?.type !== chartTypeEnumLine
                    }"
                    (click)="chartTypeChange(chartTypeEnumLine)"
                  ></m-chart-line-icon>

                  <m-chart-bar-icon
                    class="h-6 w-6 cursor-pointer"
                    [ngClass]="{
                      'text-m500': mconfig.chart?.type === chartTypeEnumBar,
                      'text-s500': mconfig.chart?.type !== chartTypeEnumBar
                    }"
                    (click)="chartTypeChange(chartTypeEnumBar)"
                  ></m-chart-bar-icon>

                  <m-chart-scatter-icon
                    class="h-6 w-6 cursor-pointer"
                    [ngClass]="{
                      'text-m500': mconfig.chart?.type === chartTypeEnumScatter,
                      'text-s500': mconfig.chart?.type !== chartTypeEnumScatter
                    }"
                    (click)="chartTypeChange(chartTypeEnumScatter)"
                  ></m-chart-scatter-icon>

                  <m-chart-pie-icon
                    class="h-6 w-6 cursor-pointer"
                    [ngClass]="{
                      'text-m500': mconfig.chart?.type === chartTypeEnumPie,
                      'text-s500': mconfig.chart?.type !== chartTypeEnumPie
                    }"
                    (click)="chartTypeChange(chartTypeEnumPie)"
                  ></m-chart-pie-icon>

                  <form
                    [formGroup]="chartTypeForm"
                    *ngIf="mconfig?.select.length > 0"
                    class="ml-5"
                  >
                    <ng-select
                      #chartTypeSelect
                      data-cy="mainChartTypeSelect"
                      class="main-chart-type-select w-[200px] text-base focus:outline-none"
                      [items]="chartTypesList"
                      [clearable]="false"
                      [searchable]="false"
                      (change)="chartTypeChange()"
                      (keyup.esc)="
                        $event.stopImmediatePropagation();
                        chartTypeSelect.blur()
                      "
                      (keyup.enter)="
                        $event.stopImmediatePropagation();
                        chartTypeSelect.blur()
                      "
                      appendTo="body"
                      bindLabel="label"
                      bindValue="value"
                      formControlName="chartType"
                    >
                      <ng-template ng-label-tmp let-item="item">
                        <div
                          class="ml-1 flex flex-row items-center justify-start space-x-2"
                        >
                          <img class="h-6 w-6" [src]="item.iconPath" />
                          <div> {{ item.label }} </div>
                        </div>
                      </ng-template>
                      <ng-template
                        ng-option-tmp
                        let-item="item"
                        let-index="index"
                        let-search="searchTerm"
                      >
                        <div
                          class="ml-1 flex flex-row items-center justify-start space-x-2"
                        >
                          <img class="h-6 w-6" [src]="item.iconPath" />
                          <div> {{ item.label }} </div>
                        </div>
                      </ng-template>
                    </ng-select>
                  </form>
                </div>
              </div>

              <div
                class="divide-s300 ml-6 mr-5 flex flex-col divide-y"
                *ngIf="chartIsExpanded"
              >
                <div class="flex flex-row"></div>
                <div class="flex flex-row"></div>
              </div>

              <div
                class="mx-5 mb-5 mt-5 flex h-2 flex-grow"
                *ngIf="chartIsExpanded"
              >
                <div
                  *ngIf="mconfig?.select.length === 0"
                  class="text-s1 flex h-full w-full select-none items-center justify-center text-xl"
                  >Select Model Fields</div
                >

                <div
                  *ngIf="mconfig?.select.length > 0"
                  class="flex h-full w-2 flex-1 flex-row items-start justify-center space-x-5"
                >
                  <div class="h-full w-full overflow-auto pb-3">
                    <div
                      class="h-full w-full"
                      [ngClass]="{
                        'max-w-max':
                          mconfig?.chart.type === chartTypeEnumTable &&
                          isSelectValid === true &&
                          mconfig?.chart.isValid === true &&
                          qData?.length > 0
                      }"
                    >
                      <m-chart-view
                        *ngIf="mconfig?.chart"
                        class="h-full w-full"
                        [mconfigFields]="mconfig.fields"
                        [qData]="qData"
                        [chart]="mconfig.chart"
                        [isStoreModel]="mconfig.isStoreModel"
                        [queryStatus]="query.status"
                        [chartInstanceId]="'model-chart'"
                      ></m-chart-view>
                    </div>
                  </div>

                  <div
                    class="h-full w-1/3 flex-shrink-0 overflow-auto border-l"
                    [ngClass]="{
                      'border-s300': mconfig.chart.isValid === true,
                      'border-r600': mconfig.chart.isValid === false
                    }"
                  >
                    <m-chart-editor
                      [chart]="mconfig.chart"
                      [isReport]="false"
                      [mconfigFields]="mconfig.fields"
                      [queryId]="mconfig?.queryId"
                    ></m-chart-editor>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="w-full">
            <div class="flex flex-col">
              <div class="mr-5 flex flex-shrink-0 flex-grow flex-row">
                <!-- <div
                  class="text-s1 ml-6 mt-4 flex h-full min-h-[76px] w-full flex-shrink-0 select-none pt-4 text-xl"
                  *ngIf="mconfig?.extendedFilters.length === 0"
                  >No parameters</div
                > -->

                <div
                  class="mt-4 flex min-h-[76px] flex-shrink-0 flex-grow flex-row"
                >
                  <div
                    (click)="toggleFiltersPanel()"
                    class="text-s1 mt-1 flex h-11 select-none flex-row items-start space-x-2 px-5 py-3 text-xl font-semibold"
                    [ngClass]="{
                      'cursor-pointer': mconfig?.extendedFilters.length > 0,
                      'cursor-default': mconfig?.extendedFilters.length === 0
                    }"
                  >
                    <div class="flex flex-row items-center space-x-2">
                      <m-chevron-right-icon
                        *ngIf="
                          !filtersIsExpanded &&
                          mconfig?.extendedFilters.length > 0
                        "
                      ></m-chevron-right-icon>

                      <m-chevron-down-icon
                        *ngIf="
                          filtersIsExpanded &&
                          mconfig?.extendedFilters.length > 0
                        "
                      ></m-chevron-down-icon>

                      <div
                        class="h-6 w-6"
                        *ngIf="mconfig?.extendedFilters.length === 0"
                      ></div>

                      <div> Parameters </div>
                    </div>
                  </div>

                  <div class="flex w-full flex-col">
                    <div class="flex w-full flex-row">
                      <button
                        *ngIf="
                          filtersIsExpanded === true ||
                          mconfig?.extendedFilters.length === 0
                        "
                        type="button"
                        data-cy="chartsAddParameterButton"
                        class="border-s400 text-s500 hover:bg-m0 ml-2 mt-2 h-11 flex-shrink-0 select-none rounded border px-4 py-2 focus:outline-none"
                        (click)="addParameter()"
                      >
                        Add Filter
                      </button>

                      <div class="min-h-[68px]"></div>

                      <div
                        class="w-2 flex-1"
                        [ngClass]="{
                          'ml-7 ':
                            filtersIsExpanded === true ||
                            isAddParameter === true
                        }"
                      >
                        <div
                          class="mt-2 flex flex-row"
                          *ngIf="isAddParameter === true"
                          [ngClass]="{
                            'border-s300 mb-5 border-b pb-5':
                              mconfig?.extendedFilters.length > 0
                          }"
                        >
                          <div
                            class="flex h-11 max-w-[850px] flex-1 flex-row items-center space-x-5"
                          >
                            <div
                              class="text-s1 flex flex-shrink-0 select-none items-center font-semibold"
                              >Filter by</div
                            >

                            <ng-select
                              #filterBySelect
                              data-cy="filterBySelect"
                              class="filter-metric-by-select w-full min-w-[2px] text-base"
                              [items]="filterByFieldsList"
                              [searchable]="true"
                              [searchFn]="filterBySearchFn"
                              [clearable]="false"
                              [(ngModel)]="newParameterFieldId"
                              (change)="filterByChange()"
                              (keyup.esc)="
                                $event.stopImmediatePropagation();
                                filterBySelect.blur()
                              "
                              (keyup.enter)="
                                $event.stopImmediatePropagation();
                                filterBySelect.blur()
                              "
                              [dropdownPosition]="'top'"
                              appendTo="body"
                              placeholder="Field"
                              bindLabel="partLabel"
                              bindValue="id"
                            >
                              <ng-template ng-label-tmp let-item="item">
                                <m-field-label
                                  [column]="item"
                                  class="ml-1 flex"
                                ></m-field-label>
                              </ng-template>

                              <ng-template
                                ng-option-tmp
                                let-item="item"
                                let-index="index"
                                let-search="searchTerm"
                              >
                                <m-field-label
                                  [column]="item"
                                  class="ml-1 flex"
                                ></m-field-label>
                              </ng-template>
                            </ng-select>
                          </div>

                          <ng-template #templateApplyAddFilter>
                            <div *ngIf="isDisabledApplyAlreadyFiltered === true"
                              >This field is already filtered. Click on + to add
                              new filter conditions.</div
                            >
                          </ng-template>

                          <div
                            class="flex"
                            [tpIsEnabled]="
                              isDisabledApplyAlreadyFiltered === true
                            "
                            [tp]="templateApplyAddFilter"
                          >
                            <button
                              data-cy="chartsApplyAddParameterButton"
                              class="bg-m600 text-m0 ml-5 select-none rounded px-4 py-2 font-medium focus:outline-none"
                              [ngClass]="{
                                'bg-m600':
                                  isDisabledApplyAlreadyFiltered === false,
                                'bg-s400 cursor-default':
                                  isDisabledApplyAlreadyFiltered === true
                              }"
                              type="button"
                              (click)="applyAddParameter()"
                              [disabled]="
                                isDisabledApplyAlreadyFiltered === true
                              "
                              >Apply</button
                            >
                          </div>

                          <button
                            type="button"
                            data-cy="chartsCancelAddParameterButton"
                            class="border-s400 text-s500 hover:bg-m0 ml-5 select-none rounded border px-4 py-2 focus:outline-none"
                            (click)="cancelAddParameter()"
                          >
                            Cancel
                          </button>
                        </div>

                        <div
                          class="flex flex-row items-start"
                          *ngIf="
                            !filtersIsExpanded &&
                            mconfig?.extendedFilters.length > 0
                          "
                        >
                          <m-bricks
                            class="mb-5 ml-3 mr-5 mt-3 flex max-h-[150px] max-w-max flex-row items-start justify-start overflow-auto"
                            [extendedFilters]="mconfig.extendedFilters"
                            [isKeepBackgroundColor]="false"
                          ></m-bricks>
                        </div>

                        <div
                          class="max-h-[260px] w-full overflow-auto"
                          *ngIf="filtersIsExpanded"
                        >
                          <m-model-filters
                            [modelContent]="model.content"
                          ></m-model-filters>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-m0 w-full flex-1 rounded shadow">
            <div class="flex h-full flex-col">
              <div class="bg-m0 flex h-20 flex-shrink-0 flex-row items-center">
                <div class="flex flex-1 flex-row items-center">
                  <m-panel-title
                    class="mb-1"
                    [title]="'Data'"
                    [isExpanded]="true"
                    (toggleEvent)="toggleDataPanel()"
                    [showToggle]="false"
                  ></m-panel-title>

                  <div
                    *ngIf="mconfig?.select.length > 0"
                    class="ml-5 flex cursor-pointer flex-row items-center"
                    (click)="toggleFormat()"
                  >
                    <div
                      class="text-s1 flex h-9 select-none items-center text-base"
                      >Format</div
                    >

                    <ui-switch class="ml-5" [checked]="isFormat"></ui-switch>
                  </div>

                  <div
                    class="text-s1 ml-10 select-none text-base"
                    *ngIf="mconfig?.select.length > 0"
                    >Limit</div
                  >

                  <div
                    [formGroup]="limitForm"
                    *ngIf="mconfig?.select.length > 0"
                    class="ml-5 flex flex-col items-start"
                  >
                    <div class="h-6"></div>
                    <input
                      autocomplete="off"
                      spellcheck="false"
                      data-cy="modelLimitInput"
                      class="form-input border-s3 focus:border-m600 h-[36px] w-32 rounded"
                      [ngClass]="{
                        'border-r600':
                          limitForm.controls['limit'].invalid &&
                          limitForm.controls['limit'].touched
                      }"
                      formControlName="limit"
                      (blur)="limitBlur()"
                    />
                    <m-validation
                      [control]="limitForm.controls['limit']"
                    ></m-validation>
                  </div>

                  <div
                    class="text-s1 ml-5 select-none text-base"
                    *ngIf="mconfig?.select.length > 0"
                    >Timezone</div
                  >

                  <div
                    class="ml-5 mr-9 flex w-2 flex-1"
                    *ngIf="mconfig?.select.length > 0"
                  >
                    <form
                      class="w-full"
                      [formGroup]="timezoneForm"
                      tp="Timezone change is not allowed"
                      [tpIsEnabled]="
                        timezoneForm.controls['timezone'].disabled === true
                      "
                    >
                      <ng-select
                        #modelTimezoneSelect
                        data-cy="modelTimezoneSelect"
                        class="w-full text-base"
                        [items]="timezones"
                        [clearable]="false"
                        [searchable]="true"
                        [searchFn]="timezoneSearchFn"
                        (change)="timezoneChange()"
                        (keyup.esc)="
                          $event.stopImmediatePropagation();
                          modelTimezoneSelect.blur()
                        "
                        (keyup.enter)="
                          $event.stopImmediatePropagation();
                          modelTimezoneSelect.blur()
                        "
                        appendTo="body"
                        bindLabel="label"
                        bindValue="value"
                        formControlName="timezone"
                      >
                        <ng-template ng-label-tmp let-item="item">
                          <div class="truncate">{{ item.label }}</div>
                        </ng-template>

                        <ng-template ng-option-tmp let-item="item">
                          <div class="truncate">{{ item.label }}</div>
                        </ng-template>
                      </ng-select>
                    </form>
                  </div>
                </div>

                <div class="flex flex-1 flex-row items-center">
                  <div
                    *ngIf="mconfig?.select.length > 0"
                    (click)="toggleInfoPanel()"
                    class="text-s1 flex h-11 cursor-pointer select-none flex-row items-center pl-2 pr-5 text-xl font-semibold"
                  >
                    <div class="flex flex-row items-center space-x-2">
                      <m-chevron-right-icon
                        *ngIf="!rightIsShow"
                      ></m-chevron-right-icon>
                      <m-chevron-down-icon
                        *ngIf="rightIsShow"
                      ></m-chevron-down-icon>

                      <div> Info </div>
                    </div>
                  </div>

                  <form
                    [formGroup]="requestPartTypeForm"
                    *ngIf="
                      mconfig?.isStoreModel === true &&
                      mconfig?.select.length > 0 &&
                      rightIsShow === true
                    "
                    class="ml-5"
                  >
                    <ng-select
                      #requestPartTypeSelect
                      data-cy="requestPartTypeSelect"
                      class="w-[250px] flex-shrink-0 text-base focus:outline-none"
                      [items]="requestPartTypeList"
                      [clearable]="false"
                      [searchable]="false"
                      (change)="requestPartTypeChange($event)"
                      (keyup.esc)="
                        $event.stopImmediatePropagation();
                        requestPartTypeSelect.blur()
                      "
                      (keyup.enter)="
                        $event.stopImmediatePropagation();
                        requestPartTypeSelect.blur()
                      "
                      appendTo="body"
                      bindLabel="label"
                      bindValue="value"
                      formControlName="requestPartType"
                    >
                      <ng-template ng-label-tmp let-item="item">
                        <div>{{ item.label }}</div>
                      </ng-template>

                      <ng-template ng-option-tmp let-item="item">
                        <div>{{ item.label }}</div>
                      </ng-template>
                    </ng-select>
                  </form>
                </div>
              </div>

              <div class="divide-s300 mx-5 flex flex-col divide-y">
                <div class="flex flex-row"></div>
                <div class="flex flex-row"></div>
              </div>

              <div class="mx-5 mb-0 mt-0 flex h-2 flex-grow">
                <div
                  *ngIf="mconfig?.select.length === 0"
                  class="text-s1 flex h-full w-full select-none items-center justify-center text-xl"
                  >Select Model Fields</div
                >

                <div
                  *ngIf="mconfig?.select.length > 0"
                  class="flex h-full w-full flex-row items-start justify-center"
                >
                  <div
                    *ngIf="resultsIsShow"
                    class="h-full w-2 flex-1 overflow-auto"
                  >
                    <m-main-table
                      [isEdit]="true"
                      [isFormat]="isFormat"
                      [mconfig]="mconfig"
                      [qData]="qData"
                      [mconfigFields]="mconfig.fields"
                    ></m-main-table>
                  </div>

                  <div
                    *ngIf="rightIsShow"
                    class="border-s300 h-full w-2 flex-1"
                  >
                    <m-sql *ngIf="mconfig.isStoreModel === false"></m-sql>

                    <m-js-viewer
                      *ngIf="
                        mconfig.isStoreModel === true &&
                        [
                          requestPartTypeEnumReqTemplate,
                          requestPartTypeEnumReqFunction,
                          requestPartTypeEnumReqUrlPath
                        ].indexOf(
                          requestPartTypeForm.controls['requestPartType'].value
                        ) > -1
                      "
                      [jsContent]="jsContent"
                    ></m-js-viewer>

                    <m-json-viewer
                      *ngIf="
                        mconfig.isStoreModel === true &&
                        [
                          requestPartTypeEnumReqJsonParts,
                          requestPartTypeEnumReqBody
                        ].indexOf(
                          requestPartTypeForm.controls['requestPartType'].value
                        ) > -1
                      "
                      [jsonContent]="
                        requestPartTypeForm.controls['requestPartType']
                          .value === requestPartTypeEnumReqJsonParts
                          ? mconfig.storePart?.reqJsonParts
                          : requestPartTypeForm.controls['requestPartType']
                              .value === requestPartTypeEnumReqBody
                          ? mconfig.storePart?.reqBody
                          : undefined
                      "
                    ></m-json-viewer>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="routerEvents$ | async"></div>
<div *ngIf="nav$ | async"></div>
<div *ngIf="modelTreeLevels$ | async"></div>
<div *ngIf="isExplorer$ | async"></div>
<div *ngIf="charts$ | async"></div>
<div *ngIf="models$ | async"></div>
<div *ngIf="model$ | async"></div>
<div *ngIf="chart$ | async"></div>
<div *ngIf="struct$ | async"></div>
<div *ngIf="alias$ | async"></div>
