<div class="bg-m1 flex h-full cursor-default flex-col">
  <div class="flex h-2 flex-1 flex-row">
    <div class="mx-6 mb-6 mt-8 flex min-w-[2px] flex-grow flex-col">
      <div class="flex h-11 flex-row items-center justify-between">
        <div class="flex h-11 w-1/4 flex-row items-center justify-start">
          <div
            data-cy="filesTitle"
            class="text-s1 flex select-none items-center self-center text-2xl font-semibold"
            >{{ pageTitle }}
          </div>

          <div
            class="ml-10 flex flex-1 select-none flex-row items-center justify-between"
          >
            <div
              class="flex cursor-pointer flex-row items-center"
              tp="Need to Save changes"
              [tpIsEnabled]="needSave === true"
              (click)="setPanel(panelTree)"
            >
              <!-- <m-document-icon></m-document-icon> -->

              <button
                class="flex w-[54px] items-center justify-center text-lg focus:outline-none"
                [ngClass]="{
                  'text-m500 font-semibold': panel === panelTree,
                  'text-s500': panel !== panelTree
                }"
                [disabled]="needSave === true"
                >Code</button
              >
            </div>

            <div
              class="ml-7"
              tp="Need to Save changes"
              [tpIsEnabled]="needSave === true"
            >
              <button
                class="flex flex-shrink-0 cursor-pointer flex-row items-center focus:outline-none"
                (click)="setPanel(panelChangesToCommit)"
                [disabled]="needSave === true"
              >
                <div
                  class="flex w-[110px] flex-shrink-0 justify-center text-lg"
                  [ngClass]="{
                    'text-m500 font-semibold': panel === panelChangesToCommit,
                    'text-s500': panel !== panelChangesToCommit
                  }"
                  >To Commit</div
                >

                <div
                  class="text-m0 ml-2 flex h-7 min-w-7 flex-shrink-0 items-center justify-center rounded px-2 py-[1px]"
                  [ngClass]="{
                    'bg-m500': panel === panelChangesToCommit,
                    'bg-m600':
                      panel !== panelChangesToCommit &&
                      repo?.changesToCommit?.length > 0,
                    'bg-s400':
                      panel !== panelChangesToCommit &&
                      !(repo?.changesToCommit?.length > 0)
                  }"
                  >{{ repo?.changesToCommit?.length }}</div
                >
              </button>
            </div>

            <ng-template #templateChangesToPush>
              <div *ngIf="needSave === true">Need to Save changes</div>
              <div
                *ngIf="needSave === false && repo?.changesToCommit?.length > 0"
                >Commit to see Changes to Push</div
              >
              <div
                *ngIf="
                  needSave === false &&
                  repo?.changesToCommit?.length === 0 &&
                  repo?.changesToPush?.length === 0 &&
                  repo.repoStatus === repoStatusNeedPush
                "
                >Push branch to Remote</div
              >
            </ng-template>

            <div
              class="ml-7"
              [tp]="templateChangesToPush"
              [tpIsEnabled]="
                needSave === true ||
                repo?.changesToCommit?.length > 0 ||
                (repo?.changesToPush?.length === 0 &&
                  repo.repoStatus === repoStatusNeedPush)
              "
            >
              <button
                class="flex flex-shrink-0 flex-row items-center focus:outline-none"
                [ngClass]="{
                  'cursor-pointer': repo?.changesToCommit?.length === 0
                }"
                [disabled]="
                  needSave === true || repo?.changesToCommit?.length > 0
                "
                (click)="setPanel(panelChangesToPush)"
              >
                <div
                  class="flex w-[80px] flex-shrink-0 justify-center text-lg"
                  [ngClass]="{
                    'text-m500 font-semibold': panel === panelChangesToPush,
                    'text-s500': panel !== panelChangesToPush
                  }"
                  >To Push</div
                >

                <div
                  class="ml-2 flex h-7 min-w-7 flex-shrink-0 items-center rounded"
                >
                  <div
                    class="text-m0 flex h-7 min-w-7 flex-shrink-0 items-center rounded px-2 py-[1px]"
                    [ngClass]="{
                      'bg-m500': panel === panelChangesToPush,
                      'bg-m600':
                        panel !== panelChangesToPush &&
                        repo?.changesToPush?.length > 0,
                      'bg-s400':
                        panel !== panelChangesToPush &&
                        !(repo?.changesToPush?.length > 0)
                    }"
                    *ngIf="
                      repo?.changesToCommit?.length === 0 &&
                      (repo?.changesToPush?.length > 0 ||
                        repo.repoStatus !== repoStatusNeedPush)
                    "
                  >
                    {{ repo?.changesToPush?.length }}
                  </div>
                </div>
              </button>
            </div>
          </div>

          <div
            [tp]="templateNewFile"
            [tpIsEnabled]="
              isEditor === false ||
              nav?.isRepoProd === true ||
              needSave === true
            "
            class="ml-10 flex-shrink-0"
          >
            <button
              type="button"
              data-cy="filesAddFileButton"
              class="text-m0 h-11 flex-shrink-0 select-none rounded px-5 py-2 text-base font-medium focus:outline-none"
              [ngClass]="{
                'bg-m600':
                  isEditor === true ||
                  nav?.isRepoProd === false ||
                  needSave === false,
                'bg-s400 cursor-default':
                  isEditor === false ||
                  nav?.isRepoProd === true ||
                  needSave === true
              }"
              (click)="newFile()"
              [disabled]="
                isEditor === false ||
                nav?.isRepoProd === true ||
                needSave === true
              "
              >New File</button
            >
          </div>

          <ng-template #templateNewFile>
            <div *ngIf="isEditor === false"
              >Files can be edited by project members with FilesEditor role</div
            >

            <div *ngIf="isEditor === true && nav?.isRepoProd === true"
              >Switch branch from Production repo to Dev repo to edit files</div
            >

            <div
              *ngIf="
                isEditor === true &&
                nav?.isRepoProd === false &&
                needSave === true
              "
              >Need to Save changes</div
            >
          </ng-template>
        </div>

        <div
          class="flex flex-1 flex-row items-center justify-end"
          *ngIf="!!repo"
        >
          <div
            tp="Production repo is a read-only version of a Remote repo. Switch to the Dev repo to enter development mode."
            *ngIf="nav?.isRepoProd === true"
            class="text-s500 mr-5 flex h-11 flex-row items-center text-lg font-semibold"
          >
            production - {{ nav.branchId }}
          </div>

          <div
            *ngIf="nav?.isRepoProd === false"
            class="text-s500 mr-5 flex h-11 select-none flex-row items-center text-lg font-semibold"
          >
            dev-{{ user.alias }} - {{ nav.branchId }}
          </div>

          <ng-template #templateCommit>
            <div *ngIf="needSave === true">Need to Save changes</div>

            <!-- <div
              *ngIf="
                needSave === false && repo.conflicts.length > 0
              "
              >Need to Resolve conflicts</div
            > -->

            <div
              *ngIf="
                needSave === false && repo.repoStatus === repoStatusNeedPull
              "
              >Need to Pull changes from Remote</div
            >

            <div
              *ngIf="
                needSave === false &&
                (repo.repoStatus === repoStatusOk ||
                  repo.repoStatus === repoStatusNeedPush)
              "
              >No changes to commit</div
            >
          </ng-template>

          <div
            *ngIf="isEditor === true"
            [tp]="templateCommit"
            [tpIsEnabled]="
              repo.repoStatus !== repoStatusNeedCommit || needSave === true
            "
          >
            <button
              type="button"
              data-cy="filesCommitButton"
              class="text-m0 ml-3 h-11 select-none rounded px-5 py-2 text-base font-medium focus:outline-none"
              [ngClass]="{
                'bg-s400 cursor-default':
                  repo.repoStatus !== repoStatusNeedCommit || needSave === true,
                'bg-m600':
                  repo.repoStatus === repoStatusNeedCommit && needSave === false
              }"
              (click)="commit()"
              [disabled]="
                repo.repoStatus !== repoStatusNeedCommit || needSave === true
              "
              >Commit</button
            >
          </div>

          <ng-template #templatePullFromRemote>
            <div *ngIf="needSave === true">Need to Save changes</div>
          </ng-template>

          <div
            *ngIf="isEditor === true && repo.repoStatus === repoStatusNeedPull"
            [tp]="templatePullFromRemote"
            [tpIsEnabled]="needSave === true"
          >
            <button
              type="button"
              data-cy="filesPullFromRemoteButton"
              class="text-m0 ml-3 h-11 rounded px-5 py-2 text-base font-medium focus:outline-none"
              [ngClass]="{
                'bg-s400 cursor-default':
                  repo.repoStatus !== repoStatusNeedPull || needSave === true,
                'bg-m600':
                  repo.repoStatus === repoStatusNeedPull && needSave === false
              }"
              (click)="pull()"
              [disabled]="
                repo.repoStatus !== repoStatusNeedPull || needSave === true
              "
              >Pull from Remote</button
            >
          </div>

          <ng-template #templatePushToRemote>
            <div *ngIf="needSave === true">Need to Save changes</div>

            <div
              *ngIf="
                needSave === false && repo.repoStatus === repoStatusNeedCommit
              "
              >Need to Commit changes</div
            >

            <!-- <div
              *ngIf="
                needSave === false && repo.conflicts.length > 0
              "
              >Need to Resolve conflicts</div
            > -->

            <div
              *ngIf="
                needSave === false && repo.repoStatus === repoStatusNeedPull
              "
              >Need to Pull changes from Remote</div
            >

            <div *ngIf="needSave === false && repo.repoStatus === repoStatusOk"
              >No changes to Push</div
            >
          </ng-template>

          <div
            *ngIf="isEditor === true"
            [tp]="templatePushToRemote"
            [tpIsEnabled]="
              repo.repoStatus !== repoStatusNeedPush || needSave === true
            "
          >
            <button
              type="button"
              data-cy="filesPushButton"
              class="text-m0 ml-3 h-11 select-none rounded px-5 py-2 text-base font-medium focus:outline-none"
              [ngClass]="{
                'bg-m600':
                  needSave === false &&
                  (repo.repoStatus === repoStatusNeedPush ||
                    (repo.repoStatus === repoStatusOk &&
                      repo?.changesToCommit?.length === 0 &&
                      repo?.changesToPush?.length > 0)),
                'bg-s400 cursor-default':
                  needSave === true ||
                  (repo.repoStatus !== repoStatusNeedPush &&
                    !(
                      repo.repoStatus === repoStatusOk &&
                      repo?.changesToCommit?.length === 0 &&
                      repo?.changesToPush?.length > 0
                    ))
              }"
              (click)="push()"
              [disabled]="
                needSave === true ||
                (repo.repoStatus !== repoStatusNeedPush &&
                  !(
                    repo.repoStatus === repoStatusOk &&
                    repo?.changesToCommit?.length === 0 &&
                    repo?.changesToPush?.length > 0
                  ))
              "
              >Push to Remote</button
            >
          </div>

          <div
            *ngIf="isEditor === true"
            tp="Need to Save changes"
            [tpIsEnabled]="needSave === true"
          >
            <button
              tp="Refresh repo status (does not validate files)"
              type="button"
              data-cy="filesRefreshButton"
              class="ml-4 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded focus:outline-none"
              [ngClass]="{
                'cursor-default': needSave === true,
                'hover:bg-m200': needSave === false
              }"
              [disabled]="needSave === true"
              (click)="refresh()"
            >
              <m-refresh-icon></m-refresh-icon>
            </button>
          </div>

          <div class="relative ml-3 mr-5" *ngIf="isEditor === true">
            <m-repo-options></m-repo-options>
          </div>
        </div>

        <div class="flex w-[30%]"></div>
      </div>

      <div class="mt-6 flex h-2 flex-1 flex-row">
        <m-files-tree
          [panel]="panel"
          class="flex w-1/4 flex-shrink-0"
        ></m-files-tree>

        <div class="ml-6 flex flex-1 flex-col">
          <div class="bg-m0 flex h-full flex-grow rounded shadow">
            <div
              class="h-full w-full"
              *ngIf="lastUrl !== pathFiles && !!file?.fileId"
            >
              <router-outlet></router-outlet>
            </div>

            <div
              class="flex h-full w-full select-none items-center justify-center text-xl"
              *ngIf="lastUrl === pathFiles || !file?.fileId"
              >Select File</div
            >
          </div>
        </div>

        <m-files-right
          *ngIf="panel === panelTree"
          class="flex w-[37%]"
        ></m-files-right>

        <!-- <m-files-right
          *ngIf="panel === panelTree"
          class="flex"
          [ngClass]="{
            'w-[37%]':
              nav?.needValidate === false &&
              !!repo &&
              repo.conflicts.length === 0 &&
              !!struct &&
              struct.errors.length === 0 &&
              !!secondFileNodeId,
            'w-[30%]':
              nav?.needValidate === true ||
              repo?.conflicts?.length !== 0 ||
              struct?.errors?.length !== 0 ||
              !secondFileNodeId
          }"
        ></m-files-right> -->
      </div>
    </div>
  </div>
</div>

<div *ngIf="routerEvents$ | async"></div>
<div *ngIf="nav$ | async"></div>
<div *ngIf="secondFileNodeId$ | async"></div>
<div *ngIf="file$ | async"></div>
<div *ngIf="repo$ | async"></div>
<div *ngIf="struct$ | async"></div>
<div *ngIf="panel$ | async"></div>
<div *ngIf="needSave$ | async"></div>
<div *ngIf="isEditor$ | async"></div>
<div *ngIf="user$ | async"></div>
