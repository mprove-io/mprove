<div class="flex h-[87vh] w-[70vw] flex-col p-10">
  <div class="min-h-9 mb-5 flex flex-1 flex-row justify-center text-xl">
    <div class="flex w-1/4 flex-1 flex-row items-center justify-start"> </div>

    <div
      class="text-gray1 mx-5 line-clamp-2 flex h-14 max-w-prose flex-shrink-0 flex-grow flex-row flex-wrap justify-center text-center font-semibold"
      >{{ title }}
    </div>

    <div class="flex w-1/4 flex-1 flex-row items-center justify-end"> </div>
  </div>

  <div
    *ngIf="isShowInit === false && showNav === true"
    class="text-gray1 mb-5 flex w-full flex-row items-center justify-start"
  >
    <!-- <div
      class="flex cursor-pointer flex-row items-center justify-start"
      (click)="toggleData()"
      ><ui-switch class="mb-1" [checked]="isData"></ui-switch>

      <div class="text-gray1 ml-5 flex h-9 select-none items-center text-base"
        >Show Data
      </div>
    </div> -->

    <div
      *ngIf="!!ref.data.metricId"
      class="flex flex-1 flex-row items-center justify-start"
    >
      <div
        class="flex h-11 max-w-[850px] flex-1 flex-row items-center space-x-5"
      >
        <div
          class="text-gray1 ml-5 flex flex-shrink-0 select-none items-center text-lg font-semibold"
          >Group by</div
        >

        <form [formGroup]="groupByFieldForm" class="w-full">
          <ng-select
            #groupMetricBySelect
            data-cy="groupMetricBySelect"
            class="group-metric-by-select w-full min-w-[2px] text-base"
            [items]="dimensionsPlusEmpty"
            (open)="openGroupMetricBy()"
            [loading]="fieldsListLoading"
            [searchable]="true"
            [searchFn]="filterMetricBySearchFn"
            [clearable]="false"
            (change)="groupMetricByChange()"
            (keyup.esc)="
              $event.stopImmediatePropagation(); groupMetricBySelect.blur()
            "
            (keyup.enter)="
              $event.stopImmediatePropagation(); groupMetricBySelect.blur()
            "
            [dropdownPosition]="'bottom'"
            appendTo="body"
            placeholder="Field"
            bindLabel="partLabel"
            bindValue="id"
            formControlName="groupByField"
          >
            <ng-template ng-label-tmp let-item="item">
              <m-field-label [column]="item" class="ml-1 flex"></m-field-label>
            </ng-template>

            <ng-template
              ng-option-tmp
              let-item="item"
              let-index="index"
              let-search="searchTerm"
            >
              <m-field-label [column]="item" class="ml-1 flex"></m-field-label>
            </ng-template>
          </ng-select>
        </form>
      </div>
    </div>

    <div
      *ngIf="isData === true && mconfig?.fields?.length > 0"
      class="ml-10 flex h-11 cursor-pointer flex-row items-center"
      (click)="toggleFormat()"
    >
      <ui-switch
        class="mb-1 flex flex-row items-center"
        [checked]="isFormat"
      ></ui-switch>

      <div class="text-gray1 ml-5 flex h-11 select-none items-center text-base"
        >Format
      </div>
    </div>

    <div class="flex flex-1 flex-row items-center justify-end">
      <div *ngIf="!!query" class="flex flex-row items-center justify-end">
        <m-query-status
          [query]="query"
          [showDataRowsLength]="true"
          [showLastCompleteDuration]="true"
          [completedWord]="'Completed'"
        ></m-query-status>
      </div>

      <div
        *ngIf="!!mconfig && mconfig.warnSelect.length > 0"
        class="ml-5 flex h-8 w-8 flex-shrink-0 text-amber-500"
        tp="Warning: The selected fields [{{
          mconfig.warnSelect.join(', ')
        }}] may use unsafe aggregations and produce incorrect results"
        placement="left"
      >
        <m-exclamation-icon></m-exclamation-icon>
      </div>

      <button
        data-cy="chartDialogRunButton"
        class="ml-5 flex h-12 w-24 flex-shrink-0 items-center justify-center rounded text-base font-medium text-white focus:outline-none"
        [ngClass]="{
          'cursor-default bg-gray-400':
            isRunButtonPressed === true || query?.status === queryStatusRunning,
          ' bg-blue3 cursor-pointer':
            isRunButtonPressed === false && query?.status !== queryStatusRunning,
        }"
        (click)="run()"
        [disabled]="
          isRunButtonPressed === true || query?.status === queryStatusRunning
        "
      >
        <div>Run</div>

        <!-- <div *ngIf="isRunButtonPressed === true">
          <div class="relative h-9 w-9 bg-amber-100">
            <ngx-spinner
              [name]="chartDialogRunButtonSpinnerName"
              color="rgba(255, 255, 255, 1)"
              bdColor="rgba(0, 0, 0, 0)"
              size="default"
              type="ball-clip-rotate"
              [fullScreen]="false"
              [disableAnimation]="true"
              [zIndex]="99998"
            >
            </ngx-spinner>
          </div>
        </div> -->
      </button>

      <ng-template #templateChartDialogExplore>
        <div *ngIf="isExplorer === false">Explorer role required</div>
        <div *ngIf="isExplorer === true && canAccessModel === false"
          >No access to model</div
        >
      </ng-template>

      <div
        class="ml-5"
        [tp]="templateChartDialogExplore"
        [tpIsEnabled]="isExplorer === false || canAccessModel === false"
      >
        <button
          data-cy="chartDialogExploreButton"
          class="h-12 rounded px-6 text-base font-medium text-white focus:outline-none"
          [ngClass]="{
            'bg-blue3 cursor-pointer':
              isExplorer === true && canAccessModel === true,
            'cursor-default bg-gray-400':
              isExplorer === false || canAccessModel === false
          }"
          [disabled]="isExplorer === false || canAccessModel === false"
          (click)="explore($event)"
        >
          Explore
        </button>
      </div></div
    >
  </div>

  <div
    *ngIf="isShowInit === false"
    class="flex flex-col"
    [ngClass]="{
      'max-h-[31%] min-h-[31%]':
        mconfig?.chart.type === chartTypeEnumLine ||
        mconfig?.chart.type === chartTypeEnumBar ||
        mconfig?.chart.type === chartTypeEnumScatter,
      'max-h-[30%] min-h-[30%]':
        mconfig?.chart.type !== chartTypeEnumLine &&
        mconfig?.chart.type !== chartTypeEnumBar &&
        mconfig?.chart.type !== chartTypeEnumScatter
    }"
  >
    <div
      *ngIf="isData === true && mconfig?.fields?.length > 0"
      class="flex w-full max-w-max flex-1 overflow-auto"
    >
      <m-main-table
        [isEdit]="false"
        [isFormat]="isFormat"
        [mconfig]="mconfig"
        [qData]="qData"
        [mconfigFields]="mconfig?.fields"
      ></m-main-table>
    </div>

    <div class="flex flex-row items-start">
      <m-bricks
        class="mt-7 flex max-h-[150px] max-w-max overflow-auto"
        *ngIf="mconfig?.filters.length > 0"
        [extendedFilters]="mconfig.extendedFilters"
        [listen]="ref.data.listen"
        [isKeepBackgroundColor]="false"
      ></m-bricks>
    </div>
  </div>

  <div
    *ngIf="
      isShowInit === false &&
      mconfig?.fields?.length > 0 &&
      isSelectValid === true &&
      mconfig?.chart.isValid === true
    "
    class="mt-10 flex h-full flex-grow flex-row overflow-auto"
    [ngClass]="{
      'justify-center':
        mconfig?.chart.type !== chartTypeEnumTable ||
        query?.status !== queryStatusCompleted,
      'justify-start':
        mconfig?.chart.type === chartTypeEnumTable &&
        query?.status === queryStatusCompleted
    }"
  >
    <m-chart-view
      class="h-full overflow-auto rounded pt-5"
      [ngClass]="{
        'aspect-[3/1] border border-gray-300':
          mconfig?.chart.type !== chartTypeEnumTable
      }"
      [mconfigFields]="mconfig?.fields"
      [qData]="qData"
      [chart]="mconfig?.chart"
      [queryStatus]="query?.status"
      [chartInstanceId]="'chart-dialog-mconfig-id-' + mconfig?.mconfigId"
    ></m-chart-view>
  </div>

  <div
    class="mt-7 flex cursor-default flex-row items-center justify-start"
    *ngIf="isShowInit === false && showNav === true"
  >
    <div class="text-base font-semibold text-gray-400">Model:</div>

    <ng-template #templateChartDialogModel>
      <div *ngIf="isExplorer === false">Explorer role required</div>
      <div *ngIf="isExplorer === true">No access to model</div>
    </ng-template>

    <div
      class="ml-2 flex flex-row items-center"
      [tp]="templateChartDialogModel"
      [tpIsEnabled]="canAccessModel === false"
    >
      <div
        (click)="goToModel(mconfig.modelId, canAccessModel)"
        class="text-base font-semibold focus:outline-none"
        [ngClass]="{
          'cursor-pointer hover:text-blue-500': canAccessModel === true,
          'cursor-default': canAccessModel === false
        }"
        >{{ mconfig?.modelLabel | capitalize }}</div
      >

      <m-lock-closed-icon
        class="mb-1 ml-2 text-gray-400"
        *ngIf="canAccessModel === false"
      ></m-lock-closed-icon>
    </div>

    <div class="ml-10 text-base font-semibold text-gray-400">Timezone:</div>

    <div class="ml-2 text-base text-gray-400 focus:outline-none">{{
      mconfig?.timezone | capitalize
    }}</div>
  </div>
</div>

<div *ngIf="isExplorer$ | async"></div>
