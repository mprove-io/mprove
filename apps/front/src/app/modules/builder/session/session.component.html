<div class="flex h-full w-full flex-col">
  <!-- Session title -->
  <ng-container *ngIf="session">
    <div class="mb-6 mt-6 flex h-11 flex-shrink-0 flex-row items-center">
      <span class="text-s1 ml-16 truncate text-lg font-medium">
        {{ sessionTitle }}
      </span>

      <div class="flex flex-1"></div>

      <button
        *ngIf="debugMode"
        type="button"
        class="border-s400 text-s500 hover:bg-s100 flex flex-shrink-0 select-none flex-row items-center rounded border p-4 py-2 focus:outline-none"
        (click)="copyEventsJson()"
      >
        <div>Copy JSON</div>
      </button>

      <button
        *ngIf="debugMode"
        type="button"
        class="text-s500 hover:bg-s100 ml-5 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded focus:outline-none"
        (click)="toggleAllEvents()"
      >
        <m-unfold-more-icon *ngIf="!allEventsExpanded"></m-unfold-more-icon>
        <m-unfold-less-icon *ngIf="allEventsExpanded"></m-unfold-less-icon>
      </button>

      <button
        *ngIf="session"
        type="button"
        class="ml-5 mr-3 flex flex-shrink-0 select-none flex-row items-center rounded px-3 py-2 text-base focus:outline-none"
        [ngClass]="{
          'bg-orange-100 text-orange-700': debugMode,
          'text-s500 hover:bg-s100': !debugMode
        }"
        (click)="toggleDebug()"
      >
        Debug
      </button>

      <div class="mr-12 flex-shrink-0">
        <button
          class="hover:bg-m200 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded focus:outline-none"
          #t1="tippy"
          [tp]="templateSessionOptions"
          [tpHideOnEscape]="true"
          tpVariation="menu"
          className="my-menu"
        >
          <m-dots-vertical-icon></m-dots-vertical-icon>
        </button>
      </div>
    </div>

    <div class="divide-s300 ml-6 mr-6 flex flex-col divide-y">
      <div class="flex flex-row"></div>
      <div class="flex flex-row"></div>
    </div>

    <ng-template #templateSessionOptions>
      <div class="border-s4 bg-m0 w-48 rounded-md border-2 shadow-xl">
        <button
          class="text-s1 hover:bg-m50 w-full px-4 py-2 text-left text-base focus:outline-none"
          [ngClass]="{
            'text-s400 cursor-default': session.status === 'New'
          }"
          [disabled]="session.status === 'New'"
          (click)="t1.hide(); openTitleEditor()"
          >Rename Session</button
        >
      </div>
    </ng-template>
  </ng-container>

  <!-- Messages area (chat view) -->
  <m-session-messages
    class="flex h-2 w-full flex-grow flex-col overflow-y-auto"
    *ngIf="!debugMode && showSessionMessages && !isSessionSwitching"
    [turns]="turns"
    [session]="session"
    [isActivating]="isActivating"
    [isWaitingForResponse]="isWaitingForResponse"
    [isSessionError]="isSessionError"
    [scrollTrigger]="scrollTrigger"
  ></m-session-messages>

  <div
    *ngIf="debugMode"
    class="thin-scrollbar ml-16 mr-[60px] flex-grow overflow-y-auto"
  >
    <m-session-debug-events
      [events]="events"
      [expandedEvents]="debugExpandedEvents"
      (expandedEventsChange)="debugExpandedEvents = $event"
    ></m-session-debug-events>
  </div>

  <!-- Permission dock -->
  <div
    *ngIf="permissions.length > 0"
    class="mx-auto flex w-full max-w-[860px] flex-shrink-0 flex-col gap-2 px-6 pb-2 pt-2"
  >
    <div class="rounded-lg border border-amber-300 bg-amber-50 px-4 py-3">
      <div class="text-sm font-medium text-amber-800">
        {{ permissions[0].permission }}
      </div>
      <div
        *ngIf="permissions[0].patterns?.length > 0"
        class="mt-1 text-xs text-amber-600"
      >
        Patterns: {{ permissions[0].patterns.join(', ') }}
      </div>
      <div class="mt-2 flex space-x-2">
        <button
          class="rounded-lg bg-red-600 px-3 py-1 text-sm text-white hover:bg-red-700"
          (click)="
            respondToPermission({
              permissionId: permissions[0].id,
              reply: 'reject'
            })
          "
        >
          Deny
        </button>
        <button
          class="rounded-lg bg-green-600 px-3 py-1 text-sm text-white hover:bg-green-700"
          (click)="
            respondToPermission({
              permissionId: permissions[0].id,
              reply: 'always'
            })
          "
        >
          Allow Always
        </button>
        <button
          class="rounded-lg border border-green-600 bg-white px-3 py-1 text-sm text-green-700 hover:bg-green-50"
          (click)="
            respondToPermission({
              permissionId: permissions[0].id,
              reply: 'once'
            })
          "
        >
          Allow Once
        </button>
      </div>
    </div>
  </div>

  <!-- Question dock -->
  <div
    *ngIf="questions.length > 0"
    class="mx-auto flex w-full max-w-[1084px] flex-shrink-0 flex-col gap-2 px-6 pb-2 pt-2"
  >
    <m-question-prompt
      [question]="questions[0]"
      (answer)="
        respondToQuestion({ questionId: questions[0].id, answers: $event })
      "
      (reject)="rejectQuestion({ questionId: questions[0].id })"
    ></m-question-prompt>
  </div>

  <!-- Input area (pinned to bottom) -->
  <div class="flex-shrink-0 px-6 pb-8 pt-[6px]">
    <div class="mx-auto flex max-w-[860px] items-start">
      <div class="w-5 flex-shrink-0 pt-[28px]">
        <div
          *ngIf="isWaitingForResponse"
          class="h-2.5 w-2.5 animate-pulse rounded-full bg-amber-300"
        ></div>
      </div>
      <div class="min-w-0 flex-1">
        <m-session-input
          [(model)]="model"
          [(agent)]="agent"
          [(variant)]="variant"
          [disabled]="isActivating"
          [showSelects]="messages.length > 0"
          [sessionId]="session?.sessionId"
          (send)="sendFollowUp($event)"
        ></m-session-input>
      </div>
      <div class="w-5 flex-shrink-0"></div>
    </div>
  </div>
</div>
<div *ngIf="sessionAndData$ | async"></div>
<div *ngIf="debugEvents$ | async"></div>
<div *ngIf="debugMode$ | async"></div>
<div *ngIf="showSessionMessages$ | async"></div>
