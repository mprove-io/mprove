<!-- Mode 1: Creation mode (no active session) -->
<div *ngIf="!isChatMode" class="flex h-full w-full flex-col items-center">
  <div class="h-[40%] flex-shrink-0"></div>
  <div class="flex w-full max-w-[860px] flex-col px-6">
    <div class="mb-10 flex justify-center">
      <img class="w-40" src="assets/logo/mprove_logo_web-01-b-gray.svg" />
    </div>

    <div
      class="overflow-hidden rounded-3xl border-[1.5px]"
      [ngClass]="{
        'border-s300 focus-within:border-s500': providerHasApiKey,
        'border-s200 bg-s100 opacity-60': !providerHasApiKey
      }"
    >
      <div class="thin-scrollbar mr-3 max-h-[400px] overflow-y-auto">
        <div class="flex w-full flex-row items-end pl-5 pr-2">
          <textarea
            class="text-s1 min-w-0 flex-1 resize-none overflow-y-hidden bg-transparent py-4 text-lg leading-relaxed placeholder-gray-400 [field-sizing:content] focus:outline-none"
            placeholder="Ask anything..."
            [(ngModel)]="messageText"
            (keydown)="onKeyDown($event)"
            [disabled]="isSubmitting || !providerHasApiKey"
            rows="1"
          ></textarea>

          <button
            class="sticky bottom-2 mb-2 ml-3 flex h-11 w-11 flex-shrink-0 items-center justify-center rounded-full focus:outline-none"
            [ngClass]="{
              'bg-m600 cursor-pointer':
                messageText.trim() && !isSubmitting && providerHasApiKey,
              'bg-s300 cursor-default':
                !messageText.trim() || isSubmitting || !providerHasApiKey
            }"
            (click)="sendMessage()"
            [disabled]="
              !messageText.trim() || isSubmitting || !providerHasApiKey
            "
          >
            <m-arrow-up-icon class="text-white"></m-arrow-up-icon>
          </button>
        </div>
      </div>
    </div>

    <div class="mt-8 flex flex-col items-center">
      <div class="flex flex-row items-center justify-center space-x-3">
        <ng-select
          class="session-agents-select w-[140px] select-none text-sm"
          [items]="agents"
          [clearable]="false"
          [searchable]="true"
          [searchFn]="agentsSearchFn"
          [(ngModel)]="agent"
          [disabled]="isSubmitting"
          appendTo="body"
          placeholder="Agent"
        ></ng-select>

        <ng-select
          class="w-[320px] select-none text-sm"
          [items]="models"
          bindLabel="label"
          bindValue="value"
          [clearable]="false"
          [searchable]="true"
          [searchFn]="modelsSearchFn"
          [loading]="modelsLoading"
          [(ngModel)]="model"
          (ngModelChange)="onModelChange()"
          (open)="openModelSelect()"
          [disabled]="isSubmitting"
          appendTo="body"
          placeholder="Model"
        >
          <ng-template ng-label-tmp let-item="item">
            <div class="ml-1 truncate">
              <span>{{ item.modelId }}</span>
              <span *ngIf="item.providerName" class="text-s400 ml-3 mr-2">{{
                item.providerName
              }}</span>
            </div>
          </ng-template>

          <ng-template ng-option-tmp let-item="item">
            <div class="ml-1 truncate">
              <span>{{ item.modelId }}</span>
              <span *ngIf="item.providerName" class="text-s400 ml-3 mr-2">{{
                item.providerName
              }}</span>
            </div>
          </ng-template>
        </ng-select>

        <ng-select
          class="session-variants-select w-[140px] select-none text-sm"
          [items]="variants"
          [clearable]="false"
          [searchable]="true"
          [searchFn]="variantsSearchFn"
          [(ngModel)]="variant"
          [disabled]="isSubmitting"
          appendTo="body"
          placeholder="Thinking"
        ></ng-select>
      </div>

      <div
        *ngIf="!providerHasApiKey"
        class="mt-5 text-center text-base text-red-500"
        >This provider requires an API key (see Project Settings)</div
      >
    </div>
  </div>
</div>

<!-- Mode 2: Chat mode (active session with messages) -->
<div *ngIf="isChatMode" class="flex h-full w-full flex-col">
  <!-- Messages area (chat view) -->
  <m-session-messages
    class="flex h-2 w-full flex-grow flex-col overflow-y-auto"
    *ngIf="!debugMode && showSessionMessages"
    [turns]="turns"
    [session]="session"
    [isActivating]="isActivating"
    [isWaitingForResponse]="isWaitingForResponse"
    [isSessionError]="isSessionError"
    [scrollTrigger]="scrollTrigger"
    (permissionResponse)="respondToPermission($event)"
  ></m-session-messages>

  <!-- Debug events view -->
  <div *ngIf="debugMode" class="thin-scrollbar flex-grow overflow-y-auto">
    <m-session-debug-events [events]="events"></m-session-debug-events>
  </div>

  <!-- Input area (pinned to bottom) -->
  <div class="flex-shrink-0 px-6 pb-8 pt-[6px]">
    <div class="mx-auto max-w-[860px]">
      <div
        *ngIf="!providerHasApiKey"
        class="mb-2 text-center text-base text-red-500"
        >This provider requires an API key (see Project Settings)</div
      >

      <div
        class="overflow-hidden rounded-3xl border-[1.5px]"
        [ngClass]="{
          'border-s300 focus-within:border-s500': !isActivating,
          'border-s200 bg-s100 opacity-60': isActivating
        }"
      >
        <div class="flex w-full flex-row items-end pl-5 pr-2">
          <textarea
            class="text-s1 min-w-0 flex-1 resize-none overflow-y-hidden bg-transparent py-4 text-lg leading-relaxed placeholder-gray-400 [field-sizing:content] focus:outline-none"
            placeholder="Ask anything..."
            [(ngModel)]="messageText"
            (keydown)="onKeyDown($event)"
            [disabled]="isActivating"
            rows="1"
          ></textarea>

          <button
            class="sticky bottom-2 mb-2 ml-3 flex h-11 w-11 flex-shrink-0 items-center justify-center rounded-full focus:outline-none"
            [ngClass]="{
              'bg-m600 cursor-pointer': messageText.trim() && !isActivating,
              'bg-s300 cursor-default': !messageText.trim() || isActivating
            }"
            (click)="sendFollowUp()"
            [disabled]="!messageText.trim() || isActivating"
          >
            <m-arrow-up-icon class="text-white"></m-arrow-up-icon>
          </button>
        </div>
      </div>

      <div
        *ngIf="messages.length > 0"
        class="mt-4 flex flex-row items-center justify-center space-x-3"
      >
        <ng-select
          class="session-agents-select w-[140px] select-none text-sm"
          [items]="agents"
          [clearable]="false"
          [searchable]="true"
          [searchFn]="agentsSearchFn"
          [(ngModel)]="agent"
          appendTo="body"
          placeholder="Agent"
        ></ng-select>

        <ng-select
          class="session-models-select w-[320px] select-none text-sm"
          [items]="models"
          bindLabel="label"
          bindValue="value"
          [clearable]="false"
          [searchable]="true"
          [searchFn]="modelsSearchFn"
          [loading]="modelsLoading"
          [(ngModel)]="model"
          (ngModelChange)="onModelChange()"
          (open)="openModelSelect()"
          appendTo="body"
          placeholder="Model"
        >
          <ng-template ng-label-tmp let-item="item">
            <div class="ml-1 truncate">
              <span>{{ item.modelId }}</span>
              <span *ngIf="item.providerName" class="text-s400 ml-3 mr-2">{{
                item.providerName
              }}</span>
            </div>
          </ng-template>

          <ng-template ng-option-tmp let-item="item">
            <div class="ml-1 truncate">
              <span>{{ item.modelId }}</span>
              <span *ngIf="item.providerName" class="text-s400 ml-3 mr-2">{{
                item.providerName
              }}</span>
            </div>
          </ng-template>
        </ng-select>

        <ng-select
          class="session-variants-select w-[140px] select-none text-sm"
          [items]="variants"
          [clearable]="false"
          [searchable]="true"
          [searchFn]="variantsSearchFn"
          [(ngModel)]="variant"
          appendTo="body"
          placeholder="Thinking"
        ></ng-select>
      </div>
    </div>
  </div>
</div>
<div *ngIf="sessionAndEvents$ | async"></div>
<div *ngIf="debugMode$ | async"></div>
<div *ngIf="showSessionMessages$ | async"></div>
