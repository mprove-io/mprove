<div class="flex h-full w-full flex-col">
  <!-- Messages area (chat view) -->
  <div
    *ngIf="!debugMode"
    class="mt-0.5 flex h-2 w-full flex-grow flex-col overflow-y-auto"
  >
    <m-session-messages
      class="h-full w-full"
      *ngIf="showSessionMessages && !isSessionSwitching"
      [turns]="turns"
      [session]="session"
      [isActivating]="isActivating"
      [isArchived]="isArchived"
      [isWaitingForResponse]="isWaitingForResponse"
      [retryMessage]="retryMessage"
      [isSessionError]="isSessionError"
      [scrollTrigger]="scrollTrigger"
    ></m-session-messages>
  </div>

  <div
    *ngIf="debugMode"
    class="thin-scrollbar ml-16 mr-[60px] flex-grow overflow-y-auto"
  >
    <m-session-debug-events
      [events]="events"
      [expandedEvents]="debugExpandedEvents"
      (expandedEventsChange)="debugExpandedEvents = $event"
    ></m-session-debug-events>
  </div>

  <!-- Permission dock -->
  <div
    *ngIf="permissions.length > 0 && !isArchived"
    class="mx-auto mb-8 flex w-full max-w-[976px] flex-shrink-0 flex-col gap-2 px-6 pb-2 pt-2"
  >
    <div class="border-s300 flex flex-col rounded-lg border bg-white">
      <div class="px-5 py-4">
        <div class="text-s500 mb-1 text-[15px] font-normal">
          Permission request
        </div>
        <div class="text-s1 text-lg font-medium">
          {{ permissions[0].permission }}
        </div>
        <div
          *ngIf="permissions[0].patterns?.length > 0"
          class="text-s500 mt-1 text-base font-normal"
        >
          {{ permissions[0].patterns.join(', ') }}
        </div>
      </div>
      <div
        class="border-s200 flex items-center justify-end gap-3 border-t px-5 py-3"
      >
        <button
          type="button"
          class="text-s500 hover:text-s1 rounded px-4 py-2 text-[17px] focus:outline-none"
          (click)="
            respondToPermission({
              permissionId: permissions[0].id,
              reply: 'reject'
            })
          "
        >
          Deny
        </button>
        <button
          type="button"
          class="border-m600 text-m600 rounded border px-4 py-2 text-[17px] hover:opacity-90 focus:outline-none"
          (click)="
            respondToPermission({
              permissionId: permissions[0].id,
              reply: 'once'
            })
          "
        >
          Allow Once
        </button>
        <button
          type="button"
          class="bg-m600 rounded px-4 py-2 text-[17px] text-white hover:opacity-90 focus:outline-none"
          (click)="
            respondToPermission({
              permissionId: permissions[0].id,
              reply: 'always'
            })
          "
        >
          Allow Always
        </button>
      </div>
    </div>
  </div>

  <!-- Question dock -->
  <div
    *ngIf="questions.length > 0 && !isArchived"
    class="mx-auto mb-8 flex w-full max-w-[976px] flex-shrink-0 flex-col gap-2 px-6 pb-2 pt-2"
  >
    <m-question-prompt
      [question]="questions[0]"
      (answer)="
        respondToQuestion({ questionId: questions[0].id, answers: $event })
      "
      (reject)="rejectQuestion({ questionId: questions[0].id })"
    ></m-question-prompt>
  </div>

  <!-- Archived session message -->
  <div *ngIf="isArchived" class="flex-shrink-0 px-6 pb-8 pt-[6px]">
    <div class="mx-auto flex max-w-[860px] items-center justify-center">
      <div class="text-s400 py-4 text-lg">{{
        archivedReason === archivedReasonEnum.Expire
          ? 'Session is archived (sandbox expired)'
          : 'Session is archived by User'
      }}</div>
    </div>
  </div>

  <!-- Input area (pinned to bottom, hidden when docks are active) -->
  <div
    *ngIf="permissions.length === 0 && questions.length === 0 && !isArchived"
    class="relative flex-shrink-0 px-6 pb-8 pt-[6px]"
  >
    <!-- Status text to the left of input -->
    <div
      class="absolute bottom-0 left-[104px] top-0 flex items-start whitespace-nowrap pt-[18px]"
      [tp]="statusTooltip"
      [tpIsEnabled]="!!statusTooltip"
    >
      <span class="text-shimmer text-base font-semibold leading-[1.5]"
        ><span
          *ngFor="let ch of statusTextChars; trackBy: trackByIndex"
          class="text-shimmer-char"
          [style.--text-shimmer-index]="ch.index"
          >{{ ch.char }}</span
        ></span
      >
    </div>
    <div class="mx-auto max-w-[860px]">
      <div class="flex items-start">
        <div class="mr-3 w-3 flex-shrink-0"></div>
        <div class="min-w-0 flex-1">
          <m-session-input
            [(model)]="model"
            [(agent)]="agent"
            [(variant)]="variant"
            [disabled]="isActivating || isSessionError"
            [isWaitingForResponse]="isAgentBusy"
            [showSelects]="messages.length > 0"
            [sessionId]="session?.sessionId"
            (send)="sendFollowUp($event)"
            (stop)="abortSession()"
          ></m-session-input>
        </div>
        <div class="ml-3 w-3 flex-shrink-0"></div>
      </div>
    </div>
  </div>
</div>
<div *ngIf="sessionAndData$ | async"></div>
<div *ngIf="debugEvents$ | async"></div>
<div *ngIf="debugMode$ | async"></div>
<div *ngIf="showSessionMessages$ | async"></div>
<div *ngIf="toggleAllEvents$ | async"></div>
