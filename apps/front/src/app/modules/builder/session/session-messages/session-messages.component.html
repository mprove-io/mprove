<div class="relative h-full w-full">
  <ng-scrollbar
    #chatScroll
    class="h-full"
    [orientation]="'vertical'"
    [visibility]="'hover'"
    [appearance]="'compact'"
  >
    <div class="px-12 pb-4 pt-12">
      <div class="mx-auto flex min-h-full flex-col">
        <!-- First message from session (before events arrive) -->
        <ng-container *ngIf="turns.length === 0 && session?.firstMessage">
          <div class="user-message mb-4 mr-5">
            <div class="flex justify-end">
              <div
                class="border-s200 bg-s100 max-w-[90%] rounded-2xl border px-5 py-3"
              >
                <div
                  class="text-s1 whitespace-pre-wrap break-words text-[17px]"
                  >{{ session.firstMessage }}</div
                >
              </div>
            </div>
          </div>
          <div class="response-div" [style.min-height.px]="responseMinHeight">
            <div *ngIf="isActivating" class="mb-4 flex justify-start">
              <div class="rounded-2xl px-4 py-3">
                <span class="text-s500 text-[17px]">Activating session...</span>
              </div>
            </div>
            <div *ngIf="isWaitingForResponse" class="mb-4 px-4 py-3">
              <span class="text-lg text-amber-500">{{
                retryMessage || 'Working'
              }}</span>
            </div>
            <div *ngIf="isSessionError" class="mb-4 flex justify-start">
              <div class="max-w-[90%] rounded-2xl bg-red-50 px-4 py-3">
                <div class="break-words text-[17px] text-red-700">
                  Session activation failed. Please try again.
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Turn-based message rendering -->
        <ng-container
          *ngFor="let turn of turns; let isLast = last; let turnIndex = index"
        >
          <!-- User message -->
          <div *ngIf="turn.userMessage" class="user-message mb-4 mr-5">
            <div class="flex justify-end">
              <div
                class="border-s200 bg-s100 max-w-[90%] rounded-2xl border px-5 py-3"
              >
                <div
                  class="text-s1 whitespace-pre-wrap break-words text-[17px]"
                  >{{ turn.userMessage.text }}</div
                >
              </div>
            </div>
            <!-- Meta info: agent / model / variant -->
            <div
              *ngIf="turn.userMessage.agentName || turn.userMessage.modelId"
              class="mt-1 flex justify-end"
            >
              <span class="text-s500 text-[15px]">{{
                getMetaText(turn.userMessage)
              }}</span>
            </div>
          </div>

          <!-- Response div wrapping all non-user content for this turn -->
          <div
            class="response-div"
            [style.min-height.px]="isLast ? responseMinHeight : 0"
          >
            <div *ngFor="let msg of turn.responses" class="mb-4">
              <!-- Agent message -->
              <div *ngIf="msg.role === 'agent'" class="flex justify-start">
                <div class="max-w-[90%] rounded-2xl px-4 py-3">
                  <div
                    class="text-s1 whitespace-pre-wrap break-words text-[17px]"
                    >{{ msg.text }}</div
                  >
                </div>
              </div>

              <!-- Tool call (rich rendering) -->
              <div
                *ngIf="msg.role === 'tool' && msg.toolPart"
                class="flex justify-start"
              >
                <div
                  class="ml-4 max-w-[90%] overflow-hidden rounded-lg border"
                  [ngClass]="{
                    'border-red-300 bg-red-50':
                      msg.toolPart.state?.status === 'error' &&
                      msg.toolPart.tool !== 'ask_user_question',
                    'border-s200':
                      msg.toolPart.state?.status !== 'error' ||
                      msg.toolPart.tool === 'ask_user_question'
                  }"
                >
                  <!-- Tool header -->
                  <button
                    class="flex w-full items-center gap-2 px-3 py-2 text-left focus:outline-none"
                    [disabled]="!getToolOutput(msg.toolPart)"
                    (click)="openToolOutput(msg.toolPart)"
                  >
                    <!-- Status dot -->
                    <span
                      class="h-2 w-2 flex-shrink-0 rounded-full"
                      [ngClass]="{
                        'bg-amber-400':
                          msg.toolPart.state?.status === 'pending' ||
                          msg.toolPart.state?.status === 'running',
                        'bg-green-500':
                          msg.toolPart.state?.status === 'completed',
                        'bg-red-500': msg.toolPart.state?.status === 'error'
                      }"
                    ></span>

                    <!-- Tool title -->
                    <span class="text-s1 text-base font-medium">{{
                      getToolTitle(msg.toolPart.tool)
                    }}</span>

                    <!-- Subtitle -->
                    <span
                      *ngIf="getToolSubtitle(msg.toolPart)"
                      class="text-s500 min-w-0 flex-1 truncate text-base"
                      >{{ getToolSubtitle(msg.toolPart) }}</span
                    >
                  </button>
                </div>
              </div>

              <!-- Tool call (fallback without toolPart) -->
              <div
                *ngIf="msg.role === 'tool' && !msg.toolPart"
                class="flex justify-start"
              >
                <div
                  class="border-s200 ml-4 max-w-[90%] rounded-lg border px-3 py-2"
                >
                  <div class="text-s600 break-words text-[17px]">{{
                    msg.text
                  }}</div>
                </div>
              </div>

              <!-- Thought -->
              <div *ngIf="msg.role === 'thought'" class="flex justify-start">
                <div class="max-w-[90%] rounded-2xl px-4 py-2">
                  <div
                    class="text-s500 whitespace-pre-wrap break-words text-[17px]"
                    >{{ msg.text }}</div
                  >
                </div>
              </div>

              <!-- Error -->
              <div *ngIf="msg.role === 'error'" class="flex justify-start">
                <div class="max-w-[90%] rounded-2xl bg-red-50 px-4 py-3">
                  <div class="break-words text-[17px] text-red-700">{{
                    msg.text
                  }}</div>
                </div>
              </div>
            </div>

            <!-- File changes summary -->
            <div
              *ngIf="turn.fileDiffs?.length > 0"
              class="mb-4 flex justify-start"
            >
              <div
                class="border-s200 ml-4 max-w-[90%] overflow-hidden rounded-lg border"
              >
                <button
                  class="flex w-full items-center gap-2 px-3 py-2 text-left focus:outline-none"
                  (click)="openFileDiffs(turn.fileDiffs)"
                >
                  <span
                    class="h-2 w-2 flex-shrink-0 rounded-full bg-blue-500"
                  ></span>
                  <span class="text-s1 text-base font-medium">Modified</span>
                  <span class="text-s500 text-base"
                    >{{ turn.fileDiffs.length }}
                    {{ turn.fileDiffs.length === 1 ? 'file' : 'files' }}</span
                  >
                  <span class="text-s500 flex items-center gap-1 text-sm">
                    <span class="text-green-600"
                      >+{{ getTotalAdditions(turn.fileDiffs) }}</span
                    >
                    <span class="text-red-600"
                      >-{{ getTotalDeletions(turn.fileDiffs) }}</span
                    >
                  </span>
                </button>
              </div>
            </div>

            <!-- Indicators only in the last turn -->
            <ng-container *ngIf="isLast">
              <div *ngIf="isActivating" class="mb-4 flex justify-start">
                <div class="rounded-2xl px-4 py-3">
                  <span class="text-s500 text-[17px]"
                    >Activating session...</span
                  >
                </div>
              </div>
              <div *ngIf="isWaitingForResponse" class="mb-4 px-4 py-3">
                <span class="text-lg text-amber-500">{{
                  retryMessage || 'Working'
                }}</span>
              </div>
              <div *ngIf="isSessionError" class="mb-4 flex justify-start">
                <div class="max-w-[90%] rounded-2xl bg-red-50 px-4 py-3">
                  <div class="break-words text-[17px] text-red-700">
                    Session activation failed. Please try again.
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </ng-container>

        <!-- No messages state -->
        <div
          *ngIf="
            turns.length === 0 &&
            !session?.firstMessage &&
            !isActivating &&
            !isSessionError
          "
          class="text-s500 flex items-center justify-center py-8 text-[17px]"
        >
          No messages yet
        </div>

        <div class="flex-grow"></div>
      </div>
    </div>
  </ng-scrollbar>

  <!-- Scroll to bottom button -->
  <div
    class="pointer-events-none absolute bottom-6 left-1/2 z-[60] -translate-x-1/2 transition-all duration-200 ease-out"
    [ngClass]="{
      'translate-y-0 scale-100 opacity-100': isOverflowing && !isAtBottom,
      'translate-y-2 scale-95 opacity-0': !isOverflowing || isAtBottom
    }"
  >
    <button
      type="button"
      class="border-s200 hover:bg-s100 pointer-events-auto flex h-11 w-11 items-center justify-center rounded-full border bg-white shadow-md transition-colors"
      (click)="scrollToBottom()"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="text-s500"
      >
        <path d="M12 5v14" />
        <path d="m19 12-7 7-7-7" />
        <path d="M5 19h14" />
      </svg>
    </button>
  </div>
</div>
