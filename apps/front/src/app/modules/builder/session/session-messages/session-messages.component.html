<ng-scrollbar
  #chatScroll
  [orientation]="'vertical'"
  [visibility]="'hover'"
  [appearance]="'compact'"
>
  <div class="px-12 pb-4 pt-12">
    <div class="mx-auto flex min-h-full flex-col">
      <!-- First message from session (before events arrive) -->
      <ng-container *ngIf="turns.length === 0 && session?.firstMessage">
        <div class="user-message mb-4">
          <div class="flex justify-end">
            <div class="bg-s100 max-w-[90%] rounded-2xl px-4 py-3">
              <div
                class="text-s1 whitespace-pre-wrap break-words text-[17px]"
                >{{ session.firstMessage }}</div
              >
            </div>
          </div>
        </div>
        <div class="response-div" [style.min-height.px]="responseMinHeight">
          <div *ngIf="isActivating" class="mb-4 flex justify-start">
            <div class="rounded-2xl px-4 py-3">
              <span class="text-s500 text-[17px]">Activating session...</span>
            </div>
          </div>
          <div *ngIf="isWaitingForResponse" class="mb-4 px-4 py-3">
            <span class="text-lg text-amber-500">{{
              retryMessage || 'Working'
            }}</span>
          </div>
          <div *ngIf="isSessionError" class="mb-4 flex justify-start">
            <div class="max-w-[90%] rounded-2xl bg-red-50 px-4 py-3">
              <div class="break-words text-[17px] text-red-700">
                Session activation failed. Please try again.
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- Turn-based message rendering -->
      <ng-container *ngFor="let turn of turns; let isLast = last">
        <!-- User message -->
        <div *ngIf="turn.userMessage" class="user-message mb-4">
          <div class="flex justify-end">
            <div class="bg-s100 max-w-[90%] rounded-2xl px-4 py-3">
              <div
                class="text-s1 whitespace-pre-wrap break-words text-[17px]"
                >{{ turn.userMessage.text }}</div
              >
            </div>
          </div>
        </div>

        <!-- Response div wrapping all non-user content for this turn -->
        <div
          class="response-div"
          [style.min-height.px]="isLast ? responseMinHeight : 0"
        >
          <div *ngFor="let msg of turn.responses" class="mb-4">
            <!-- Agent message -->
            <div *ngIf="msg.role === 'agent'" class="flex justify-start">
              <div class="max-w-[90%] rounded-2xl px-4 py-3">
                <div
                  class="text-s1 whitespace-pre-wrap break-words text-[17px]"
                  >{{ msg.text }}</div
                >
              </div>
            </div>

            <!-- Tool call (rich rendering) -->
            <div
              *ngIf="msg.role === 'tool' && msg.toolPart"
              class="flex justify-start"
            >
              <div
                class="max-w-[90%] overflow-hidden rounded-lg border"
                [ngClass]="{
                  'border-red-300 bg-red-50':
                    msg.toolPart.state?.status === 'error',
                  'border-s200': msg.toolPart.state?.status !== 'error'
                }"
              >
                <!-- Tool header -->
                <button
                  class="flex w-full items-center gap-2 px-3 py-2 text-left focus:outline-none"
                  (click)="toggleToolCollapse(msg.toolPart.id)"
                >
                  <!-- Status dot -->
                  <span
                    class="h-2 w-2 flex-shrink-0 rounded-full"
                    [ngClass]="{
                      'bg-amber-400':
                        msg.toolPart.state?.status === 'pending' ||
                        msg.toolPart.state?.status === 'running',
                      'bg-green-500':
                        msg.toolPart.state?.status === 'completed',
                      'bg-red-500': msg.toolPart.state?.status === 'error'
                    }"
                  ></span>

                  <!-- Tool title -->
                  <span class="text-s1 text-base font-medium">{{
                    getToolTitle(msg.toolPart.tool)
                  }}</span>

                  <!-- Subtitle -->
                  <span
                    *ngIf="getToolSubtitle(msg.toolPart)"
                    class="text-s500 min-w-0 flex-1 truncate text-base"
                    >{{ getToolSubtitle(msg.toolPart) }}</span
                  >

                  <!-- Collapse chevron -->
                  <span
                    class="text-s400 ml-auto flex-shrink-0 text-xs transition-transform"
                    [ngClass]="{
                      'rotate-90': !isToolCollapsed(msg.toolPart.id)
                    }"
                    >&#9654;</span
                  >
                </button>

                <!-- Collapsible output -->
                <div
                  *ngIf="
                    !isToolCollapsed(msg.toolPart.id) &&
                    getToolOutput(msg.toolPart)
                  "
                  class="border-s200 max-h-[300px] overflow-auto border-t px-3 py-2"
                >
                  <pre
                    class="text-s600 whitespace-pre-wrap break-all font-mono text-sm"
                    >{{ getToolOutput(msg.toolPart) }}</pre
                  >
                </div>
              </div>
            </div>

            <!-- Tool call (fallback without toolPart) -->
            <div
              *ngIf="msg.role === 'tool' && !msg.toolPart"
              class="flex justify-start"
            >
              <div class="border-s200 max-w-[90%] rounded-lg border px-3 py-2">
                <div class="text-s600 break-words text-[17px]">{{
                  msg.text
                }}</div>
              </div>
            </div>

            <!-- Thought -->
            <div *ngIf="msg.role === 'thought'" class="flex justify-start">
              <div class="max-w-[90%] rounded-2xl px-4 py-2">
                <div
                  class="text-s500 whitespace-pre-wrap break-words text-[17px] italic"
                  >{{ msg.text }}</div
                >
              </div>
            </div>

            <!-- Error -->
            <div *ngIf="msg.role === 'error'" class="flex justify-start">
              <div class="max-w-[90%] rounded-2xl bg-red-50 px-4 py-3">
                <div class="break-words text-[17px] text-red-700">{{
                  msg.text
                }}</div>
              </div>
            </div>
          </div>

          <!-- Indicators only in the last turn -->
          <ng-container *ngIf="isLast">
            <div *ngIf="isActivating" class="mb-4 flex justify-start">
              <div class="rounded-2xl px-4 py-3">
                <span class="text-s500 text-[17px]">Activating session...</span>
              </div>
            </div>
            <div *ngIf="isWaitingForResponse" class="mb-4 px-4 py-3">
              <span class="text-lg text-amber-500">{{
                retryMessage || 'Working'
              }}</span>
            </div>
            <div *ngIf="isSessionError" class="mb-4 flex justify-start">
              <div class="max-w-[90%] rounded-2xl bg-red-50 px-4 py-3">
                <div class="break-words text-[17px] text-red-700">
                  Session activation failed. Please try again.
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </ng-container>

      <!-- No messages state -->
      <div
        *ngIf="
          turns.length === 0 &&
          !session?.firstMessage &&
          !isActivating &&
          !isSessionError
        "
        class="text-s500 flex items-center justify-center py-8 text-[17px]"
      >
        No messages yet
      </div>

      <div class="flex-grow"></div>
    </div>
  </div>
</ng-scrollbar>
