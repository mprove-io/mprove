<div *ngIf="!providerHasApiKey" class="mb-2 text-center text-base text-red-500"
  >This provider requires an API key (see Project Settings)</div
>

<div
  class="overflow-hidden rounded-3xl border-[1.5px]"
  [ngClass]="{
    'border-s300 focus-within:border-s500': !effectiveDisabled,
    'border-s200 bg-s100': effectiveDisabled
  }"
>
  <ng-scrollbar
    [orientation]="'vertical'"
    [visibility]="'hover'"
    [appearance]="'compact'"
    class="max-h-[400px]"
  >
    <div class="flex w-full flex-row items-end pl-5 pr-2">
      <textarea
        class="text-s1 min-w-0 flex-1 resize-none bg-transparent py-4 text-lg leading-relaxed placeholder-gray-400 [field-sizing:content] focus:outline-none"
        placeholder="Ask anything..."
        [(ngModel)]="messageText"
        (keydown)="onKeyDown($event)"
        [disabled]="effectiveDisabled"
        rows="1"
      ></textarea>

      <button
        class="sticky bottom-2 mb-2 ml-3 flex h-11 w-11 flex-shrink-0 items-center justify-center rounded-full focus:outline-none"
        [ngClass]="{
          'bg-m600 cursor-pointer':
            (isWaitingForResponse && !messageText.trim()) ||
            (messageText.trim() && !effectiveDisabled),
          'bg-s300 cursor-default':
            !(isWaitingForResponse && !messageText.trim()) &&
            (!messageText.trim() || effectiveDisabled)
        }"
        (click)="
          isWaitingForResponse && !messageText.trim() ? onStop() : onSend()
        "
        [disabled]="
          !(isWaitingForResponse && !messageText.trim()) &&
          (!messageText.trim() || effectiveDisabled)
        "
      >
        <m-stop-icon
          *ngIf="isWaitingForResponse && !messageText.trim()"
          class="text-white"
        ></m-stop-icon>
        <m-arrow-up-icon
          *ngIf="!(isWaitingForResponse && !messageText.trim())"
          class="text-white"
        ></m-arrow-up-icon>
      </button>
    </div>
  </ng-scrollbar>
</div>

<div
  *ngIf="showSelects"
  class="mt-4 flex flex-row items-center justify-center space-x-3"
>
  <div *ngIf="showAutoScroll" class="h-8 w-8 flex-shrink-0"></div>

  <ng-select
    class="session-agents-select w-[140px] select-none text-base"
    [items]="agents"
    [clearable]="false"
    [searchable]="true"
    [searchFn]="agentsSearchFn"
    [(ngModel)]="agent"
    (ngModelChange)="onAgentSelect()"
    [disabled]="disabled"
    appendTo="body"
    placeholder="Agent"
  ></ng-select>

  <ng-select
    class="session-models-select w-[320px] select-none text-base"
    [items]="models"
    bindLabel="label"
    bindValue="value"
    [clearable]="false"
    [searchable]="true"
    [searchFn]="modelsSearchFn"
    [loading]="modelsLoading"
    [(ngModel)]="model"
    (ngModelChange)="onModelSelect()"
    (open)="openModelSelect()"
    [disabled]="disabled"
    appendTo="body"
    placeholder="Model"
  >
    <ng-template ng-label-tmp let-item="item">
      <div class="ml-1 truncate">
        <span>{{ item.modelId }}</span>
        <span *ngIf="item.providerName" class="text-s400 ml-3 mr-2">{{
          item.providerName
        }}</span>
      </div>
    </ng-template>

    <ng-template ng-option-tmp let-item="item">
      <div class="ml-1 truncate">
        <span>{{ item.modelId }}</span>
        <span *ngIf="item.providerName" class="text-s400 ml-3 mr-2">{{
          item.providerName
        }}</span>
      </div>
    </ng-template>
  </ng-select>

  <ng-select
    class="session-variants-select w-[140px] select-none text-base"
    [items]="variants"
    [clearable]="false"
    [searchable]="true"
    [searchFn]="variantsSearchFn"
    [(ngModel)]="variant"
    (ngModelChange)="onVariantSelect()"
    [disabled]="disabled"
    appendTo="body"
    placeholder="Thinking"
  ></ng-select>

  <button
    *ngIf="showAutoScroll"
    type="button"
    class="hover:bg-s100 flex h-8 w-8 flex-shrink-0 items-center justify-center rounded transition-colors focus:outline-none"
    [ngClass]="{
      'text-m600': autoScroll,
      'text-s300': !autoScroll
    }"
    (click)="onAutoScrollToggle()"
    [title]="autoScroll ? 'Auto-scroll on' : 'Auto-scroll off'"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="M12 5v14" />
      <path d="m19 12-7 7-7-7" />
    </svg>
  </button>
</div>
