<div class="bg-blue1 flex flex-col h-full">
  <div class="flex flex-row h-full">
    <div class="flex flex-col flex-grow mx-6 mb-6 mt-8 min-w-[2px]">
      <div class="flex flex-row justify-between items-center h-11">
        <div class="flex flex-row items-center w-full">
          <div class="flex flex-row items-center space-x-5">
            <div
              data-cy="dashboardTitle"
              class="flex font-semibold text-2xl text-gray1 items-center self-center"
            >
              {{ pageTitle }}
            </div>

            <div class="text-xl text-gray1">{{
              (dashboard?.title ? dashboard?.title : dashboard?.dashboardId)
                | capitalize
            }}</div>
          </div>

          <div class="flex flex-row items-center space-x-5">
            <ui-switch
              class="ml-5"
              [checked]="showBricks"
              (change)="toggleShowReportFilters()"
            ></ui-switch>

            <div class="flex h-9 text-gray1 text-base items-center select-none"
              >Show Report Filters</div
            >
          </div>

          <ng-template #templateAddReport>
            <div *ngIf="isExplorer === false">Explorer role is required</div>

            <div *ngIf="isExplorer === true && dashboard?.temp === true"
              >Save changes to be able to add reports</div
            >

            <div
              *ngIf="
                isExplorer === true &&
                dashboard?.temp === false &&
                dashboard?.canEditOrDeleteDashboard === false
              "
              >Only the dashboard author, project editors, and administrators
              can edit this dashboard. Try saving this dashboard as a new one to
              become an author.</div
            >
          </ng-template>

          <div
            [tippy]="templateAddReport"
            [isEnabled]="
              isExplorer === false ||
              dashboard?.temp === true ||
              dashboard?.canEditOrDeleteDashboard === false
            "
            class="ml-5"
          >
            <button
              type="button"
              data-cy="dashboardAddReportButton"
              class="px-5 py-2 ml-5 text-white text-base rounded font-medium focus:outline-none"
              [ngClass]="{
                'bg-blue3':
                  isExplorer === true &&
                  dashboard?.temp === false &&
                  dashboard?.canEditOrDeleteDashboard === true,
                'bg-gray-400 cursor-default':
                  isExplorer === false ||
                  dashboard?.temp === true ||
                  dashboard?.canEditOrDeleteDashboard === false
              }"
              (click)="addReport()"
              [disabled]="
                isExplorer === false ||
                dashboard?.temp === true ||
                dashboard?.canEditOrDeleteDashboard === false
              "
              >Add Report</button
            >
          </div>

          <div class="flex-grow"></div>

          <div class="flex flex-row items-center space-x-5">
            <div class="flex h-9 text-gray1 text-base items-center select-none"
              >Timezone</div
            >

            <form [formGroup]="timezoneForm">
              <ng-select
                data-cy="dashboardTimezoneSelect"
                class="custom w-96 text-base focus:outline-none"
                [items]="timezones"
                [clearable]="false"
                (change)="timezoneChange()"
                placeholder="Reports have different timezones"
                appendTo="body"
                bindLabel="label"
                bindValue="value"
                formControlName="timezone"
              >
                <ng-template ng-label-tmp let-item="item">
                  <div class="flex">{{ item.label }}</div>
                </ng-template>

                <ng-template ng-option-tmp let-item="item">
                  <div class="flex">{{ item.label }}</div>
                </ng-template>
              </ng-select>
            </form>
          </div>

          <!-- <div class="flex-grow"></div> -->

          <div class="flex flex-row items-center text-base text-gray1">
            <div
              class="ml-16 h-12"
              tippy="Explorer role is required"
              [isEnabled]="isExplorer === false"
            >
              <button
                type="button"
                data-cy="dashboardSaveAsButton"
                class="px-6 h-12 text-base rounded font-medium focus:outline-none"
                [ngClass]="{
                  'text-blue3 border-2':
                    isExplorer === true && dashboard?.temp === false,
                  'text-white bg-pink-500':
                    isExplorer === true && dashboard?.temp === true,
                  'bg-gray-400 text-white cursor-default': isExplorer === false
                }"
                (click)="saveAs()"
                [disabled]="isExplorer === false"
                >Save As</button
              >
            </div>

            <button
              type="button"
              data-cy="dashboardRunButton"
              class="px-8 py-2 ml-5 text-white text-base rounded font-medium focus:outline-none"
              [ngClass]="{
                'bg-blue3': dashboard?.reports.length > 0,
                'bg-gray-400 cursor-default': dashboard?.reports.length === 0
              }"
              (click)="run()"
              [disabled]="dashboard?.reports.length === 0"
              >Run</button
            >

            <div class="relative ml-5">
              <m-dashboard-options
                [dashboard]="dashboard"
              ></m-dashboard-options>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col flex-grow space-y-6 min-w-[2px] mt-6">
        <div class="bg-white rounded shadow-md w-full">
          <div class="flex flex-col">
            <div
              class="flex flex-row flex-grow mr-5 min-h-[95px] flex-shrink-0"
            >
              <button
                type="button"
                data-cy="dashboardAddFilterButton"
                class="mt-6 h-12 ml-8 text-blue3 text-base rounded font-medium focus:outline-none"
                (click)="addFilter()"
                >Add Filter</button
              >

              <ng-template #templateEditListeners>
                <div *ngIf="dashboard?.reports.length === 0">No reports</div>
                <div *ngIf="dashboard?.fields.length === 0">No filters</div>
              </ng-template>

              <div
                [tippy]="templateEditListeners"
                [isEnabled]="
                  dashboard?.reports.length === 0 ||
                  dashboard?.fields.length === 0
                "
                class="mt-6 ml-10 h-12"
              >
                <button
                  type="button"
                  data-cy="dashboardEditListenButton"
                  class="h-12 text-base rounded font-medium focus:outline-none"
                  (click)="editListeners()"
                  [ngClass]="{
                    'text-blue3 ':
                      dashboard?.reports.length > 0 &&
                      dashboard?.fields.length > 0,
                    'text-gray-400  cursor-default':
                      dashboard?.reports.length === 0 ||
                      dashboard?.fields.length === 0
                  }"
                  [disabled]="
                    dashboard?.reports.length === 0 ||
                    dashboard?.fields.length === 0
                  "
                  >Edit Listeners</button
                >
              </div>

              <div
                (click)="toggleFiltersPanel()"
                class="flex flex-row space-x-2 mt-5 ml-5 py-3 px-5 items-start cursor-pointer font-semibold text-2xl text-gray1 select-none"
              >
                <div class="flex flex-row items-center space-x-2">
                  <div> Filters </div>
                  <m-chevron-right-icon
                    *ngIf="!filtersIsExpanded"
                  ></m-chevron-right-icon>
                  <m-chevron-down-icon
                    *ngIf="filtersIsExpanded"
                  ></m-chevron-down-icon>
                </div>
              </div>

              <div
                [ngClass]="{
                  'mt-4': dashboard?.extendedFilters.length === 1
                }"
              >
                <m-bricks
                  class="mr-5 my-3 flex flex-row items-start justify-start overflow-auto max-h-[150px] max-w-max"
                  *ngIf="!filtersIsExpanded && dashboard?.fields.length > 0"
                  [extendedFilters]="dashboard.extendedFilters"
                ></m-bricks>
              </div>

              <div
                *ngIf="filtersIsExpanded && dashboard?.fields.length === 0"
                class="flex items-center justify-center text-xl mt-9 h-full w-full select-none text-gray1"
                >No filters</div
              >

              <div
                class="flex-1 w-2 mt-2 max-h-96 overflow-auto"
                *ngIf="filtersIsExpanded && dashboard?.fields.length > 0"
              >
                <m-dashboard-filters
                  [dashboard]="dashboard"
                ></m-dashboard-filters>
              </div>
            </div>
          </div>
        </div>

        <div #scrollable class="flex flex-row flex-grow mt-6 overflow-auto h-2">
          <ktd-grid
            *ngIf="dashboard?.reports"
            [compactType]="compactType"
            [preventCollision]="preventCollision"
            [cols]="cols"
            [rowHeight]="rowHeight"
            [layout]="layout"
            [scrollableParent]="scrollable"
            [scrollSpeed]="scrollSpeed"
            (layoutUpdated)="onLayoutUpdated($event)"
            (resizeEnded)="onResizeEnded($event)"
            (dragStarted)="onDragStarted($event)"
            (dragEnded)="onDragEnded($event)"
          >
            <ktd-grid-item
              class="group"
              *ngFor="let item of layout; trackBy: trackByFn"
              [id]="item.id"
            >
              <div
                ktdGridDragHandle
                class="flex drag-handle justify-center items-center invisible group-hover:visible"
                ><m-drag-icon></m-drag-icon
              ></div>
              <div class="pb-6 pr-5 w-full h-full">
                <m-chart-rep
                  #chartRep
                  [isShow]="isShow"
                  [title]="item.report.title"
                  [report]="item.report"
                  [dashboard]="dashboard"
                  [randomId]="randomId"
                  [mconfig]="item.report.mconfig"
                  [query]="item.report.query"
                  [showBricks]="showBricks"
                  (repDeleted)="reportDeleted()"
                ></m-chart-rep>
              </div>
              <m-resize-icon
                ktdGridResizeHandle
                class="flex resize-handle justify-center items-center invisible group-hover:visible"
              ></m-resize-icon>
            </ktd-grid-item>
          </ktd-grid>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="dashboard$ | async"></div>
<div *ngIf="nav$ | async"></div>
<div *ngIf="struct$ | async"></div>
<div *ngIf="isExplorer$ | async"></div>
