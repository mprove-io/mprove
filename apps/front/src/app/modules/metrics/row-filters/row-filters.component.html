<div class="mt-1 flex flex-col divide-y divide-gray-300 pr-5" *ngIf="!!mconfig">
  <div
    *ngFor="let filter of parametersFilters; let filterIndex = index"
    class="flex flex-row items-start justify-start"
    [ngClass]="{
      'pt-6': filterIndex !== 0
    }"
  >
    <div class="flex flex-row items-start justify-center">
      <div
        tp="Turn off formula to activate control"
        [tpIsEnabled]="!!reportSelectedNode.data.parametersFormula"
      >
        <button
          class="flex h-9 w-9 flex-shrink-0 items-center justify-center rounded focus:outline-none"
          [ngClass]="{
            'text-gray-500 hover:bg-blue-200':
              !reportSelectedNode.data.parametersFormula,
            'cursor-default text-gray-400':
              !!reportSelectedNode.data.parametersFormula
          }"
          [disabled]="!!reportSelectedNode.data.parametersFormula"
          (click)="deleteFilter(filter)"
        >
          <m-trash-icon></m-trash-icon>
        </button>
      </div>

      <div class="mb-5 ml-5 flex flex-col items-start justify-start">
        <div class="truncate text-sm font-normal">{{
          filter.field.topLabel | capitalize
        }}</div>

        <div class="flex flex-row text-left font-semibold">
          <div *ngIf="filter.field.groupLabel"
            >{{ filter.field.groupLabel | capitalize }} -
            {{ filter.field.label | capitalize }}</div
          >

          <div *ngIf="!filter.field.groupLabel">{{
            filter.field.label | capitalize
          }}</div>
        </div>
      </div>

      <button
        class="ml-5 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded focus:outline-none"
        [ngClass]="{
          'text-gray-500 hover:bg-blue-200':
            !reportSelectedNode.data.parametersFormula,
          'cursor-default text-gray-400':
            !!reportSelectedNode.data.parametersFormula
        }"
        (click)="toggleParFormula(filter)"
        [disabled]="!!reportSelectedNode.data.parametersFormula"
      >
        <m-formula-icon
          [ngClass]="{
            'text-blue-500':
              filter.parameterType === parameterTypeFormula && !filter.listen
          }"
        ></m-formula-icon>
      </button>

      <div
        tp="Report parameters is empty"
        [tpIsEnabled]="report.fields.length === 0"
      >
        <button
          class="ml-5 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded focus:outline-none"
          [ngClass]="{
            'text-gray-500 hover:bg-blue-200': report.fields.length > 0,
            'cursor-default text-gray-400': report.fields.length === 0
          }"
          (click)="toggleListen(filter)"
          [disabled]="report.fields.length === 0"
        >
          <m-link-icon
            [ngClass]="{
              'text-blue-500': !!filter.listen
            }"
          ></m-link-icon>
        </button>
      </div>
    </div>

    <div class="flex w-full flex-col">
      <div
        *ngIf="filter.parameterType === parameterTypeFormula && !filter.listen"
        class="mb-6 ml-5 flex flex-grow flex-row"
      >
        <m-parameter-formula
          class="w-full"
          [parameterFilter]="filter"
          [isDisabled]="filter.parameterType === parameterTypeFormula"
          (parameterFormulaUpdate)="parameterFormulaUpdate($event, filter)"
        ></m-parameter-formula>
      </div>

      <div
        *ngIf="!!filter.listen"
        class="mb-6 ml-5 flex w-[300px] flex-grow flex-row"
      >
        <form [formGroup]="myForm" class="relative flex w-full">
          <ng-select
            *ngIf="filter.fieldId === waitMconfigChangeFilterId"
            class="w-full text-base"
          ></ng-select>

          <ng-select
            *ngIf="filter.fieldId !== waitMconfigChangeFilterId"
            #rowFiltersListenSelect
            data-cy="rowFiltersListenSelect"
            class="w-full text-base"
            [items]="report.fields"
            [clearable]="false"
            [searchable]="false"
            (change)="listenChange(filter)"
            (keyup.esc)="
              $event.stopImmediatePropagation(); rowFiltersListenSelect.blur()
            "
            (keyup.enter)="
              $event.stopImmediatePropagation(); rowFiltersListenSelect.blur()
            "
            appendTo="body"
            bindLabel="label"
            bindValue="id"
            formControlName="{{ filter.fieldId }}"
          >
            <ng-template ng-label-tmp let-item="item">
              <div class="truncate">{{ item.label | capitalize }}</div>
            </ng-template>

            <ng-template ng-option-tmp let-item="item">
              <div class="truncate">{{ item.label | capitalize }}</div>
            </ng-template>
          </ng-select>
        </form>
      </div>

      <div *ngIf="filter.parameterType !== parameterTypeFormula">
        <div
          class="flex flex-row items-start justify-start"
          *ngFor="
            let fraction of filter.fractions;
            let isFirst = first;
            let fractionIndex = index
          "
        >
          <m-fraction
            [suggestModelDimension]="filter.field.suggestModelDimension"
            [structId]="mconfig.structId"
            [fieldResult]="filter.field.result"
            [fraction]="fraction"
            [fractionIndex]="fractionIndex"
            [isDisabled]="
              filter.parameterType === parameterTypeFormula ||
              !!reportSelectedNode.data.parametersFormula
            "
            [isFirst]="isFirst"
            (fractionUpdate)="fractionUpdate(filter, $event)"
          >
          </m-fraction>

          <div
            tp="Turn off formula to activate control"
            [tpIsEnabled]="
              filter.parameterType === parameterTypeFormula ||
              !!reportSelectedNode.data.parametersFormula
            "
          >
            <button
              class="ml-3 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded focus:outline-none"
              (click)="addFraction(filter)"
              [ngClass]="{
                'text-gray-500 hover:bg-blue-200':
                  filter.parameterType !== parameterTypeFormula &&
                  !reportSelectedNode.data.parametersFormula,
                'cursor-default text-gray-400':
                  filter.parameterType === parameterTypeFormula ||
                  !!reportSelectedNode.data.parametersFormula
              }"
              [disabled]="
                filter.parameterType === parameterTypeFormula ||
                !!reportSelectedNode.data.parametersFormula
              "
            >
              <m-add-icon></m-add-icon>
            </button>
          </div>

          <div
            tp="Turn off formula to activate control"
            [tpIsEnabled]="
              filter.parameterType === parameterTypeFormula ||
              !!reportSelectedNode.data.parametersFormula
            "
          >
            <button
              class="ml-3 flex h-9 w-9 items-center justify-center rounded hover:bg-blue-200 focus:outline-none"
              (click)="deleteFraction(filter, fractionIndex)"
              [ngClass]="{
                'text-gray-500 hover:bg-blue-200':
                  filter.parameterType !== parameterTypeFormula &&
                  !reportSelectedNode.data.parametersFormula,
                'cursor-default text-gray-400':
                  filter.parameterType === parameterTypeFormula ||
                  !!reportSelectedNode.data.parametersFormula
              }"
              [disabled]="
                filter.parameterType === parameterTypeFormula ||
                !!reportSelectedNode.data.parametersFormula
              "
            >
              <m-trash-icon></m-trash-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- <div *ngIf="uiQuery$ | async"></div> -->
