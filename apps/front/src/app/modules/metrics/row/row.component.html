<!-- <div
  class="mb-5 mr-9 flex h-11 flex-row items-center text-lg"
  *ngIf="reportSelectedNodes.length === 0"
>
  No rows selected
</div> -->
<div
  class="mb-5 mr-9 flex h-11 w-full flex-row items-center"
  *ngIf="reportSelectedNodes.length > 1"
>
  <div class="text-lg"> Multiple rows selected </div>

  <button
    type="button"
    data-cy="deleteRowsButton"
    class="ml-7 flex flex flex-row items-center rounded border border-gray-400 px-4 py-2 text-gray-500 hover:bg-white focus:outline-none"
    (click)="deleteRows()"
  >
    <m-trash-icon></m-trash-icon>
    <div class="ml-3"> Delete Rows </div>
  </button>

  <button
    type="button"
    data-cy="clearRowsButton"
    class="ml-5 flex flex-row items-center rounded border border-gray-400 px-4 py-2 text-gray-500 hover:bg-white focus:outline-none"
    (click)="clearRows()"
  >
    <m-delete-icon></m-delete-icon>
    <div class="ml-3"> Clear Rows </div>
  </button>
</div>

<div
  class="mb-5 mr-9 flex h-full w-full flex-col space-y-7"
  *ngIf="!!reportSelectedNode"
>
  <div class="flex flex-row items-start space-x-10">
    <div class="flex h-11 flex-row items-center space-x-5 text-lg">
      <div class="text-gray1 flex select-none items-center font-semibold"
        >Row</div
      >

      <div class="flex w-[26px] items-center">{{
        reportSelectedNode.data.rowId
      }}</div>

      <div class="ml-3">
        <button
          *ngIf="
            reportSelectedNode.data.rowType !== rowTypeEmpty &&
            reportSelectedNode.data.rowType !== rowTypeHeader
          "
          type="button"
          data-cy="rowToHeaderButton"
          class="ml-5 flex flex h-9 items-center justify-center rounded border px-2 text-sm hover:bg-white focus:outline-none"
          [ngClass]="{
            'border-blue-400 text-blue-500 ': isShowFormatOptions === true,
            'border-gray-400 text-gray-500 ': isShowFormatOptions === false
          }"
          (click)="toggleShowFormatOptions()"
        >
          123
        </button>

        <!-- <button
          *ngIf="
            reportSelectedNode.data.rowType !== rowTypeEmpty &&
            reportSelectedNode.data.rowType !== rowTypeHeader
          "
          class="flex h-9 w-9 items-center justify-center rounded text-gray-500 hover:bg-blue-200 focus:outline-none"
          (click)="toggleShowFormatOptions()"
        >
          <m-adjustments-icon
            [ngClass]="{
              'text-blue-500': isShowFormatOptions === true
            }"
          ></m-adjustments-icon>
        </button> -->
      </div>
    </div>
    <div class="flex h-11 flex-row items-center space-x-5">
      <div class="text-gray1 flex select-none items-center font-semibold"
        >Type</div
      >

      <div class="flex items-center">{{
        isToHeader === true
          ? (rowTypeHeader | capitalize)
          : isToFormula === true
          ? (rowTypeFormula | capitalize)
          : isToMetric === true
          ? (rowTypeMetric | capitalize)
          : (reportSelectedNode.data.rowType | capitalize)
      }}</div>
    </div>

    <div
      class="flex min-w-[2px] flex-1 flex-row items-start space-x-5 overflow-auto"
      *ngIf="reportSelectedNode.data.rowType === rowTypeEmpty"
    >
      <div
        class="flex flex-row"
        *ngIf="
          isToHeader === false && isToFormula === false && isToMetric === false
        "
      >
        <div class="text-gray1 flex select-none items-center font-semibold"
          >Convert to</div
        >

        <button
          type="button"
          data-cy="rowToMetricButton"
          class="ml-5 flex rounded border border-gray-400 px-4 py-2 text-gray-500 hover:bg-white focus:outline-none"
          (click)="toMetric()"
        >
          Metric
        </button>

        <button
          type="button"
          data-cy="rowToFormulaButton"
          class="ml-5 flex rounded border border-gray-400 px-4 py-2 text-gray-500 hover:bg-white focus:outline-none"
          (click)="toFormula()"
        >
          Formula
        </button>

        <button
          type="button"
          data-cy="rowToHeaderButton"
          class="ml-5 flex rounded border border-gray-400 px-4 py-2 text-gray-500 hover:bg-white focus:outline-none"
          (click)="toHeader()"
        >
          Header
        </button>
      </div>

      <div
        *ngIf="isToFormula === true"
        class="flex flex-1 flex-row items-start space-x-5"
      >
        <div class="text-gray1 mt-3 flex select-none items-center font-semibold"
          >Formula</div
        >

        <div [formGroup]="newFormulaForm" class="relative flex w-full">
          <textarea
            data-cy="newFormulaInput"
            class="form-input border-gray3 focus:border-blue3 h-[90px] w-full resize-none rounded font-mono placeholder-gray-400"
            [ngClass]="{
              'border-red-600':
                newFormulaForm.controls['formula'].invalid &&
                newFormulaForm.controls['formula'].touched
            }"
            formControlName="formula"
            placeholder="$A + $B"
          ></textarea>
          <m-validation
            class="absolute -bottom-[22px] left-0"
            [control]="newFormulaForm.controls['formula']"
          ></m-validation>
        </div>
      </div>

      <div
        *ngIf="isToHeader === true || isToFormula === true"
        class="flex h-11 max-w-[600px] flex-1 flex-row items-center space-x-5"
      >
        <div class="text-gray1 flex select-none items-center font-semibold"
          >Name</div
        >

        <div [formGroup]="newNameForm" class="relative flex w-full">
          <input
            autocomplete="off"
            data-cy="newNameInput"
            class="form-input border-gray3 focus:border-blue3 w-full min-w-[100px] resize-none rounded"
            [ngClass]="{
              'border-red-600':
                newNameForm.controls['name'].invalid &&
                newNameForm.controls['name'].touched
            }"
            formControlName="name"
            placeholder=""
          />
          <m-validation
            class="absolute -bottom-[22px] left-0"
            [control]="newNameForm.controls['name']"
          ></m-validation>
        </div>
      </div>

      <div
        *ngIf="isToMetric === true"
        class="flex h-11 min-w-[2px] max-w-[1000px] flex-grow flex-row items-center space-x-5"
      >
        <div
          class="text-gray1 flex flex-shrink-0 select-none items-center font-semibold"
          >Metric</div
        >

        <ng-select
          data-cy="newMetricSelect"
          class="new-metric-select w-full min-w-[2px] text-base focus:outline-none"
          [items]="metrics"
          [searchable]="true"
          [clearable]="false"
          [(ngModel)]="newMetricId"
          appendTo="body"
          placeholder="Select Metric"
          bindLabel="label"
          bindValue="metricId"
        >
          <ng-template ng-label-tmp let-item="item">
            <m-metric-field-label
              [metric]="item"
              [isShowTop]="true"
              [isShowTime]="true"
              class="ml-1 flex"
            ></m-metric-field-label>
          </ng-template>

          <ng-template
            ng-option-tmp
            let-item="item"
            let-index="index"
            let-search="searchTerm"
          >
            <m-metric-field-label
              [metric]="item"
              [isShowTop]="true"
              [isShowTime]="true"
              class="ml-1 flex"
            ></m-metric-field-label>
          </ng-template>
        </ng-select>
      </div>

      <div
        class="flex flex-shrink-0 flex-row"
        *ngIf="
          isToHeader === true || isToFormula === true || isToMetric === true
        "
      >
        <button
          data-cy="rowApplyButton"
          class="bg-blue3 select-none rounded px-4 py-2 font-medium text-white focus:outline-none"
          type="button"
          (click)="applyConvert()"
          >Apply</button
        >

        <button
          type="button"
          data-cy="rowCancelButton"
          class="ml-5 select-none rounded border border-gray-400 px-4 py-2 text-gray-500 hover:bg-white focus:outline-none"
          (click)="cancelConvert()"
        >
          Cancel
        </button>
      </div>
    </div>

    <button
      *ngIf="reportSelectedNode.data.rowType === rowTypeMetric"
      type="button"
      data-cy="metricsExploreButton"
      class="ml-5 flex h-11 flex-shrink-0 items-center justify-center rounded px-6 text-base font-medium text-white focus:outline-none"
      [ngClass]="{
        'bg-blue3':
          reportSelectedNode.data.rowType === rowTypeMetric &&
          reportSelectedNode.data.hasAccessToModel === true,
        'cursor-default bg-gray-400':
          reportSelectedNode.data.rowType !== rowTypeMetric ||
          reportSelectedNode.data.hasAccessToModel !== true
      }"
      (click)="explore()"
      [disabled]="
        reportSelectedNode.data.rowType !== rowTypeMetric &&
        reportSelectedNode.data.hasAccessToModel === true
      "
    >
      Explore
    </button>

    <!-- <div
      class="flex h-11 flex-row items-center space-x-5"
      *ngIf="reportSelectedNode.data.rowType === rowTypeMetric"
    >
      <div
        class="text-gray1 flex flex-shrink-0 select-none items-center font-semibold"
        >Metric Id</div
      >

      <div class="flex items-center truncate">
        <div class="truncate">{{ reportSelectedNode.data.metricId }}</div>
      </div>
    </div> -->

    <div
      *ngIf="
        reportSelectedNode.data.rowType !== rowTypeEmpty &&
        reportSelectedNode.data.rowType !== rowTypeMetric
      "
      class="flex h-11 max-w-[600px] flex-1 flex-row items-center space-x-5"
    >
      <div class="text-gray1 flex select-none items-center font-semibold"
        >Name</div
      >

      <div [formGroup]="nameForm" class="relative flex w-full">
        <input
          autocomplete="off"
          data-cy="nameInput"
          class="form-input border-gray3 focus:border-blue3 w-full min-w-[100px] resize-none rounded"
          [ngClass]="{
            'border-red-600':
              nameForm.controls['name'].invalid &&
              nameForm.controls['name'].touched
          }"
          formControlName="name"
          placeholder=""
          (blur)="nameBlur()"
        />
        <m-validation
          class="absolute -bottom-[22px] left-0"
          [control]="nameForm.controls['name']"
        ></m-validation>
      </div>
    </div>
  </div>

  <div class="ml-[25px] mr-[20px] divide-y divide-gray-300">
    <div></div>
    <div></div>
  </div>

  <div
    class="flex flex-col"
    *ngIf="
      isShowFormatOptions === true &&
      (reportSelectedNode.data.rowType === rowTypeFormula ||
        reportSelectedNode.data.rowType === rowTypeMetric)
    "
  >
    <div class="flex h-11 flex-row items-start space-x-10">
      <div class="flex h-11 flex-row items-center space-x-5">
        <div
          class="text-gray1 flex flex-shrink-0 select-none items-center font-semibold"
          >Format Number</div
        >

        <form [formGroup]="formatNumberForm" class="relative flex">
          <ng-select
            #formatNumberSelect
            data-cy="formatNumberSelect"
            class="format-number-select h-15 mr-5 w-[260px] text-base focus:outline-none"
            [items]="formatNumberExamples"
            [clearable]="false"
            [searchable]="false"
            (change)="formatNumberBlur()"
            appendTo="body"
            bindLabel="label"
            bindValue="id"
            formControlName="formatNumber"
          >
            <ng-template ng-label-tmp let-item="item">
              <m-format-number
                [inputItem]="item"
                [isOption]="false"
                class="ml-1 flex"
              ></m-format-number>
            </ng-template>

            <ng-template ng-option-tmp let-item="item">
              <m-format-number
                [inputItem]="item"
                [isOption]="true"
                class="ml-1 flex"
              ></m-format-number>
            </ng-template>
          </ng-select>

          <div class="relative">
            <input
              autocomplete="off"
              data-cy="formatNumberInput"
              class="form-input border-gray3 focus:border-blue3 w-[200px] resize-none rounded"
              [ngClass]="{
                'border-red-600':
                  formatNumberForm.controls['formatNumber'].invalid &&
                  formatNumberForm.controls['formatNumber'].touched
              }"
              formControlName="formatNumber"
              placeholder=""
              (blur)="formatNumberBlur()"
            />
            <m-validation
              class="absolute -bottom-[22px] left-0"
              [control]="formatNumberForm.controls['formatNumber']"
            ></m-validation>
          </div>
        </form>
      </div>

      <div class="flex h-11 flex-row items-center space-x-5">
        <div
          class="text-gray1 flex flex-shrink-0 select-none items-center font-semibold"
          >Currency Prefix</div
        >

        <div [formGroup]="currencyPrefixForm" class="relative flex w-[100px]">
          <input
            autocomplete="off"
            data-cy="currencyPrefixInput"
            class="form-input border-gray3 focus:border-blue3 w-full resize-none rounded"
            [ngClass]="{
              'border-red-600':
                currencyPrefixForm.controls['currencyPrefix'].invalid &&
                currencyPrefixForm.controls['currencyPrefix'].touched
            }"
            formControlName="currencyPrefix"
            placeholder=""
            (blur)="currencyPrefixBlur()"
          />
          <m-validation
            class="absolute -bottom-[22px] left-0"
            [control]="currencyPrefixForm.controls['currencyPrefix']"
          ></m-validation>
        </div>
      </div>

      <div class="flex h-11 flex-row items-center space-x-5">
        <div
          class="text-gray1 flex flex-shrink-0 select-none items-center font-semibold"
          >Currency Suffix</div
        >

        <div [formGroup]="currencySuffixForm" class="relative flex w-[100px]">
          <input
            autocomplete="off"
            data-cy="currencySuffixInput"
            class="form-input border-gray3 focus:border-blue3 w-full resize-none rounded"
            [ngClass]="{
              'border-red-600':
                currencySuffixForm.controls['currencySuffix'].invalid &&
                currencySuffixForm.controls['currencySuffix'].touched
            }"
            formControlName="currencySuffix"
            placeholder=""
            (blur)="currencySuffixBlur()"
          />
          <m-validation
            class="absolute -bottom-[22px] left-0"
            [control]="currencySuffixForm.controls['currencySuffix']"
          ></m-validation>
        </div>
      </div>
    </div>

    <div class="ml-[25px] mr-[20px] mt-7 divide-y divide-gray-300">
      <div></div>
      <div></div>
    </div>
  </div>

  <div
    *ngIf="reportSelectedNode.data.rowType === rowTypeFormula"
    class="flex flex-1 flex-row items-start space-x-5"
  >
    <div
      class="text-gray1 mt-3 flex flex-shrink-0 select-none items-center font-semibold"
      >Formula SQL</div
    >

    <div [formGroup]="formulaForm" class="relative flex max-w-[750px] flex-1">
      <textarea
        data-cy="formulaInput"
        class="form-input border-gray3 focus:border-blue3 max-h-[150px] min-h-[70px] w-full min-w-[300px] resize-y rounded font-mono placeholder-gray-400"
        [ngClass]="{
          'border-red-600':
            formulaForm.controls['formula'].invalid &&
            formulaForm.controls['formula'].touched
        }"
        formControlName="formula"
        placeholder="$A + $B"
        (blur)="formulaBlur()"
      ></textarea>
      <m-validation
        class="absolute -bottom-[22px] left-0"
        [control]="formulaForm.controls['formula']"
      ></m-validation>
    </div>
  </div>

  <div
    class="flex min-h-[44px] flex-grow flex-row overflow-y-auto"
    *ngIf="reportSelectedNode.data.rowType === rowTypeMetric"
  >
    <div
      class="text-gray1 flex h-11 select-none flex-row items-start space-x-2 font-semibold"
    >
      <div class="flex h-11 flex-row items-center space-x-2">
        <div class="truncate"> Parameters </div>
      </div>
    </div>

    <button
      class="ml-3 mt-1 flex h-9 w-9 flex-shrink-0 items-center justify-center rounded text-gray-500 hover:bg-blue-200 focus:outline-none"
      (click)="toggleParametersFormula()"
    >
      <m-formula-icon
        [ngClass]="{
          'text-blue-500': !!reportSelectedNode.data.parametersFormula
        }"
      ></m-formula-icon>
    </button>

    <div class="flex w-full flex-col">
      <div
        class="flex items-start"
        *ngIf="!!reportSelectedNode.data.parametersFormula"
      >
        <div class="flex max-w-[750px] flex-grow flex-row">
          <div
            [formGroup]="parametersFormulaForm"
            class="relative mb-5 ml-7 flex flex-grow"
          >
            <textarea
              data-cy="parametersFormulaInput"
              class="form-input border-gray3 focus:border-blue3 max-h-[150px] min-h-[70px] w-full min-w-[300px] resize-y rounded font-mono"
              [ngClass]="{
                'border-red-600':
                  parametersFormulaForm.controls['formula'].invalid &&
                  parametersFormulaForm.controls['formula'].touched
              }"
              formControlName="formula"
              placeholder="Formula to calculate parameters"
              (blur)="parametersFormulaBlur()"
            ></textarea>

            <m-validation
              class="absolute -bottom-[22px] left-0"
              [control]="parametersFormulaForm.controls['formula']"
            ></m-validation>
          </div>
        </div>

        <ng-template #templateErrors>
          <div *ngIf="reportSelectedNode.data.isParamsSchemaValid === false">{{
            reportSelectedNode.data.paramsSchemaError
          }}</div>
        </ng-template>

        <div
          *ngIf="
            !!reportSelectedNode.data.parametersFormula &&
            (reportSelectedNode.data.isParamsJsonValid === false ||
              reportSelectedNode.data.isParamsSchemaValid === false)
          "
          class="text-red1 ml-5 mt-1 flex h-8 w-8 flex-shrink-0"
          [tp]="templateErrors"
        >
          <m-exclamation-icon></m-exclamation-icon>
        </div>
      </div>

      <div class="flex w-full flex-row">
        <div
          tp="Turn off formula to activate control"
          [tpIsEnabled]="!!reportSelectedNode.data.parametersFormula"
        >
          <button
            type="button"
            data-cy="rowAddParameterButton"
            class="ml-7 h-11 select-none rounded border px-4 py-2 focus:outline-none"
            [ngClass]="{
              'border-gray-400 text-gray-500 hover:bg-white':
                !reportSelectedNode.data.parametersFormula,
              'cursor-default border-gray-300 text-gray-400':
                !!reportSelectedNode.data.parametersFormula
            }"
            [disabled]="!!reportSelectedNode.data.parametersFormula"
            (click)="addParameter()"
          >
            Add
          </button>
        </div>

        <div class="min-h-[68px]"></div>

        <div class="ml-7 w-2 flex-1">
          <div
            class="flex flex-row"
            *ngIf="isAddParameter === true"
            [ngClass]="{
              'mb-5 border-b border-gray-300 pb-5': parametersFilters.length > 0
            }"
          >
            <div
              class="flex h-11 max-w-[850px] flex-1 flex-row items-center space-x-5"
            >
              <div
                class="text-gray1 flex flex-shrink-0 select-none items-center font-semibold"
                >Filter Metric by</div
              >

              <ng-select
                data-cy="addParameterSelect"
                class="filter-metric-by-select w-full min-w-[2px] text-base focus:outline-none"
                [items]="fieldsList"
                (open)="openAddParameterSelect()"
                [loading]="fieldsListLoading"
                [searchable]="true"
                [clearable]="false"
                [(ngModel)]="newParameterId"
                (change)="addParameterChange()"
                [dropdownPosition]="'top'"
                appendTo="body"
                placeholder="Field"
                bindLabel="partLabel"
                bindValue="id"
              >
                <ng-template ng-label-tmp let-item="item">
                  <m-field-label
                    [column]="item"
                    class="ml-1 flex"
                  ></m-field-label>
                </ng-template>

                <ng-template
                  ng-option-tmp
                  let-item="item"
                  let-index="index"
                  let-search="searchTerm"
                >
                  <m-field-label
                    [column]="item"
                    class="ml-1 flex"
                  ></m-field-label>
                </ng-template>
              </ng-select>
            </div>

            <ng-template #templateApplyAddFilter>
              <div *ngIf="isDisabledApplyAlreadyFiltered === true"
                >This field is already filtered. Click on + to add new filter
                conditions.</div
              >
            </ng-template>

            <div
              class="flex"
              [tpIsEnabled]="isDisabledApplyAlreadyFiltered === true"
              [tp]="templateApplyAddFilter"
            >
              <button
                data-cy="rowApplyAddParameterButton"
                class="bg-blue3 ml-5 select-none rounded px-4 py-2 font-medium text-white focus:outline-none"
                [ngClass]="{
                  'bg-blue3': isDisabledApplyAlreadyFiltered === false,
                  'cursor-default bg-gray-400':
                    isDisabledApplyAlreadyFiltered === true
                }"
                type="button"
                (click)="applyAddParameter()"
                [disabled]="isDisabledApplyAlreadyFiltered === true"
                >Apply</button
              >
            </div>

            <button
              type="button"
              data-cy="rowCancelAddParameterButton"
              class="ml-5 select-none rounded border border-gray-400 px-4 py-2 text-gray-500 hover:bg-white focus:outline-none"
              (click)="cancelAddParameter()"
            >
              Cancel
            </button>
          </div>

          <m-row-filters
            *ngIf="parametersFilters.length > 0"
            [reportSelectedNode]="reportSelectedNode"
            [mconfig]="mconfig"
            [parametersFilters]="parametersFilters"
          ></m-row-filters>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="uiQuery$ | async"></div>
<div *ngIf="metrics$ | async"></div>
<div *ngIf="report$ | async"></div>
