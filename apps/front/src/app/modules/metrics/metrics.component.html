<div class="bg-blue1 flex h-full cursor-default flex-col">
  <div class="flex h-2 flex-1 flex-row">
    <div class="mx-6 mb-6 mt-8 flex min-w-[2px] flex-grow flex-col">
      <div class="flex h-11 flex-row items-center justify-between">
        <div class="flex w-full flex-row items-center">
          <div
            class="flex w-1/4 flex-shrink-0 flex-row items-center justify-between"
          >
            <div class="flex flex-row">
              <div
                data-cy="metricsTitle"
                class="text-gray1 flex items-center self-center text-2xl font-semibold"
              >
                {{ pageTitle }}
              </div>

              <div class="ml-10 flex flex-row items-center space-x-5">
                <m-menu-book-icon
                  class="flex-shrink-0 cursor-pointer"
                  [ngClass]="{
                    'text-gray-500': isShowLeft === true,
                    'text-gray-400': isShowLeft === false
                  }"
                  (click)="toggleShowLeft()"
                ></m-menu-book-icon>

                <!-- <m-table-cells-icon
                  class="flex-shrink-0 cursor-pointer"
                  [ngClass]="{
                    'text-gray-500': isShowTable === true,
                    'text-gray-400': isShowTable === false
                  }"
                  (click)="toggleShowTable()"
                ></m-table-cells-icon> -->

                <!-- <m-insights-icon
                  class="flex-shrink-0 cursor-pointer"
                  [ngClass]="{
                    'text-gray-500': showMetricsChart === true,
                    'text-gray-400': showMetricsChart === false
                  }"
                  (click)="toggleShowMetricsChart()"
                ></m-insights-icon> -->
              </div>
            </div>

            <div class="flex-grow"></div>

            <div class="flex flex-1 flex-row items-center justify-start">
              <!-- <div class="text-gray1 ml-6 select-none text-base">Spec</div> -->

              <form class="ml-5" [formGroup]="timeSpecForm">
                <ng-select
                  #timeSpecSelect
                  data-cy="timeSpecSelect"
                  class="popup-55 w-[160px]"
                  [items]="timeSpecList"
                  [clearable]="false"
                  [searchable]="false"
                  (change)="timeSpecChange()"
                  (keyup.esc)="
                    $event.stopImmediatePropagation(); timeSpecSelect.blur()
                  "
                  (keyup.enter)="
                    $event.stopImmediatePropagation(); timeSpecSelect.blur()
                  "
                  appendTo="body"
                  bindLabel="label"
                  bindValue="value"
                  formControlName="timeSpec"
                >
                  <ng-template ng-label-tmp let-item="item">
                    <div class="ml-1 truncate">{{ item.label }}</div>
                  </ng-template>

                  <ng-template ng-option-tmp let-item="item">
                    <div class="ml-1 truncate">{{ item.label }}</div>
                  </ng-template>
                </ng-select>
              </form>

              <!-- <button
            class="ml-2 flex h-9 select-none items-center justify-center rounded border border-2 w-[36px] py-3 text-lg font-semibold focus:outline-none"
            [ngClass]="{
              'text-blue-500':
                timeSpecForm.controls['timeSpec'].value === timeSpecTimestamps,
              'border-transparent text-gray-500':
                timeSpecForm.controls['timeSpec'].value !== timeSpecTimestamps
            }"
            (click)="timeSpecChange(timeSpecTimestamps)"
            >T</button
          > -->

              <!-- <button
            class="ml-2 flex h-9 select-none items-center justify-center rounded border border-2 w-[36px] py-3 text-lg font-semibold focus:outline-none"
            [ngClass]="{
              'text-blue-500':
                timeSpecForm.controls['timeSpec'].value === timeSpecMinutes,
              'border-transparent text-gray-500':
                timeSpecForm.controls['timeSpec'].value !== timeSpecMinutes
            }"
            (click)="timeSpecChange(timeSpecMinutes)"
            >M</button
          > -->

              <!-- <button
            class="ml-2 flex h-9 select-none items-center justify-center rounded border border-2 w-[36px] py-3 text-lg font-semibold focus:outline-none"
            [ngClass]="{
              'text-blue-500':
                timeSpecForm.controls['timeSpec'].value === timeSpecHours,
              'border-transparent text-gray-500':
                timeSpecForm.controls['timeSpec'].value !== timeSpecHours
            }"
            (click)="timeSpecChange(timeSpecHours)"
            >H</button
          > -->

              <button
                class="ml-5 flex h-9 w-[36px] select-none items-center justify-center rounded border border-2 py-3 text-lg font-semibold focus:outline-none"
                [ngClass]="{
                  'text-blue-500':
                    timeSpecForm.controls['timeSpec'].value ===
                    timeSpecTimestamps,
                  'border-transparent text-gray-500':
                    timeSpecForm.controls['timeSpec'].value !==
                    timeSpecTimestamps
                }"
                (click)="timeSpecChange(timeSpecTimestamps)"
              >
                <div> T </div>
              </button>

              <button
                class="ml-2 flex h-9 w-[36px] select-none items-center justify-center rounded border border-2 py-3 text-lg font-semibold focus:outline-none"
                [ngClass]="{
                  'text-blue-500':
                    timeSpecForm.controls['timeSpec'].value === timeSpecDays,
                  'border-transparent text-gray-500':
                    timeSpecForm.controls['timeSpec'].value !== timeSpecDays
                }"
                (click)="timeSpecChange(timeSpecDays)"
              >
                <div> D </div>
              </button>

              <button
                class="ml-2 flex h-9 w-[36px] select-none items-center justify-center rounded border border-2 py-3 text-lg font-semibold focus:outline-none"
                [ngClass]="{
                  'text-blue-500':
                    timeSpecForm.controls['timeSpec'].value === timeSpecWeeks,
                  'border-transparent text-gray-500':
                    timeSpecForm.controls['timeSpec'].value !== timeSpecWeeks
                }"
                (click)="timeSpecChange(timeSpecWeeks)"
                >W</button
              >

              <button
                class="ml-2 flex h-9 w-[36px] select-none items-center justify-center rounded border border-2 py-3 text-lg font-semibold focus:outline-none"
                [ngClass]="{
                  'text-blue-500':
                    timeSpecForm.controls['timeSpec'].value === timeSpecMonths,
                  'border-transparent text-gray-500':
                    timeSpecForm.controls['timeSpec'].value !== timeSpecMonths
                }"
                (click)="timeSpecChange(timeSpecMonths)"
                >M</button
              >

              <!-- <button
                class="ml-2 flex h-9 w-[36px] select-none items-center justify-center rounded border border-2 py-3 text-lg font-semibold focus:outline-none"
                [ngClass]="{
                  'text-blue-500':
                    timeSpecForm.controls['timeSpec'].value ===
                    timeSpecQuarters,
                  'border-transparent text-gray-500':
                    timeSpecForm.controls['timeSpec'].value !== timeSpecQuarters
                }"
                (click)="timeSpecChange(timeSpecQuarters)"
                >Q</button
              > -->

              <!-- <button
                class="ml-2 flex h-9 w-[36px] select-none items-center justify-center rounded border border-2 py-3 text-lg font-semibold focus:outline-none"
                [ngClass]="{
                  'text-blue-500':
                    timeSpecForm.controls['timeSpec'].value === timeSpecYears,
                  'border-transparent text-gray-500':
                    timeSpecForm.controls['timeSpec'].value !== timeSpecYears
                }"
                (click)="timeSpecChange(timeSpecYears)"
                >Y</button
              > -->
            </div>
          </div>

          <div
            class="text-gray1 mb-[4px] ml-[58px] select-none text-xl font-semibold"
            >Time</div
          >

          <div
            class="flex flex-row items-center justify-start"
            *ngFor="let fraction of fractions"
          >
            <m-fraction-ts
              class="ml-4 mt-[28px]"
              [fraction]="fraction"
              [isFirst]="true"
              [isMetrics]="true"
              [fractionIndex]="0"
              (fractionUpdate)="fractionUpdate($event)"
            ></m-fraction-ts>
          </div>

          <div
            class="ml-4 flex h-8 w-8 flex-shrink-0 text-amber-500"
            tp="Exceeded time columns limit ({{ report.timeColumnsLimit }})"
            *ngIf="report?.isTimeColumnsLimitExceeded === true"
          >
            <m-exclamation-icon></m-exclamation-icon>
          </div>

          <div class="flex-grow"></div>

          <div
            *ngIf="!!lastCompletedQuery"
            class="flex flex-row items-center justify-end"
          >
            <m-query-status
              [query]="lastCompletedQuery"
              [showDataRowsLength]="false"
              [showLastCompleteDuration]="false"
              [completedWord]="'Completed'"
            ></m-query-status>
          </div>

          <div class="flex flex-shrink-0 flex-row">
            <div
              class="flex cursor-pointer flex-row items-center"
              (click)="toggleAutoRun()"
            >
              <ui-switch class="ml-7 mt-1" [checked]="isAutoRun"></ui-switch>

              <div
                class="text-gray1 ml-5 flex h-9 flex-shrink-0 select-none items-center text-base"
                >Auto Run</div
              >
            </div>

            <button
              type="button"
              data-cy="metricsRunButton"
              class="ml-5 mr-9 flex h-12 w-24 items-center justify-center rounded text-base font-medium text-white focus:outline-none"
              [ngClass]="{
                'bg-blue3': queriesLength > 0,
                'cursor-default':
                  queriesLength === 0 || isRunButtonPressed === true,
                'bg-gray-400': queriesLength === 0
              }"
              (click)="run()"
              [disabled]="queriesLength === 0 || isRunButtonPressed === true"
            >
              <div *ngIf="isRunButtonPressed === false">Run</div>
              <div
                *ngIf="isRunButtonPressed === true"
                class="relative flex h-9 w-9 flex-shrink-0"
              >
                <ngx-spinner
                  [name]="metricsRunButtonSpinnerName"
                  color="rgba(255, 255, 255, 1)"
                  bdColor="rgba(0, 0, 0, 0)"
                  size="default"
                  type="ball-clip-rotate"
                  [fullScreen]="false"
                  [disableAnimation]="true"
                  [zIndex]="99998"
                >
                </ngx-spinner>
              </div>
            </button>
          </div>

          <!-- <div class="text-gray1 flex flex-row items-center text-base"> </div> -->
        </div>
      </div>

      <div class="mt-6 flex flex-grow flex-row space-x-6">
        <div class="flex w-1/4 flex-shrink-0" *ngIf="isShowLeft === true">
          <div class="flex w-full flex-grow rounded bg-white shadow">
            <div class="text-gray1 mr-5 mt-6 flex w-full flex-col text-base">
              <div class="flex flex-1 flex-col">
                <div class="mb-3 ml-5 mr-5 flex h-11 flex-row items-center">
                  <div class="flex text-lg font-semibold">REPORTS</div>

                  <!-- <div class="flex flex-grow"></div> -->

                  <button
                    *ngIf="draftsLength > 0"
                    class="ml-5 flex flex flex-row items-center rounded border border-gray-400 px-4 py-2 text-gray-500 hover:bg-gray-100 focus:outline-none"
                    (click)="deleteDrafts()"
                  >
                    <m-trash-icon></m-trash-icon>
                    <div class="ml-3">Drafts</div>
                  </button>

                  <div class="flex flex-grow"></div>
                </div>

                <div class="mb-5 flex h-2 flex-grow flex-col overflow-y-auto">
                  <div
                    *ngFor="let r of reports; let i = index"
                    (click)="navToReport(r)"
                  >
                    <div
                      *ngIf="draftsLength >= 0 && i === draftsLength + 1"
                      class="ml-[25px] mr-[20px] divide-y divide-gray-300"
                    >
                      <div></div>
                      <div></div>
                    </div>
                    <div
                      class="hover:bg-blue2 group ml-6 mr-5 flex h-11 flex-row items-center rounded px-4 hover:cursor-pointer"
                    >
                      <div class="mr-3 flex h-2 items-center">
                        <div
                          *ngIf="r.reportId === report.reportId"
                          data-cy="reportsSelectedSymbol"
                          class="bg-blue3 h-7 w-1 rounded-full text-white focus:outline-none"
                        ></div>

                        <div
                          *ngIf="r.reportId !== report.reportId"
                          class="h-7 w-1"
                        ></div>
                      </div>

                      <div class="text-gray1 truncate">
                        {{ r.title | capitalize }}
                      </div>

                      <div class="flex flex-grow"></div>

                      <button
                        *ngIf="
                          report.draft === true &&
                          r.reportId === report.reportId
                        "
                        type="button"
                        data-cy="reportSaveAsButton"
                        class="ml-3 flex h-11 w-28 items-center justify-center rounded focus:outline-none"
                        (click)="reportSaveAs($event)"
                      >
                        <div
                          class="flex h-8 flex-shrink-0 flex-row items-center justify-start space-x-2 rounded px-3 hover:bg-white"
                        >
                          <m-save-icon class="text-gray-500"></m-save-icon>
                          <div class="flex justify-start text-gray-500"
                            >Save As</div
                          >
                        </div>
                      </button>

                      <button
                        *ngIf="
                          report.draft === true &&
                          r.reportId === report.reportId
                        "
                        class="ml-3 flex h-9 flex-shrink-0 items-center justify-center space-x-2 rounded px-3 text-gray-500 hover:bg-white focus:outline-none"
                        (click)="deleteDraftReport($event, r)"
                      >
                        <m-trash-icon></m-trash-icon>

                        <div class="flex justify-start text-gray-500"
                          >Draft</div
                        >
                      </button>

                      <div
                        *ngIf="
                          r.draft === false && r.reportId !== emptyReportId
                        "
                        class="invisible ml-2 flex group-hover:visible"
                      >
                        <m-report-options [report]="r"></m-report-options>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex flex-1 flex-col">
                <div class="mb-3 ml-5 mr-5 flex h-11 flex-row items-center">
                  <div class="flex text-lg font-semibold">METRICS</div>
                  <div class="flex flex-grow"></div>
                </div>

                <m-metrics-tree
                  class="flex w-full flex-1 flex-shrink-0"
                ></m-metrics-tree>
              </div>

              <div class="mb-5 mr-5 mt-5 flex h-11 flex-row items-center">
                <div class="text-gray1 ml-6 select-none text-base"
                  >Timezone</div
                >

                <div class="ml-5 flex max-w-[260px] flex-1">
                  <form
                    class="w-full"
                    [formGroup]="timezoneForm"
                    tp="Timezone change is not allowed"
                    [tpIsEnabled]="
                      timezoneForm.controls['timezone'].disabled === true
                    "
                  >
                    <ng-select
                      #metricsTimezoneSelect
                      data-cy="metricsTimezoneSelect"
                      class="w-full text-base"
                      [items]="timezones"
                      [clearable]="false"
                      [searchable]="true"
                      [searchFn]="timezoneSearchFn"
                      (change)="timezoneChange()"
                      (keyup.esc)="
                        $event.stopImmediatePropagation();
                        metricsTimezoneSelect.blur()
                      "
                      (keyup.enter)="
                        $event.stopImmediatePropagation();
                        metricsTimezoneSelect.blur()
                      "
                      appendTo="body"
                      bindLabel="label"
                      bindValue="value"
                      formControlName="timezone"
                    >
                      <ng-template ng-label-tmp let-item="item">
                        <div class="truncate">{{ item.label }}</div>
                      </ng-template>

                      <ng-template ng-option-tmp let-item="item">
                        <div class="truncate">{{ item.label }}</div>
                      </ng-template>
                    </ng-select>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex min-w-[2px] flex-grow flex-col">
          <div class="w-full flex-1 flex-shrink-0 rounded bg-white shadow">
            <router-outlet></router-outlet>
          </div>

          <div class="mr-5 mt-5 flex min-h-[68px] flex-shrink-0 flex-row">
            <div
              (click)="toggleFiltersPanel()"
              class="text-gray1 ml-3 mt-2 flex h-11 select-none flex-row items-start space-x-2 px-5 text-xl font-semibold"
              [ngClass]="{
                'cursor-pointer': report?.fields.length > 0,
                'cursor-default': report?.fields.length === 0
              }"
            >
              <div class="flex flex-row items-center space-x-2">
                <m-chevron-right-icon
                  *ngIf="!filtersIsExpanded && report?.fields.length > 0"
                ></m-chevron-right-icon>
                <m-chevron-down-icon
                  *ngIf="filtersIsExpanded && report?.fields.length > 0"
                ></m-chevron-down-icon>

                <!-- <div class="h-6 w-6" *ngIf="report?.fields.length === 0"></div> -->

                <div> Parameters </div>
              </div>
            </div>

            <div class="ml-3 flex max-h-[270px] w-full flex-col overflow-auto">
              <div
                class="mr-5 mt-1 flex flex-row items-start"
                *ngIf="!filtersIsExpanded && report?.fields.length > 0"
              >
                <m-bricks
                  class="mb-5 flex max-h-[150px] max-w-max flex-row items-start justify-start overflow-auto"
                  [extendedFilters]="report?.extendedFilters"
                  [isKeepBackgroundColor]="false"
                  [showJson]="false"
                ></m-bricks>
              </div>

              <!-- <div
                class="mr-5 mt-1 flex flex-row items-start"
                *ngIf="showBricksJson && report?.fields.length > 0"
              >
                <m-bricks
                  class="mb-5 flex max-w-max flex-row items-start justify-start overflow-auto"
                  [extendedFilters]="report?.extendedFilters"
                  [isKeepBackgroundColor]="false"
                  [showJson]="true"
                  [onlyJson]="true"
                  [parametersJson]="reportGlobalRow.parametersJson"
                ></m-bricks>
              </div> -->

              <div
                class="flex w-full flex-row"
                *ngIf="
                  filtersIsExpanded === true || report?.fields.length === 0
                "
              >
                <button
                  type="button"
                  data-cy="dashboardAddFilterButton"
                  class="h-11 flex-shrink-0 select-none rounded border border-gray-400 px-4 py-2 text-base font-medium text-gray-500 hover:bg-white focus:outline-none"
                  (click)="addFilter()"
                  >Add Filter</button
                >

                <div
                  class="ml-7 mt-1 w-2 flex-1"
                  *ngIf="filtersIsExpanded && report?.fields.length > 0"
                >
                  <m-report-filters [report]="report"></m-report-filters>
                </div>
              </div>
            </div>
          </div>

          <div
            class="flex w-full flex-col"
            [ngClass]="{
              'mt-1 h-[40%]':
                showMetricsChart === true || reportSelectedNodes.length > 0
            }"
          >
            <div
              class="flex h-2 w-full flex-grow flex-row rounded border border-2 border-blue-500"
              *ngIf="isShow === true && reportSelectedNodes.length > 0"
            >
              <m-row class="ml-5 mr-5 mt-5 flex w-full"></m-row>
            </div>

            <div
              class="relative h-2 w-full flex-grow flex-row rounded bg-white shadow"
              *ngIf="
                isShow === true &&
                showMetricsChart === true &&
                reportSelectedNodes.length === 0
              "
            >
              <div class="h-full flex-1 flex-grow flex-col">
                <div
                  class="flex h-full flex-1 flex-row space-x-5 pb-2 pl-5 pr-5 pt-5"
                >
                  <div
                    class="flex h-full flex-col"
                    [ngClass]="{
                      'w-2/3': showMetricsChartSettings === true,
                      'w-full': showMetricsChartSettings === false
                    }"
                  >
                    <div
                      *ngIf="dataPoints.length === 0"
                      class="text-gray1 flex h-full w-full select-none items-center justify-center text-xl"
                      >No rows to display</div
                    >

                    <div
                      *ngIf="
                        dataPoints.length > 0 && selectedDataRowsLength === 0
                      "
                      class="text-gray1 flex h-full w-full select-none items-center justify-center text-xl"
                      >No rows with charts enabled</div
                    >

                    <m-chart-box
                      *ngIf="
                        dataPoints.length > 0 &&
                        selectedDataRowsLength > 0 &&
                        recordsWithValuesLength > 0 &&
                        !!eChartInitOpts &&
                        !!eChartOptions
                      "
                      [eChartInitOpts]="eChartInitOpts"
                      [eChartOptions]="eChartOptions"
                      [chartInstanceId]="'metrics-chart'"
                      style="height: 100%"
                    ></m-chart-box>

                    <div
                      *ngIf="
                        dataPoints.length > 0 &&
                        selectedDataRowsLength > 0 &&
                        recordsWithValuesLength === 0
                      "
                      class="text-gray1 flex h-full w-full select-none items-center justify-center text-xl"
                    >
                      <div *ngIf="newQueriesLength > 0"
                        >Run queries to get data</div
                      >

                      <div
                        *ngIf="
                          newQueriesLength === 0 && runningQueriesLength > 0
                        "
                        >Queries are running</div
                      >

                      <div
                        *ngIf="
                          newQueriesLength === 0 && runningQueriesLength === 0
                        "
                        >The result has no data</div
                      >
                    </div>
                  </div>

                  <m-chart-settings
                    class="flex w-1/3 flex-col border-l border-gray-300"
                    *ngIf="showMetricsChartSettings === true"
                  ></m-chart-settings>

                  <div
                    class="absolute right-5 top-5 flex h-9 w-9 flex-shrink-0 cursor-pointer items-center justify-center rounded hover:bg-blue-200 focus:outline-none"
                    (click)="toggleShowMetricsChartSettings()"
                  >
                    <m-wrench-icon></m-wrench-icon>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="report$ | async"></div>
<div *ngIf="reports$ | async"></div>
<div *ngIf="reportChartData$ | async"></div>
<div *ngIf="uiQuery$ | async"></div>
<div *ngIf="struct$ | async"></div>
