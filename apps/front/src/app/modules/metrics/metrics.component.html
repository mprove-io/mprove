<div class="bg-blue1 flex h-full cursor-default flex-col">
  <div class="flex h-full flex-row">
    <div class="mx-6 mb-6 mt-8 flex min-w-[2px] flex-grow flex-col">
      <div class="flex h-11 flex-row items-center justify-between">
        <div class="flex w-full flex-row items-center">
          <div class="flex w-1/4 flex-row items-center space-x-5">
            <div
              data-cy="metricsTitle"
              class="text-gray1 flex items-center self-center text-2xl font-semibold"
            >
              {{ pageTitle }}
            </div>
            <div class="flex-grow"></div>

            <div class="text-gray1 ml-6 text-base">Timezone</div>

            <form [formGroup]="timezoneForm">
              <ng-select
                #timezoneSelect
                data-cy="timezoneSelect"
                class="custom w-[260px] text-base focus:outline-none"
                [items]="timezones"
                [clearable]="false"
                (change)="timezoneChange()"
                appendTo="body"
                bindLabel="label"
                bindValue="value"
                formControlName="timezone"
              >
                <ng-template ng-label-tmp let-item="item">
                  <div class="truncate">{{ item.label }}</div>
                </ng-template>

                <ng-template ng-option-tmp let-item="item">
                  <div class="truncate">{{ item.label }}</div>
                </ng-template>
              </ng-select>
            </form>
          </div>

          <div class="text-gray1 ml-6 text-base">Spec</div>

          <form class="ml-5" [formGroup]="timeSpecForm">
            <ng-select
              #timeSpecSelect
              data-cy="timeSpecSelect"
              class="custom popup-55 w-32 focus:outline-none"
              [items]="timeSpecList"
              [clearable]="false"
              [searchable]="false"
              (change)="timeSpecChange()"
              appendTo="body"
              bindLabel="label"
              bindValue="value"
              formControlName="timeSpec"
            >
              <ng-template ng-label-tmp let-item="item">
                <div class="ml-1 truncate">{{ item.label }}</div>
              </ng-template>

              <ng-template ng-option-tmp let-item="item">
                <div class="ml-1 truncate">{{ item.label }}</div>
              </ng-template>
            </ng-select>
          </form>

          <div class="text-gray1 ml-6 text-base">Time</div>

          <div
            class="flex flex-row items-start justify-start"
            *ngFor="let fraction of fractions"
          >
            <m-fraction-ts
              class="ml-3 pt-6"
              [fraction]="fraction"
              [isFirst]="true"
              [isMetrics]="true"
              [fractionIndex]="0"
              (fractionUpdate)="fractionUpdate($event)"
            ></m-fraction-ts>
          </div>

          <div
            class="ml-4 flex h-8 w-8 flex-shrink-0 text-amber-500"
            tippy="Exceeded time columns limit ({{ rep.timeColumnsLimit }})"
            *ngIf="rep?.isTimeColumnsLimitExceeded === true"
          >
            <m-exclamation-icon></m-exclamation-icon>
          </div>

          <div class="flex-grow"></div>

          <button
            type="button"
            data-cy="metricsRunButton"
            class="ml-5 mr-9 flex h-12 w-24 items-center justify-center rounded text-base font-medium text-white focus:outline-none"
            [ngClass]="{
              'bg-blue3': queriesLength > 0,
              'cursor-default':
                queriesLength === 0 || isRunButtonPressed === true,
              'bg-gray-400': queriesLength === 0
            }"
            (click)="run()"
            [disabled]="queriesLength === 0 || isRunButtonPressed === true"
          >
            <div *ngIf="isRunButtonPressed === false">Run</div>
            <div
              *ngIf="isRunButtonPressed === true"
              class="relative flex h-9 w-9 flex-shrink-0"
            >
              <ngx-spinner
                [name]="metricsRunButtonSpinnerName"
                color="rgba(255, 255, 255, 1)"
                bdColor="rgba(0, 0, 0, 0)"
                size="default"
                type="ball-clip-rotate"
                [fullScreen]="false"
                [disableAnimation]="true"
                [zIndex]="99998"
              >
              </ngx-spinner>
            </div>
          </button>

          <div class="text-gray1 flex flex-row items-center text-base"> </div>
        </div>
      </div>

      <div class="mt-6 flex flex-grow flex-row">
        <div class="flex w-1/4 flex-shrink-0">
          <div class="flex w-full flex-grow rounded bg-white shadow-lg">
            <div class="text-gray1 mr-5 mt-6 flex w-full flex-col text-base">
              <div class="flex flex-1 flex-col">
                <div class="ml-5 mb-3 flex flex-row">
                  <div class="flex text-lg font-semibold">REPORTS</div>

                  <!-- <div class="flex flex-grow"></div> -->
                </div>

                <div class="mb-5 flex h-2 flex-grow flex-col overflow-y-auto">
                  <div
                    *ngFor="let r of reps; let i = index"
                    (click)="navToRep(r)"
                  >
                    <div
                      *ngIf="draftsLength >= 0 && i === draftsLength + 1"
                      class="ml-[25px] mr-[20px] divide-y divide-gray-300"
                    >
                      <div></div>
                      <div></div>
                    </div>
                    <div
                      class="hover:bg-blue2 group ml-6 mr-5 flex h-11 flex-row items-center rounded px-4 hover:cursor-pointer"
                    >
                      <div class="mr-3 flex h-2 items-center">
                        <div
                          *ngIf="r.repId === rep.repId"
                          data-cy="reportsSelectedSymbol"
                          class="bg-blue3 h-7 w-1 rounded-full text-white focus:outline-none"
                        ></div>

                        <div
                          *ngIf="r.repId !== rep.repId"
                          class="h-7 w-1"
                        ></div>
                      </div>

                      <div class="text-gray1 truncate">
                        {{ r.title | capitalize }}
                      </div>

                      <div class="flex flex-grow"></div>

                      <button
                        *ngIf="rep.draft === true && r.repId === rep.repId"
                        type="button"
                        data-cy="repSaveAsButton"
                        class="ml-3 flex h-11 w-28 items-center justify-center rounded focus:outline-none"
                        (click)="repSaveAs($event)"
                      >
                        <div
                          class="flex h-8 flex-row items-center justify-start space-x-2 rounded px-3 hover:bg-white"
                        >
                          <div
                            class="flex w-[60px] flex-shrink-0 justify-start text-sm text-gray-500"
                            >Save As</div
                          >
                          <m-save-icon class="text-gray-500"></m-save-icon>
                        </div>
                      </button>

                      <button
                        *ngIf="rep.draft === true && r.repId === rep.repId"
                        class="ml-3 flex h-9 w-9 items-center justify-center rounded text-gray-500 hover:bg-white focus:outline-none"
                        (click)="deleteRep($event, r)"
                      >
                        <m-trash-icon></m-trash-icon>
                      </button>

                      <div
                        *ngIf="r.draft === true"
                        class="ml-5 flex items-center justify-center text-gray-500 focus:outline-none"
                      >
                        Draft</div
                      >

                      <div
                        *ngIf="r.draft === false && r.repId !== emptyRepId"
                        class="invisible ml-2 flex group-hover:visible"
                      >
                        <m-rep-options [rep]="r"></m-rep-options>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex flex-1 flex-col">
                <div class="ml-5 mb-3 flex text-lg font-semibold">METRICS</div>

                <m-metrics-tree
                  class="flex w-full flex-1 flex-shrink-0"
                ></m-metrics-tree>
              </div>
            </div>
          </div>
        </div>

        <div class="ml-6 flex min-w-[2px] flex-grow flex-col space-y-6">
          <div class="w-full flex-1 flex-shrink-0 rounded bg-white shadow-md">
            <router-outlet></router-outlet>
          </div>

          <div
            class="flex flex-col"
            *ngIf="showMetricsChart === true || !!repSelectedNode"
            [ngClass]="{
              'h-[55%]': showMetricsChart === true
            }"
          >
            <div
              *ngIf="!!repSelectedNode"
              class="mb-5 mr-9 flex flex-row items-start space-x-10"
            >
              <div class="flex h-11 flex-row items-center space-x-5">
                <div
                  class="text-gray1 flex select-none items-center font-semibold"
                  >Row</div
                >

                <div class="flex w-[26px] items-center">{{
                  repSelectedNode.data.rowId
                }}</div>
              </div>

              <div class="flex h-11 flex-row items-center">
                <button
                  class="flex h-9 w-9 items-center justify-center rounded text-gray-500 hover:bg-blue-200 focus:outline-none"
                  (click)="deleteRow()"
                >
                  <m-trash-icon></m-trash-icon>
                </button>

                <button
                  class="ml-3 flex h-9 w-9 items-center justify-center rounded text-gray-500 hover:bg-blue-200 focus:outline-none"
                  (click)="clearRow()"
                >
                  <m-delete-icon></m-delete-icon>
                </button>
              </div>

              <div class="flex h-11 flex-row items-center space-x-5">
                <div
                  class="text-gray1 flex select-none items-center font-semibold"
                  >Type</div
                >

                <div class="flex items-center">{{
                  repSelectedNode.data.rowType | capitalize
                }}</div>
              </div>

              <div
                class="flex h-11 flex-row items-center space-x-5"
                *ngIf="repSelectedNode.data.rowType === rowTypeMetric"
              >
                <div
                  class="text-gray1 flex select-none items-center font-semibold"
                  >Metric Id</div
                >

                <div class="flex items-center">{{
                  repSelectedNode.data.metricId
                }}</div>
              </div>

              <div
                *ngIf="repSelectedNode.data.rowType === rowTypeFormula"
                class="flex flex-1 flex-row items-start space-x-5"
              >
                <div
                  class="text-gray1 mt-3 flex select-none items-center font-semibold"
                  >Formula</div
                >

                <div [formGroup]="formulaForm" class="relative flex w-full">
                  <textarea
                    data-cy="formulaInput"
                    class="form-input border-gray3 focus:border-blue3 max-h-[180px] min-h-[90px] w-full resize-y rounded"
                    [ngClass]="{
                      'border-red-600':
                        formulaForm.controls['formula'].invalid &&
                        formulaForm.controls['formula'].touched
                    }"
                    formControlName="formula"
                    placeholder="$A + $B"
                    (blur)="formulaBlur()"
                  ></textarea>
                  <m-validation
                    class="absolute -bottom-5 left-0"
                    [control]="formulaForm.controls['formula']"
                  ></m-validation>
                </div>
              </div>

              <div
                *ngIf="repSelectedNode.data.rowType !== rowTypeEmpty"
                class="flex h-11 flex-1 flex-row items-center space-x-5"
              >
                <div
                  class="text-gray1 flex select-none items-center font-semibold"
                  >Name</div
                >

                <div [formGroup]="nameForm" class="relative flex w-full">
                  <input
                    data-cy="nameInput"
                    class="form-input border-gray3 focus:border-blue3 w-full resize-none rounded"
                    [ngClass]="{
                      'border-red-600':
                        nameForm.controls['name'].invalid &&
                        nameForm.controls['name'].touched,
                      'max-w-[500px]':
                        repSelectedNode.data.rowType === rowTypeHeader
                    }"
                    formControlName="name"
                    placeholder=""
                    (blur)="nameBlur()"
                  />
                  <m-validation
                    class="absolute -bottom-5 left-0"
                    [control]="nameForm.controls['name']"
                  ></m-validation>
                </div>
              </div>

              <button
                *ngIf="repSelectedNode.data.rowType === rowTypeMetric"
                type="button"
                data-cy="metricsExploreButton"
                class="ml-5 flex h-11 flex-shrink-0 items-center justify-center rounded px-6 text-base font-medium text-white focus:outline-none"
                [ngClass]="{
                  'bg-blue3':
                    repSelectedNode.data.rowType === rowTypeMetric &&
                    repSelectedNode.data.hasAccessToModel === true,
                  'cursor-default bg-gray-400':
                    repSelectedNode.data.rowType !== rowTypeMetric ||
                    repSelectedNode.data.hasAccessToModel !== true
                }"
                (click)="explore()"
                [disabled]="
                  repSelectedNode.data.rowType !== rowTypeMetric &&
                  repSelectedNode.data.hasAccessToModel === true
                "
              >
                Explore
              </button>
            </div>

            <div
              class="relative h-2 w-full flex-grow flex-row rounded bg-white shadow-md"
              *ngIf="showMetricsChart === true"
            >
              <div class="h-full flex-1 flex-grow flex-col">
                <div
                  class="flex h-full flex-1 flex-row space-x-5 pl-5 pr-5 pt-5 pb-2"
                >
                  <div
                    class="flex h-full flex-col"
                    [ngClass]="{
                      'w-2/3': showMetricsChartSettings === true,
                      'w-full': showMetricsChartSettings === false
                    }"
                  >
                    <ag-charts-angular
                      *ngIf="
                        chartOptions?.data.length > 0 &&
                        recordsWithValuesLength > 0
                      "
                      style="height: 100%"
                      [options]="chartOptions"
                    ></ag-charts-angular>

                    <div
                      *ngIf="
                        chartOptions?.data.length > 0 &&
                        recordsWithValuesLength === 0
                      "
                      class="text-gray1 flex h-full w-full select-none items-center justify-center text-xl"
                      >Run queries to get data</div
                    >

                    <div
                      *ngIf="
                        chartOptions?.data.length === 0 &&
                        showChartForSelectedRow === true &&
                        repSelectedNodes.length > 1
                      "
                      class="text-gray1 flex h-full w-full select-none items-center justify-center text-xl"
                      >Select one row or delesect all</div
                    >

                    <div
                      *ngIf="
                        chartOptions?.data.length === 0 &&
                        !(
                          showChartForSelectedRow === true &&
                          repSelectedNodes.length > 1
                        )
                      "
                      class="text-gray1 flex h-full w-full select-none items-center justify-center text-xl"
                      >No rows to display</div
                    >
                  </div>

                  <m-chart-settings
                    class="flex w-1/3 flex-col border-l border-gray-300"
                    *ngIf="showMetricsChartSettings === true"
                  ></m-chart-settings>

                  <div
                    class="absolute top-5 right-5 flex h-9 w-9 flex-shrink-0 cursor-pointer items-center justify-center rounded hover:bg-blue-200 focus:outline-none"
                    (click)="toggleShowMetricsChartSettings()"
                  >
                    <m-wrench-icon></m-wrench-icon>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="rep$ | async"></div>
<div *ngIf="reps$ | async"></div>
<div *ngIf="uiQuery$ | async"></div>
<div *ngIf="repChartData$ | async"></div>
