services:
  db:
    image: postgres:18.1
    environment:
      POSTGRES_DB: $COMPOSE_DB_POSTGRES_DB
      POSTGRES_USER: $COMPOSE_DB_POSTGRES_USER
      POSTGRES_PASSWORD: $COMPOSE_DB_POSTGRES_PASSWORD
    ports:
      - 127.0.0.1:5432:5432
    volumes:
      - type: bind
        source: $COMPOSE_DB_VOLUME_SOURCE_PATH
        target: /var/lib/postgresql/18/docker

  valkey:
    image: valkey/valkey:8.1.4
    command: valkey-server --requirepass ${COMPOSE_VALKEY_PASSWORD} --save "" --appendonly no
    ports:
      - 127.0.0.1:6379:6379

  calc-postgres:
    image: postgres:18.1
    environment:
      POSTGRES_PASSWORD: $COMPOSE_CALC_POSTGRES_PASSWORD
      CALC_USER: $COMPOSE_CALC_USER
      CALC_PASSWORD: $COMPOSE_CALC_PASSWORD
      PGPORT: 5437
    ports:
      - 127.0.0.1:5437:5437
    volumes:
      - ./scripts/docker-compose/init-calc-user.sh:/docker-entrypoint-initdb.d/init-calc-user.sh

  opencode:
    image: ghcr.io/anomalyco/opencode:1.2.6
    command: ['serve', '--hostname=0.0.0.0', '--port=14096']
    environment:
      OPENCODE_SERVER_PASSWORD: $COMPOSE_OPENCODE_SERVER_PASSWORD
      OPENCODE_API_KEY: $COMPOSE_ZEN_API_KEY
      ANTHROPIC_API_KEY: $COMPOSE_ANTHROPIC_API_KEY
      OPENAI_API_KEY: $COMPOSE_OPENAI_API_KEY
    ports:
      - 127.0.0.1:14096:14096

  backend:
    build:
      context: ./
      dockerfile: setup-docker/backend.Dockerfile
    image: ghcr.io/mprove-io/mprove-backend:$MPROVE_RELEASE_TAG
    env_file:
      - .env
    environment:
      BACKEND_IS_SCHEDULER: 'TRUE'
    ports:
      - 3000:3000
    depends_on:
      - db
      - valkey
      - calc-postgres
    command: sh -c 'scripts/wait-for-it.sh db:5432 --timeout=120 -- node --enable-source-maps apps/backend/dist/main.js'
    volumes:
      - type: bind
        source: $COMPOSE_ENV_FILE_SOURCE_PATH
        target: $COMPOSE_ENV_FILE_TARGET_PATH
      - type: bind
        source: $COMPOSE_BACKEND_DEMO_PROJECT_BIGQUERY_CREDENTIALS_SOURCE_PATH
        target: $COMPOSE_BACKEND_DEMO_PROJECT_BIGQUERY_CREDENTIALS_PATH
      - type: bind
        source: $COMPOSE_BACKEND_DEMO_PROJECT_REMOTE_PRIVATE_KEY_ENCRYPTED_SOURCE_PATH
        target: $COMPOSE_BACKEND_DEMO_PROJECT_REMOTE_PRIVATE_KEY_ENCRYPTED_PATH
      - type: bind
        source: $COMPOSE_BACKEND_DEMO_PROJECT_REMOTE_PUBLIC_KEY_SOURCE_PATH
        target: $COMPOSE_BACKEND_DEMO_PROJECT_REMOTE_PUBLIC_KEY_PATH

  blockml:
    build:
      context: ./
      dockerfile: setup-docker/blockml.Dockerfile
    image: ghcr.io/mprove-io/mprove-blockml:$MPROVE_RELEASE_TAG
    env_file:
      - .env
    depends_on:
      - valkey
    command: sh -c 'node --enable-source-maps apps/blockml/dist/main.js'
    volumes:
      - type: bind
        source: $COMPOSE_ENV_FILE_SOURCE_PATH
        target: $COMPOSE_ENV_FILE_TARGET_PATH

  disk:
    build:
      context: ./
      dockerfile: setup-docker/disk.Dockerfile
    image: ghcr.io/mprove-io/mprove-disk:$MPROVE_RELEASE_TAG
    env_file:
      - .env
    command: sh -c 'node --enable-source-maps apps/disk/dist/main.js'
    depends_on:
      - valkey
    volumes:
      - type: bind
        source: $COMPOSE_ENV_FILE_SOURCE_PATH
        target: $COMPOSE_ENV_FILE_TARGET_PATH
      - type: bind
        source: $COMPOSE_DISK_ORGANIZATIONS_VOLUME_SOURCE_PATH
        target: $COMPOSE_DISK_ORGANIZATIONS_VOLUME_PATH

  front:
    build:
      context: ./
      dockerfile: setup-docker/front.Dockerfile
    image: ghcr.io/mprove-io/mprove-front:$MPROVE_RELEASE_TAG
    ports:
      - 3003:80

  maintenance:
    build:
      context: ./
      dockerfile: setup-docker/maintenance.Dockerfile
    image: ghcr.io/mprove-io/mprove-maintenance:$MPROVE_MAINTENANCE_TAG
    ports:
      - 3005:80

  mcli:
    build:
      context: ./
      dockerfile: setup-docker/mcli.Dockerfile
    image: ghcr.io/mprove-io/mprove-mcli:$MPROVE_RELEASE_TAG
    env_file:
      - .env
    volumes:
      - type: bind
        source: $COMPOSE_ENV_FILE_SOURCE_PATH
        target: $COMPOSE_ENV_FILE_TARGET_PATH
      - type: bind
        source: $COMPOSE_BACKEND_DEMO_PROJECT_REMOTE_PRIVATE_KEY_ENCRYPTED_SOURCE_PATH
        target: $COMPOSE_BACKEND_DEMO_PROJECT_REMOTE_PRIVATE_KEY_ENCRYPTED_PATH
      - type: bind
        source: $COMPOSE_BACKEND_DEMO_PROJECT_REMOTE_PUBLIC_KEY_SOURCE_PATH
        target: $COMPOSE_BACKEND_DEMO_PROJECT_REMOTE_PUBLIC_KEY_PATH

  dwh-postgres:
    build:
      context: ./
      dockerfile: setup-docker/dwh-postgres.Dockerfile
    image: ghcr.io/mprove-io/mprove-dwh-postgres:$MPROVE_DWH_POSTGRES_TAG
    environment:
      POSTGRES_PASSWORD: $COMPOSE_DWH_POSTGRES_PASSWORD
      READ_USER: $COMPOSE_DWH_POSTGRES_READ_USER
      READ_PASSWORD: $COMPOSE_DWH_POSTGRES_READ_PASSWORD
      PGPORT: 5436
    ports:
      - 127.0.0.1:5436:5436
    volumes:
      - type: bind
        source: $COMPOSE_DWH_POSTGRES_VOLUME_SOURCE_PATH
        target: /var/lib/postgresql/18/docker

  dwh-mysql:
    build:
      context: ./
      dockerfile: setup-docker/dwh-mysql.Dockerfile
    image: ghcr.io/mprove-io/mprove-dwh-mysql:$MPROVE_DWH_MYSQL_TAG
    environment:
      MYSQL_ROOT_PASSWORD: $COMPOSE_DWH_MYSQL_ROOT_PASSWORD
    command: [
        # '--default-authentication-plugin=mysql_native_password',
        '--max_allowed_packet=128M',
        '--innodb-buffer-pool-size=1G'
      ]
    ports:
      - 127.0.0.1:3306:3306
    volumes:
      - type: bind
        source: $COMPOSE_DWH_MYSQL_VOLUME_SOURCE_PATH
        target: /var/lib/mysql

  dwh-trino:
    image: trinodb/trino:476
    ports:
      - 127.0.0.1:8081:8080
    volumes:
      - type: bind
        source: $COMPOSE_DWH_TRINO_CATALOG_VOLUME_SOURCE_PATH
        target: /etc/trino/catalog
      - type: bind
        source: $COMPOSE_DWH_TRINO_CONFIG_VOLUME_SOURCE_PATH
        target: /opt/trino/etc/config.properties

  dwh-presto:
    image: prestodb/presto:0.294
    ports:
      - 127.0.0.1:8082:8080
    volumes:
      - type: bind
        source: $COMPOSE_DWH_PRESTO_CATALOG_VOLUME_SOURCE_PATH
        target: /opt/presto-server/etc/catalog
      - type: bind
        source: $COMPOSE_DWH_PRESTO_CONFIG_VOLUME_SOURCE_PATH
        target: /opt/presto-server/etc/config.properties

  clickstack:
    image: clickhouse/clickstack-all-in-one:2.9.0
    container_name: clickstack-all-in-one
    ports:
      - 8080:8080
      - 127.0.0.1:4317:4317
      - 127.0.0.1:4318:4318
    environment:
      HYPERDX_APP_URL: $COMPOSE_CLICKSTACK_HYPERDX_APP_URL
    volumes:
      - type: bind
        source: $COMPOSE_CLICKSTACK_DB_VOLUME_SOURCE_PATH
        target: /data/db
      - type: bind
        source: $COMPOSE_CLICKSTACK_CH_DATA_VOLUME_SOURCE_PATH
        target: /var/lib/clickhouse
      - type: bind
        source: $COMPOSE_CLICKSTACK_CH_LOGS_VOLUME_SOURCE_PATH
        target: /var/log/clickhouse-server

networks:
  app-network:
    driver: bridge
