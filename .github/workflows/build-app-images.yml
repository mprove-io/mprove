name: build-app-images

on:
  push:
    tags:
      - 'app-*'

env:
  IMAGE_REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository }}

jobs:
  extract-version:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      apps_json: ${{ steps.apps.outputs.apps_json }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#app-}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Set apps JSON
        id: apps
        run: |
          APPS='["backend", "blockml", "disk", "front", "mcli"]'
          echo "apps_json=$APPS" >> $GITHUB_OUTPUT

  build-amd:
    needs: extract-version
    runs-on: ubuntu-22.04
    strategy:
      max-parallel: 1
      matrix:
        app: ${{ fromJson(needs.extract-version.outputs.apps_json) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push AMD64 image (SHA only)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: setup-docker/${{ matrix.app }}.Dockerfile
          platforms: linux/amd64
          push: true
          cache-from: type=gha,scope=monorepo-docker-cache-amd64
          cache-to: type=gha,mode=max,scope=monorepo-docker-cache-amd64
          tags: |
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}-${{ matrix.app }}:sha-${{ github.sha }}-amd64

  build-arm:
    needs: extract-version
    runs-on: ubuntu-24.04-arm
    strategy:
      max-parallel: 1
      matrix:
        app: ${{ fromJson(needs.extract-version.outputs.apps_json) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx on ARM
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ARM64 image (SHA only)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: setup-docker/${{ matrix.app }}.Dockerfile
          platforms: linux/arm64
          push: true
          cache-from: type=gha,scope=monorepo-docker-cache-arm64
          cache-to: type=gha,mode=max,scope=monorepo-docker-cache-arm64
          tags: |
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}-${{ matrix.app }}:sha-${{ github.sha }}-arm64

  combine:
    needs: [extract-version, build-amd, build-arm]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-platform manifests
        env:
          APPS_JSON: ${{ needs.extract-version.outputs.apps_json }}
          VERSION: ${{ needs.extract-version.outputs.version }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          echo "$APPS_JSON" | jq -r '.[]' | while read app; do
            IMAGE=${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}-${app}

            echo "Resolving digests for $app..."

            # Extract AMD64 digest - fail if not found or multiple/no matches
            AMD64_DIGEST=$(docker buildx imagetools inspect "${IMAGE}:sha-${SHA}-amd64" --raw | \
              jq -r '.manifests[] 
                     | select(.platform.architecture == "amd64" and .platform.os == "linux") 
                     | .digest' | \
              head -n1)

            if [ -z "$AMD64_DIGEST" ]; then
              echo "ERROR: Could not resolve amd64 digest for ${IMAGE}:sha-${SHA}-amd64"
              echo "This usually means the image was not pushed successfully or is corrupted."
              exit 1
            fi

            # Extract ARM64 digest
            ARM64_DIGEST=$(docker buildx imagetools inspect "${IMAGE}:sha-${SHA}-arm64" --raw | \
              jq -r '.manifests[] 
                     | select(.platform.architecture == "arm64" and .platform.os == "linux") 
                     | .digest' | \
              head -n1)

            if [ -z "$ARM64_DIGEST" ]; then
              echo "ERROR: Could not resolve arm64 digest for ${IMAGE}:sha-${SHA}-arm64"
              echo "This usually means the image was not pushed successfully or is corrupted."
              exit 1
            fi

            echo "✓ Resolved digests:"
            echo "   amd64: $AMD64_DIGEST"
            echo "   arm64: $ARM64_DIGEST"

            # Create and push version tag
            echo "Creating multi-arch manifest ${IMAGE}:${VERSION}"
            docker manifest create "${IMAGE}:${VERSION}" \
              "${IMAGE}@${AMD64_DIGEST}" \
              "${IMAGE}@${ARM64_DIGEST}"

            echo "Pushing ${IMAGE}:${VERSION}"
            docker manifest push "${IMAGE}:${VERSION}"

            # Create and push sha tag
            echo "Creating multi-arch manifest ${IMAGE}:sha-${SHA}"
            docker manifest create "${IMAGE}:sha-${SHA}" \
              "${IMAGE}@${AMD64_DIGEST}" \
              "${IMAGE}@${ARM64_DIGEST}"

            echo "Pushing ${IMAGE}:sha-${SHA}"
            docker manifest push "${IMAGE}:sha-${SHA}"

            echo "✓ Successfully created and pushed multi-platform manifests for $app"
            echo ""
          done

      - name: Inspect all final multi-arch images
        env:
          APPS_JSON: ${{ needs.extract-version.outputs.apps_json }}
          VERSION: ${{ needs.extract-version.outputs.version }}
        run: |
          set -euo pipefail

          echo "$APPS_JSON" | jq -r '.[]' | while read app; do
            IMAGE=${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}-${app}
            echo "=== Inspecting multi-arch manifest for $app (${IMAGE}:${VERSION}) ==="
            docker manifest inspect "${IMAGE}:${VERSION}" || echo "Warning: Inspection failed (may require pull permissions)"
            echo ""
          done